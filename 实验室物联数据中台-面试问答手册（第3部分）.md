# å®éªŒå®¤ç‰©è”æ•°æ®ä¸­å° - é¢è¯•é—®ç­”æ‰‹å†Œï¼ˆç¬¬3éƒ¨åˆ†ï¼‰

> åŸºäºä½ çš„é¡¹ç›®ç»éªŒï¼Œé’ˆå¯¹**å®ä¹ ç”Ÿé¢è¯•**çš„å¸¸è§é—®é¢˜
> æœ¬æ–‡æ¡£åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œè¿™æ˜¯ç¬¬ä¸‰éƒ¨åˆ†ï¼š**Kafkaæ¶ˆæ¯é˜Ÿåˆ—ä¸ç³»ç»Ÿè°ƒä¼˜**

---

## ğŸ“š ç›®å½•

- [ä¸ƒã€Kafka æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨](#ä¸ƒkafka-æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨)
- [å…«ã€MySQL ä¼˜åŒ–ï¼ˆå¸¸è§åœºæ™¯ï¼‰](#å…«mysql-ä¼˜åŒ–å¸¸è§åœºæ™¯)
- [ä¹ã€JVM è°ƒä¼˜ï¼ˆåŸºç¡€ç‰ˆï¼‰](#ä¹jvm-è°ƒä¼˜åŸºç¡€ç‰ˆ)

---

## ä¸ƒã€Kafka æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨

### â“ 7.1 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Kafkaï¼Ÿè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**é¡¹ç›®èƒŒæ™¯ï¼š**
- å®éªŒå®¤ä¼ æ„Ÿå™¨æ¯ç§’ä¸ŠæŠ¥100æ¬¡æ•°æ®
- 10ä¸ªå®éªŒå®¤åŒæ—¶ä¸ŠæŠ¥ï¼ŒQPSè¾¾åˆ°1000+
- éœ€è¦åŒæ—¶åšï¼šæ•°æ®æŒä¹…åŒ–ã€å‘Šè­¦æ£€æŸ¥ã€ç»Ÿè®¡è®¡ç®—

**ä¸ä½¿ç”¨ Kafka çš„é—®é¢˜ï¼ˆåŒæ­¥å¤„ç†ï¼‰ï¼š**

```java
// âŒ é—®é¢˜ä»£ç ï¼šåŒæ­¥å¤„ç†ï¼ˆé˜»å¡ï¼‰
@PostMapping("/data/upload")
public Result<Void> uploadData(@RequestBody LabEnvironmentData data) {
    // 1. ä¿å­˜æ•°æ®åº“ï¼ˆ100msï¼‰
    labEnvironmentDataMapper.insert(data);

    // 2. å‘Šè­¦æ£€æŸ¥ï¼ˆ50msï¼‰
    alarmService.checkAlarm(data);

    // 3. æ›´æ–°ç»Ÿè®¡ï¼ˆ50msï¼‰
    statisticsService.updateStats(data);

    // æ€»è€—æ—¶ï¼š200ms
    // QPSä¸Šé™ï¼š5æ¬¡/ç§’ï¼ˆå•çº¿ç¨‹ï¼‰
    // é—®é¢˜ï¼š
    // - æ¥å£å“åº”æ…¢ï¼Œç”¨æˆ·ä½“éªŒå·®
    // - ååé‡ä½ï¼Œæ— æ³•åº”å¯¹é«˜å¹¶å‘
    // - ä»»ä¸€æ­¥éª¤å¤±è´¥ï¼Œæ•´ä¸ªè¯·æ±‚å¤±è´¥

    return Result.success();
}
```

**ä½¿ç”¨ Kafka åï¼ˆå¼‚æ­¥è§£è€¦ï¼‰ï¼š**

```
ä¼ æ„Ÿå™¨ä¸ŠæŠ¥æ•°æ®
    â†“
Monitor Serviceæ¥æ”¶ï¼ˆ5msï¼‰
    â†“
å‘é€åˆ°Kafkaï¼ˆç«‹å³è¿”å›ï¼‰â† æ¥å£å“åº”å¿«
    â†“
Kafkaå­˜å‚¨æ¶ˆæ¯ï¼ˆå‰Šå³°å¡«è°·ï¼‰
    â†“
å¤šä¸ªæ¶ˆè´¹è€…å¹¶å‘å¤„ç†ï¼š
â”œâ”€ æ•°æ®æŒä¹…åŒ–æ¶ˆè´¹è€…ï¼ˆä¿å­˜æ•°æ®åº“ï¼‰
â”œâ”€ å‘Šè­¦æ£€æŸ¥æ¶ˆè´¹è€…ï¼ˆæ£€æŸ¥å‘Šè­¦ï¼‰
â””â”€ ç»Ÿè®¡è®¡ç®—æ¶ˆè´¹è€…ï¼ˆæ›´æ–°ç»Ÿè®¡ï¼‰

ä¼˜åŠ¿ï¼š
âœ… æ¥å£å“åº”ä»200msé™è‡³5msï¼ˆæå‡40å€ï¼‰
âœ… ååé‡ä»5 QPSæå‡è‡³200 QPS
âœ… å‰Šå³°å¡«è°·ï¼šç¬é—´1000ä¸ªè¯·æ±‚ä¹Ÿä¸æ€•
âœ… è§£è€¦ï¼šä»»ä¸€æ¶ˆè´¹è€…æŒ‚äº†ä¸å½±å“å…¶ä»–
```

---

**Kafka è§£å†³çš„ä¸‰å¤§æ ¸å¿ƒé—®é¢˜ï¼š**

**1. å¼‚æ­¥è§£è€¦**
```
åŸæ¥ï¼š
ä¸ŠæŠ¥æ•°æ® â†’ ä¿å­˜DB â†’ å‘Šè­¦ â†’ ç»Ÿè®¡ï¼ˆä¸²è¡Œï¼Œæ…¢ï¼‰

ç°åœ¨ï¼š
ä¸ŠæŠ¥æ•°æ® â†’ Kafkaï¼ˆå¿«ï¼‰
         â†“
     â”Œâ”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
   ä¿å­˜DB  å‘Šè­¦  ç»Ÿè®¡ï¼ˆå¹¶è¡Œï¼Œå¿«ï¼‰
```

**2. å‰Šå³°å¡«è°·**
```
æ²¡æœ‰Kafkaï¼š
é«˜å³°æœŸ1000 QPS â†’ æ•°æ®åº“ç›´æ¥å´©æºƒ âŒ

æœ‰Kafkaï¼š
é«˜å³°æœŸ1000 QPS â†’ Kafkaç¼“å†² â†’ æ¶ˆè´¹è€…æ…¢æ…¢å¤„ç†ï¼ˆ100 QPSï¼‰âœ…
```

**3. æé«˜ç³»ç»Ÿå¯ç”¨æ€§**
```
æ²¡æœ‰Kafkaï¼š
å‘Šè­¦æœåŠ¡æŒ‚äº† â†’ æ•´ä¸ªæ•°æ®ä¸ŠæŠ¥å¤±è´¥ âŒ

æœ‰Kafkaï¼š
å‘Šè­¦æœåŠ¡æŒ‚äº† â†’ æ¶ˆæ¯åœ¨Kafkaä¸­ â†’ æ¢å¤åç»§ç»­æ¶ˆè´¹ âœ…
```

---

**é¢è¯•å›ç­”æ€»ç»“ï¼š**

> "æˆ‘ä»¬é¡¹ç›®ä¸­ï¼Œå®éªŒå®¤ä¼ æ„Ÿå™¨æ¯ç§’ä¸ŠæŠ¥100æ¬¡æ•°æ®ï¼Œå¦‚æœåŒæ­¥å¤„ç†ï¼Œéœ€è¦ä¿å­˜æ•°æ®åº“ã€å‘Šè­¦æ£€æŸ¥ã€ç»Ÿè®¡è®¡ç®—ï¼Œæ€»è€—æ—¶200msï¼ŒQPSåªæœ‰5ã€‚
>
> å¼•å…¥Kafkaåï¼Œæ¥å£åªéœ€è¦å‘é€æ¶ˆæ¯åˆ°Kafkaï¼Œ5mså†…è¿”å›ï¼ŒQPSæå‡åˆ°200ã€‚Kafkaèµ·åˆ°äº†**å¼‚æ­¥è§£è€¦ã€å‰Šå³°å¡«è°·**çš„ä½œç”¨ã€‚
>
> å…·ä½“æ¥è¯´ï¼š
> - **å¼‚æ­¥è§£è€¦**ï¼šæ•°æ®æŒä¹…åŒ–ã€å‘Šè­¦ã€ç»Ÿè®¡ä¸‰ä¸ªæ¶ˆè´¹è€…ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å½±å“
> - **å‰Šå³°å¡«è°·**ï¼šç¬é—´1000ä¸ªè¯·æ±‚ï¼ŒKafkaå…ˆç¼“å†²ï¼Œæ¶ˆè´¹è€…æ…¢æ…¢å¤„ç†
> - **æé«˜å¯ç”¨æ€§**ï¼šæŸä¸ªæ¶ˆè´¹è€…æŒ‚äº†ï¼Œæ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œæ¢å¤åç»§ç»­æ¶ˆè´¹
>
> æœ€ç»ˆæ•ˆæœï¼šæ¥å£å“åº”ä»200msé™è‡³5msï¼Œç³»ç»Ÿååé‡æå‡40å€ã€‚"

---

### â“ 7.2 Kafka çš„åŸºæœ¬æ¦‚å¿µï¼ˆTopicã€Partitionã€Consumer Groupï¼‰ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**æ ¸å¿ƒæ¦‚å¿µå›¾ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kafka Cluster                           â”‚
â”‚                                                            â”‚
â”‚  Topic: lab-environment-data                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Partition 0:  [æ¶ˆæ¯1] [æ¶ˆæ¯2] [æ¶ˆæ¯3] ...          â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Partition 1:  [æ¶ˆæ¯4] [æ¶ˆæ¯5] [æ¶ˆæ¯6] ...          â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Partition 2:  [æ¶ˆæ¯7] [æ¶ˆæ¯8] [æ¶ˆæ¯9] ...          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Consumer Group 1  â”‚  â”‚ Consumer Group 2  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚  â”‚Consumer 1â”‚     â”‚  â”‚  â”‚Consumer 1â”‚     â”‚
        â”‚  â”‚(P0, P1)  â”‚     â”‚  â”‚  â”‚(P0, P1, P2)â”‚   â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚                   â”‚
        â”‚  â”‚Consumer 2â”‚     â”‚  â”‚ æ•°æ®æŒä¹…åŒ–+å‘Šè­¦    â”‚
        â”‚  â”‚(P2)      â”‚     â”‚  â”‚                   â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚                   â”‚
        â”‚                   â”‚  â”‚                   â”‚
        â”‚ æ•°æ®æŒä¹…åŒ–        â”‚  â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**1. Topicï¼ˆä¸»é¢˜ï¼‰**

**å®šä¹‰ï¼š** æ¶ˆæ¯çš„åˆ†ç±»ï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„è¡¨

**æˆ‘ä»¬é¡¹ç›®çš„ Topicï¼š**
```
lab-environment-data    # å®éªŒå®¤ç¯å¢ƒæ•°æ®
lab-alarm              # å®éªŒå®¤å‘Šè­¦
lab-statistics         # å®éªŒå®¤ç»Ÿè®¡
```

**åˆ›å»º Topicï¼š**
```bash
# åˆ›å»ºTopicï¼ˆ3ä¸ªåˆ†åŒºï¼Œ1ä¸ªå‰¯æœ¬ï¼‰
kafka-topics.sh --create \
  --bootstrap-server localhost:9092 \
  --topic lab-environment-data \
  --partitions 3 \
  --replication-factor 1
```

---

**2. Partitionï¼ˆåˆ†åŒºï¼‰**

**å®šä¹‰ï¼š** Topicçš„ç‰©ç†åˆ†ç»„ï¼Œç”¨äºå¹¶è¡Œå¤„ç†

**ä¸ºä»€ä¹ˆè¦åˆ†åŒºï¼Ÿ**
- **å¹¶è¡Œå¤„ç†**ï¼š3ä¸ªåˆ†åŒº = æœ€å¤š3ä¸ªæ¶ˆè´¹è€…å¹¶å‘æ¶ˆè´¹
- **è´Ÿè½½å‡è¡¡**ï¼šæ¶ˆæ¯åˆ†æ•£åˆ°å¤šä¸ªåˆ†åŒº
- **æé«˜ååé‡**ï¼šå•ä¸ªåˆ†åŒºååé‡æœ‰é™ï¼Œå¤šåˆ†åŒºæå‡æ•´ä½“ååé‡

**åˆ†åŒºç­–ç•¥ï¼ˆæˆ‘ä»¬é¡¹ç›®ä½¿ç”¨ï¼‰ï¼š**
```java
// ç”Ÿäº§è€…é…ç½®ï¼šæŒ‰å®éªŒå®¤IDåˆ†åŒº
@Bean
public ProducerFactory<String, String> producerFactory() {
    Map<String, Object> config = new HashMap<>();
    config.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
    config.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
    config.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);

    // åˆ†åŒºç­–ç•¥ï¼šç›¸åŒkeyçš„æ¶ˆæ¯è¿›å…¥åŒä¸€åˆ†åŒºï¼ˆä¿è¯é¡ºåºï¼‰
    config.put(ProducerConfig.PARTITIONER_CLASS_CONFIG, DefaultPartitioner.class);

    return new DefaultKafkaProducerFactory<>(config);
}

// å‘é€æ¶ˆæ¯æ—¶æŒ‡å®škeyï¼ˆå®éªŒå®¤IDï¼‰
kafkaTemplate.send("lab-environment-data", labId.toString(), message);
// å®éªŒå®¤1çš„æ•°æ®æ°¸è¿œè¿›å…¥åŒä¸€åˆ†åŒºï¼Œä¿è¯é¡ºåº
```

---

**3. Consumer Groupï¼ˆæ¶ˆè´¹è€…ç»„ï¼‰**

**å®šä¹‰ï¼š** å¤šä¸ªæ¶ˆè´¹è€…ç»„æˆä¸€ä¸ªç»„ï¼Œå…±åŒæ¶ˆè´¹Topic

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- **åŒä¸€ç»„å†…çš„æ¶ˆè´¹è€…ä¸ä¼šé‡å¤æ¶ˆè´¹**ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
- **ä¸åŒç»„çš„æ¶ˆè´¹è€…ç‹¬ç«‹æ¶ˆè´¹**ï¼ˆå‘å¸ƒ-è®¢é˜…ï¼‰

**æˆ‘ä»¬é¡¹ç›®çš„æ¶ˆè´¹è€…ç»„ï¼š**
```
Topic: lab-environment-data

Consumer Group 1ï¼ˆæ•°æ®æŒä¹…åŒ–ï¼‰:
â”œâ”€ Consumer 1 â†’ æ¶ˆè´¹ Partition 0, 1
â””â”€ Consumer 2 â†’ æ¶ˆè´¹ Partition 2

Consumer Group 2ï¼ˆå‘Šè­¦æ£€æŸ¥ï¼‰:
â””â”€ Consumer 1 â†’ æ¶ˆè´¹ Partition 0, 1, 2

Consumer Group 3ï¼ˆç»Ÿè®¡è®¡ç®—ï¼‰:
â””â”€ Consumer 1 â†’ æ¶ˆè´¹ Partition 0, 1, 2

åŒä¸€æ¡æ¶ˆæ¯ï¼š
- åœ¨Group 1ä¸­åªè¢«æ¶ˆè´¹1æ¬¡ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
- åœ¨Group 2ä¸­æ¶ˆè´¹1æ¬¡
- åœ¨Group 3ä¸­æ¶ˆè´¹1æ¬¡
```

**é…ç½®ç¤ºä¾‹ï¼š**
```java
// æ•°æ®æŒä¹…åŒ–æ¶ˆè´¹è€…
@KafkaListener(
    topics = "lab-environment-data",
    groupId = "lab-data-consumer-group",  // æ¶ˆè´¹è€…ç»„1
    concurrency = "3"  // 3ä¸ªå¹¶å‘æ¶ˆè´¹è€…ï¼ˆå¯¹åº”3ä¸ªåˆ†åŒºï¼‰
)
public void consumeData(String message) {
    // ä¿å­˜æ•°æ®åº“
}

// å‘Šè­¦æ£€æŸ¥æ¶ˆè´¹è€…
@KafkaListener(
    topics = "lab-environment-data",
    groupId = "lab-alarm-consumer-group",  // æ¶ˆè´¹è€…ç»„2
    concurrency = "2"
)
public void consumeAlarm(String message) {
    // å‘Šè­¦æ£€æŸ¥
}
```

---

**é¢è¯•å›ç­”æ€»ç»“ï¼š**

> "Kafkaæœ‰ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š
>
> **1. Topicï¼ˆä¸»é¢˜ï¼‰**ï¼šæ¶ˆæ¯çš„åˆ†ç±»ï¼Œæˆ‘ä»¬é¡¹ç›®æœ‰lab-environment-dataã€lab-alarmç­‰Topicã€‚
>
> **2. Partitionï¼ˆåˆ†åŒºï¼‰**ï¼šTopicçš„ç‰©ç†åˆ†ç»„ï¼Œç”¨äºå¹¶è¡Œå¤„ç†ã€‚æˆ‘ä»¬çš„Topicæœ‰3ä¸ªåˆ†åŒºï¼Œå¯ä»¥æœ‰3ä¸ªæ¶ˆè´¹è€…å¹¶å‘æ¶ˆè´¹ï¼Œæé«˜ååé‡ã€‚å‘é€æ¶ˆæ¯æ—¶æˆ‘ä»¬ç”¨å®éªŒå®¤IDä½œä¸ºkeyï¼Œç›¸åŒå®éªŒå®¤çš„æ•°æ®ä¼šè¿›å…¥åŒä¸€åˆ†åŒºï¼Œä¿è¯é¡ºåºã€‚
>
> **3. Consumer Groupï¼ˆæ¶ˆè´¹è€…ç»„ï¼‰**ï¼šå¤šä¸ªæ¶ˆè´¹è€…ç»„æˆä¸€ä¸ªç»„ã€‚åŒä¸€ç»„å†…çš„æ¶ˆè´¹è€…ä¸ä¼šé‡å¤æ¶ˆè´¹ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ï¼Œä¸åŒç»„ç‹¬ç«‹æ¶ˆè´¹ï¼ˆå‘å¸ƒ-è®¢é˜…ï¼‰ã€‚æˆ‘ä»¬æœ‰3ä¸ªæ¶ˆè´¹è€…ç»„ï¼šæ•°æ®æŒä¹…åŒ–ã€å‘Šè­¦æ£€æŸ¥ã€ç»Ÿè®¡è®¡ç®—ï¼Œäº’ä¸å½±å“ã€‚"

---

### â“ 7.3 åœ¨ä½ çš„é¡¹ç›®ä¸­ï¼ŒKafka æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**å®Œæ•´çš„æ•°æ®æµç¨‹ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼ æ„Ÿå™¨ä¸ŠæŠ¥æ•°æ® â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Monitor Service - REST API                             â”‚
â”‚                                                        â”‚
â”‚ @PostMapping("/data/upload")                           â”‚
â”‚ public Result<Void> uploadData(LabEnvironmentData) {  â”‚
â”‚   // 1. ç®€å•æ ¡éªŒ                                        â”‚
â”‚   // 2. å‘é€åˆ°Kafka                                    â”‚
â”‚   kafkaTemplate.send("lab-environment-data", data);    â”‚
â”‚   return Result.success();  // 5mså†…è¿”å›                â”‚
â”‚ }                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kafka - Topic: lab-environment-data                    â”‚
â”‚  Partition 0: [æ¶ˆæ¯...] (å®éªŒå®¤1, 3, 5...)            â”‚
â”‚  Partition 1: [æ¶ˆæ¯...] (å®éªŒå®¤2, 4, 6...)            â”‚
â”‚  Partition 2: [æ¶ˆæ¯...] (å®éªŒå®¤7, 8, 9...)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“              â†“              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¶ˆè´¹è€…1:         â”‚ â”‚ æ¶ˆè´¹è€…2:         â”‚ â”‚ æ¶ˆè´¹è€…3:         â”‚
â”‚ æ•°æ®æŒä¹…åŒ–       â”‚ â”‚ å‘Šè­¦æ£€æŸ¥         â”‚ â”‚ ç»Ÿè®¡è®¡ç®—         â”‚
â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚
â”‚ â†“ ä¿å­˜æ•°æ®åº“     â”‚ â”‚ â†“ æ£€æŸ¥é˜ˆå€¼       â”‚ â”‚ â†“ æ›´æ–°Redis      â”‚
â”‚ â†“ æ›´æ–°Redisç¼“å­˜  â”‚ â”‚ â†“ å‘é€å‘Šè­¦       â”‚ â”‚ â†“ å®šæ—¶ç»Ÿè®¡       â”‚
â”‚ â†“ WebSocketæ¨é€  â”‚ â”‚ â†“ WebSocketæ¨é€  â”‚ â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**1. ç”Ÿäº§è€…ï¼ˆProducerï¼‰- æ•°æ®ä¸ŠæŠ¥**

```java
// monitor-service/src/main/java/com/sewage/monitor/kafka/producer/LabEnvironmentProducer.java
@Component
@RequiredArgsConstructor
@Slf4j
public class LabEnvironmentProducer {

    private final KafkaTemplate<String, String> kafkaTemplate;

    /**
     * å‘é€ç¯å¢ƒæ•°æ®åˆ°Kafka
     *
     * @param data ç¯å¢ƒæ•°æ®
     */
    public void sendData(LabEnvironmentData data) {
        String topic = "lab-environment-data";
        String key = data.getLabId().toString();  // å®éªŒå®¤IDä½œä¸ºkeyï¼ˆä¿è¯åŒä¸€å®éªŒå®¤æ•°æ®æœ‰åºï¼‰
        String message = JSON.toJSONString(data);

        // å‘é€æ¶ˆæ¯
        kafkaTemplate.send(topic, key, message)
            .addCallback(
                result -> log.info("âœ… Kafkaå‘é€æˆåŠŸ - Topic: {}, Key: {}", topic, key),
                ex -> log.error("âŒ Kafkaå‘é€å¤±è´¥ - Topic: {}, Key: {}", topic, key, ex)
            );
    }
}
```

**è°ƒç”¨ä½ç½®ï¼š**
```java
// Controllerå±‚è°ƒç”¨
@PostMapping("/data/upload")
public Result<Void> uploadData(@RequestBody LabEnvironmentData data) {
    // å‘é€åˆ°Kafkaï¼ˆå¼‚æ­¥ï¼‰
    labEnvironmentProducer.sendData(data);

    // ç«‹å³è¿”å›
    return Result.success();
}
```

---

**2. æ¶ˆè´¹è€…1ï¼ˆConsumerï¼‰- æ•°æ®æŒä¹…åŒ–**

```java
// monitor-service/src/main/java/com/sewage/monitor/kafka/consumer/LabEnvironmentDataConsumer.java
@Component
@RequiredArgsConstructor
@Slf4j
public class LabEnvironmentDataConsumer {

    private final LabEnvironmentDataService labEnvironmentDataService;

    /**
     * æ¶ˆè´¹ç¯å¢ƒæ•°æ®
     */
    @KafkaListener(
        topics = "lab-environment-data",
        groupId = "lab-data-consumer-group",  // æ¶ˆè´¹è€…ç»„
        concurrency = "3"  // 3ä¸ªå¹¶å‘æ¶ˆè´¹è€…
    )
    public void consume(ConsumerRecord<String, String> record) {
        try {
            log.info("ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ - Partition: {}, Offset: {}",
                record.partition(), record.offset());

            // 1. è§£ææ¶ˆæ¯
            LabEnvironmentData data = JSON.parseObject(
                record.value(),
                LabEnvironmentData.class
            );

            // 2. ä¿å­˜æ•°æ®åº“
            labEnvironmentDataService.saveMonitorData(data);

            log.info("âœ… æ¶ˆæ¯å¤„ç†æˆåŠŸ - å®éªŒå®¤: {}", data.getLabName());

        } catch (Exception e) {
            log.error("âŒ æ¶ˆæ¯å¤„ç†å¤±è´¥", e);
            // å®é™…é¡¹ç›®ä¸­å¯ä»¥å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
        }
    }
}
```

---

**3. æ¶ˆè´¹è€…2 - å‘Šè­¦æ£€æŸ¥**

```java
// monitor-service/src/main/java/com/sewage/monitor/kafka/consumer/LabAlarmConsumer.java
@Component
@RequiredArgsConstructor
@Slf4j
public class LabAlarmConsumer {

    private final AlarmService alarmService;

    @KafkaListener(
        topics = "lab-environment-data",
        groupId = "lab-alarm-consumer-group",  // ä¸åŒçš„æ¶ˆè´¹è€…ç»„
        concurrency = "2"
    )
    public void consume(ConsumerRecord<String, String> record) {
        LabEnvironmentData data = JSON.parseObject(record.value(), LabEnvironmentData.class);

        // å‘Šè­¦æ£€æŸ¥
        alarmService.checkAndSendAlarm(data);

        log.info("ğŸš¨ å‘Šè­¦æ£€æŸ¥å®Œæˆ - å®éªŒå®¤: {}", data.getLabName());
    }
}
```

---

**4. Kafkaé…ç½®**

```yaml
# application.yml
spring:
  kafka:
    bootstrap-servers: localhost:9092

    # ç”Ÿäº§è€…é…ç½®
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
      acks: 1  # Leaderç¡®è®¤å³å¯ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
      retries: 3  # å¤±è´¥é‡è¯•3æ¬¡

    # æ¶ˆè´¹è€…é…ç½®
    consumer:
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      auto-offset-reset: latest  # ä»æœ€æ–°æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹
      enable-auto-commit: true  # è‡ªåŠ¨æäº¤offset
      auto-commit-interval: 1000  # 1ç§’æäº¤ä¸€æ¬¡
```

---

**é¢è¯•å›ç­”æ€»ç»“ï¼š**

> "æˆ‘ä»¬é¡¹ç›®ä¸­ï¼ŒKafkaä¸»è¦ç”¨äº**å®éªŒå®¤ç¯å¢ƒæ•°æ®çš„å¼‚æ­¥å¤„ç†**ã€‚
>
> **æ•°æ®æµç¨‹ï¼š**
> 1. ä¼ æ„Ÿå™¨ä¸ŠæŠ¥æ•°æ®åˆ°REST API
> 2. æ¥å£æ¥æ”¶åç«‹å³å‘é€åˆ°Kafkaçš„lab-environment-data Topicï¼ˆ5msè¿”å›ï¼‰
> 3. ä¸‰ä¸ªæ¶ˆè´¹è€…ç»„ç‹¬ç«‹æ¶ˆè´¹ï¼š
>    - æ•°æ®æŒä¹…åŒ–ç»„ï¼šä¿å­˜æ•°æ®åº“ã€æ›´æ–°Redisç¼“å­˜ã€WebSocketæ¨é€
>    - å‘Šè­¦æ£€æŸ¥ç»„ï¼šæ£€æŸ¥é˜ˆå€¼ã€å‘é€å‘Šè­¦
>    - ç»Ÿè®¡è®¡ç®—ç»„ï¼šæ›´æ–°å®æ—¶ç»Ÿè®¡
>
> **å…³é”®é…ç½®ï¼š**
> - Topicæœ‰3ä¸ªåˆ†åŒºï¼Œæ”¯æŒ3ä¸ªæ¶ˆè´¹è€…å¹¶å‘
> - å‘é€æ¶ˆæ¯æ—¶ç”¨å®éªŒå®¤IDä½œä¸ºkeyï¼Œä¿è¯åŒä¸€å®éªŒå®¤æ•°æ®æœ‰åº
> - æ¶ˆè´¹è€…concurrency=3ï¼Œå……åˆ†åˆ©ç”¨åˆ†åŒºå¹¶è¡Œ
>
> **æ•ˆæœï¼š**
> - æ¥å£å“åº”ä»200msé™è‡³5ms
> - ååé‡ä»5 QPSæå‡è‡³200 QPS
> - å„æ¨¡å—è§£è€¦ï¼Œäº’ä¸å½±å“"

---

### â“ 7.4 Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼ˆç®€åŒ–ç‰ˆï¼Œé€‚åˆå®ä¹ ç”Ÿï¼‰ï¼š**

**æ¶ˆæ¯ä¸¢å¤±çš„ä¸‰ä¸ªç¯èŠ‚ï¼š**

```
ç”Ÿäº§è€… â”€â”€â”€â”€â”€â–º Kafka Broker â”€â”€â”€â”€â”€â–º æ¶ˆè´¹è€…
   â†“              â†“                â†“
å¯èƒ½ä¸¢å¤±1      å¯èƒ½ä¸¢å¤±2         å¯èƒ½ä¸¢å¤±3
```

---

**1. ç”Ÿäº§è€…ç«¯ - ç¡®è®¤æœºåˆ¶ï¼ˆacksï¼‰**

```yaml
# application.yml
spring:
  kafka:
    producer:
      acks: 1  # ç¡®è®¤çº§åˆ«
      retries: 3  # å¤±è´¥é‡è¯•
```

**ackså‚æ•°ï¼š**
- `acks=0`ï¼šä¸ç­‰å¾…ç¡®è®¤ï¼ˆæœ€å¿«ï¼Œä½†å¯èƒ½ä¸¢å¤±ï¼‰âŒ
- `acks=1`ï¼šLeaderç¡®è®¤ï¼ˆæ€§èƒ½å¥½ï¼Œä¸€èˆ¬ä¸ä¸¢ï¼‰âœ… **æˆ‘ä»¬é¡¹ç›®ä½¿ç”¨**
- `acks=all`ï¼šæ‰€æœ‰å‰¯æœ¬ç¡®è®¤ï¼ˆæœ€å®‰å…¨ï¼Œä½†æ…¢ï¼‰

**æˆ‘ä»¬é¡¹ç›®é€‰æ‹© acks=1 çš„åŸå› ï¼š**
- ä¼ æ„Ÿå™¨æ•°æ®ä¸¢å¤±å‡ æ¡å½±å“ä¸å¤§ï¼ˆå¯ä»¥æ¥å—ï¼‰
- æ€§èƒ½ä¼˜å…ˆï¼Œä¿è¯é«˜ååé‡

---

**2. Brokerç«¯ - å‰¯æœ¬æœºåˆ¶ï¼ˆReplicationï¼‰**

```bash
# åˆ›å»ºTopicæ—¶è®¾ç½®å‰¯æœ¬æ•°
kafka-topics.sh --create \
  --topic lab-environment-data \
  --partitions 3 \
  --replication-factor 1  # æˆ‘ä»¬é¡¹ç›®è®¾ç½®1ï¼ˆå•æœºï¼‰
```

**å‰¯æœ¬æœºåˆ¶ï¼š**
- `replication-factor=1`ï¼šæ— å‰¯æœ¬ï¼ˆå•æœºï¼Œå¯èƒ½ä¸¢å¤±ï¼‰
- `replication-factor=2`ï¼š1ä¸ªLeader + 1ä¸ªFollowerï¼ˆæ¨èï¼‰
- `replication-factor=3`ï¼š1ä¸ªLeader + 2ä¸ªFollowerï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**æˆ‘ä»¬é¡¹ç›®è®¾ç½®1çš„åŸå› ï¼š**
- å¼€å‘ç¯å¢ƒï¼Œå•æœºéƒ¨ç½²
- ç”Ÿäº§ç¯å¢ƒåº”è¯¥è®¾ç½®â‰¥2

---

**3. æ¶ˆè´¹è€…ç«¯ - æ‰‹åŠ¨æäº¤offset**

```java
// è‡ªåŠ¨æäº¤ï¼ˆå¯èƒ½ä¸¢å¤±ï¼‰
@KafkaListener(topics = "lab-environment-data")
public void consume(String message) {
    saveToDatabase(message);  // å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œoffsetå·²ç»è‡ªåŠ¨æäº¤äº†
}

// æ‰‹åŠ¨æäº¤ï¼ˆæ›´å®‰å…¨ï¼‰- æˆ‘ä»¬é¡¹ç›®æš‚æ—¶ç”¨è‡ªåŠ¨æäº¤
@KafkaListener(topics = "lab-environment-data")
public void consume(ConsumerRecord<String, String> record, Acknowledgment ack) {
    try {
        saveToDatabase(record.value());
        ack.acknowledge();  // æ‰‹åŠ¨æäº¤offsetï¼ˆæˆåŠŸåæ‰æäº¤ï¼‰
    } catch (Exception e) {
        // ä¸æäº¤offsetï¼Œä¸‹æ¬¡é‡æ–°æ¶ˆè´¹
        log.error("å¤„ç†å¤±è´¥ï¼Œä¸æäº¤offset", e);
    }
}
```

**é…ç½®ï¼š**
```yaml
spring:
  kafka:
    consumer:
      enable-auto-commit: true  # è‡ªåŠ¨æäº¤ï¼ˆç®€å•ï¼‰
      # enable-auto-commit: false  # æ‰‹åŠ¨æäº¤ï¼ˆæ›´å®‰å…¨ï¼‰
```

---

**é¢è¯•å›ç­”æ€»ç»“ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š**

> "Kafkaé€šè¿‡ä¸‰ä¸ªå±‚é¢ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼š
>
> **1. ç”Ÿäº§è€…ç«¯**ï¼šè®¾ç½®acks=1ï¼Œç­‰å¾…Leaderç¡®è®¤åæ‰è¿”å›ã€‚å¤±è´¥æ—¶é‡è¯•3æ¬¡ã€‚
>
> **2. Brokerç«¯**ï¼šè®¾ç½®å‰¯æœ¬replication-factorâ‰¥2ï¼Œæ•°æ®å­˜å‚¨åœ¨å¤šä¸ªèŠ‚ç‚¹ã€‚
>
> **3. æ¶ˆè´¹è€…ç«¯**ï¼šå¯ä»¥ä½¿ç”¨æ‰‹åŠ¨æäº¤offsetï¼Œç¡®ä¿æ¶ˆæ¯å¤„ç†æˆåŠŸåå†æäº¤ã€‚
>
> æˆ‘ä»¬é¡¹ç›®ä¸­ï¼Œç”±äºæ˜¯å®éªŒå®¤ç›‘æµ‹æ•°æ®ï¼Œå¶å°”ä¸¢å¤±å‡ æ¡æ•°æ®å½±å“ä¸å¤§ï¼Œæ‰€ä»¥é€‰æ‹©äº†acks=1ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰ï¼Œåœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨å•å‰¯æœ¬ã€‚å¦‚æœæ˜¯é‡‘èã€æ”¯ä»˜ç­‰å¯¹æ•°æ®å®Œæ•´æ€§è¦æ±‚é«˜çš„åœºæ™¯ï¼Œéœ€è¦è®¾ç½®acks=allå’Œå¤šå‰¯æœ¬ã€‚"

---

## å…«ã€MySQL ä¼˜åŒ–ï¼ˆå¸¸è§åœºæ™¯ï¼‰

### â“ 8.1 é‡åˆ°æ…¢SQLå¦‚ä½•ä¼˜åŒ–ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**æ’æŸ¥æ­¥éª¤ï¼š**

**1. ä½¿ç”¨ EXPLAIN åˆ†ææ‰§è¡Œè®¡åˆ’**

```sql
-- æ…¢SQLç¤ºä¾‹
EXPLAIN SELECT * FROM lab_environment_data
WHERE lab_id = 1 AND monitor_time >= '2025-11-01'
ORDER BY monitor_time DESC
LIMIT 10;

-- æŸ¥çœ‹ç»“æœï¼š
+----+-------------+----------------------+------+---------------+------+
| id | select_type | table                | type | key           | rows |
+----+-------------+----------------------+------+---------------+------+
|  1 | SIMPLE      | lab_environment_data | ALL  | NULL          | 1000000 |
+----+-------------+----------------------+------+---------------+------+

å…³é”®å­—æ®µï¼š
- type: ALLï¼ˆå…¨è¡¨æ‰«æï¼Œæœ€æ…¢ï¼‰âŒ
- key: NULLï¼ˆæ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼‰âŒ
- rows: 1000000ï¼ˆæ‰«æ100ä¸‡è¡Œï¼‰âŒ
```

**typeå­—æ®µè¯´æ˜ï¼ˆä»å¿«åˆ°æ…¢ï¼‰ï¼š**
```
system > const > eq_ref > ref > range > index > ALL
  â†‘                                                â†“
æœ€å¿«                                              æœ€æ…¢
```

---

**2. æ·»åŠ ç´¢å¼•ä¼˜åŒ–**

```sql
-- åˆ›å»ºè”åˆç´¢å¼•
CREATE INDEX idx_lab_time ON lab_environment_data(lab_id, monitor_time);

-- å†æ¬¡EXPLAIN
EXPLAIN SELECT * FROM lab_environment_data
WHERE lab_id = 1 AND monitor_time >= '2025-11-01'
ORDER BY monitor_time DESC
LIMIT 10;

-- ä¼˜åŒ–åï¼š
+----+-------------+----------------------+-------+---------------+----------+
| id | select_type | table                | type  | key           | rows     |
+----+-------------+----------------------+-------+---------------+----------+
|  1 | SIMPLE      | lab_environment_data | range | idx_lab_time  | 100      |
+----+-------------+----------------------+-------+---------------+----------+

æ”¹è¿›ï¼š
- type: rangeï¼ˆèŒƒå›´æ‰«æï¼‰âœ…
- key: idx_lab_timeï¼ˆä½¿ç”¨äº†ç´¢å¼•ï¼‰âœ…
- rows: 100ï¼ˆåªæ‰«æ100è¡Œï¼‰âœ…
```

**æ•ˆæœï¼š**
- ä¼˜åŒ–å‰ï¼šå…¨è¡¨æ‰«æ100ä¸‡è¡Œï¼Œè€—æ—¶3ç§’
- ä¼˜åŒ–åï¼šç´¢å¼•æ‰«æ100è¡Œï¼Œè€—æ—¶0.01ç§’

---

**3. é¿å…ç´¢å¼•å¤±æ•ˆ**

**å¸¸è§ç´¢å¼•å¤±æ•ˆåœºæ™¯ï¼š**

```sql
-- âŒ é”™è¯¯1ï¼šä½¿ç”¨å‡½æ•°
SELECT * FROM lab_environment_data
WHERE DATE(monitor_time) = '2025-11-01';  -- ç´¢å¼•å¤±æ•ˆ

-- âœ… æ­£ç¡®ï¼šèŒƒå›´æŸ¥è¯¢
SELECT * FROM lab_environment_data
WHERE monitor_time >= '2025-11-01' AND monitor_time < '2025-11-02';

-- âŒ é”™è¯¯2ï¼šéšå¼ç±»å‹è½¬æ¢
SELECT * FROM lab_environment_data
WHERE lab_id = '1';  -- lab_idæ˜¯INTï¼Œä¼ å…¥å­—ç¬¦ä¸²'1'ï¼Œç´¢å¼•å¤±æ•ˆ

-- âœ… æ­£ç¡®ï¼šç±»å‹åŒ¹é…
SELECT * FROM lab_environment_data
WHERE lab_id = 1;

-- âŒ é”™è¯¯3ï¼šLIKE å·¦æ¨¡ç³Š
SELECT * FROM laboratory
WHERE lab_name LIKE '%å®éªŒå®¤';  -- ç´¢å¼•å¤±æ•ˆ

-- âœ… æ­£ç¡®ï¼šå³æ¨¡ç³Š
SELECT * FROM laboratory
WHERE lab_name LIKE 'å®éªŒå®¤%';
```

---

**4. é¿å… SELECT ***

```sql
-- âŒ é”™è¯¯ï¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µ
SELECT * FROM lab_environment_data WHERE lab_id = 1;
-- é—®é¢˜ï¼šä¼ è¾“å¤§é‡æ— ç”¨æ•°æ®ï¼Œæµªè´¹å¸¦å®½

-- âœ… æ­£ç¡®ï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
SELECT id, temperature, humidity, pm25, monitor_time
FROM lab_environment_data
WHERE lab_id = 1;
```

---

**é¢è¯•å›ç­”æ€»ç»“ï¼š**

> "é‡åˆ°æ…¢SQLï¼Œæˆ‘ä¼šè¿™æ ·ä¼˜åŒ–ï¼š
>
> **1. ä½¿ç”¨EXPLAINåˆ†ææ‰§è¡Œè®¡åˆ’**
> - æŸ¥çœ‹typeå­—æ®µï¼Œå¦‚æœæ˜¯ALLï¼ˆå…¨è¡¨æ‰«æï¼‰ï¼Œè¯´æ˜æ²¡æœ‰ä½¿ç”¨ç´¢å¼•
> - æŸ¥çœ‹rowså­—æ®µï¼Œçœ‹æ‰«æäº†å¤šå°‘è¡Œ
>
> **2. æ·»åŠ åˆé€‚çš„ç´¢å¼•**
> - æ ¹æ®WHEREæ¡ä»¶åˆ›å»ºç´¢å¼•
> - å¤šä¸ªæ¡ä»¶ç”¨è”åˆç´¢å¼•
> - æˆ‘ä»¬é¡¹ç›®åœ¨lab_environment_dataè¡¨åˆ›å»ºäº†(lab_id, monitor_time)è”åˆç´¢å¼•
>
> **3. é¿å…ç´¢å¼•å¤±æ•ˆ**
> - ä¸åœ¨WHEREæ¡ä»¶ä¸­ä½¿ç”¨å‡½æ•°
> - é¿å…éšå¼ç±»å‹è½¬æ¢
> - LIKEæŸ¥è¯¢ä½¿ç”¨å³æ¨¡ç³Š
>
> **4. åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ**
> - é¿å…SELECT *
>
> ä¼˜åŒ–æ•ˆæœï¼šæŸ¥è¯¢æ—¶é—´ä»3ç§’é™è‡³0.01ç§’ã€‚"

---

### â“ 8.2 ç´¢å¼•ä»€ä¹ˆæ—¶å€™ä¼šå¤±æ•ˆï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**å¸¸è§çš„ç´¢å¼•å¤±æ•ˆåœºæ™¯ï¼ˆ6ç§ï¼‰ï¼š**

**1. ä½¿ç”¨å‡½æ•°æˆ–è®¡ç®—**
```sql
-- å‡è®¾æœ‰ç´¢å¼•ï¼šINDEX idx_time(monitor_time)

-- âŒ å¤±æ•ˆï¼šåœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°
SELECT * FROM lab_environment_data
WHERE DATE(monitor_time) = '2025-11-01';

SELECT * FROM lab_environment_data
WHERE YEAR(monitor_time) = 2025;

-- âœ… ç”Ÿæ•ˆï¼šä¸ä½¿ç”¨å‡½æ•°
SELECT * FROM lab_environment_data
WHERE monitor_time >= '2025-11-01' AND monitor_time < '2025-11-02';
```

---

**2. éšå¼ç±»å‹è½¬æ¢**
```sql
-- å‡è®¾ï¼šlab_idæ˜¯INTç±»å‹ï¼Œæœ‰ç´¢å¼•

-- âŒ å¤±æ•ˆï¼šä¼ å…¥å­—ç¬¦ä¸²
SELECT * FROM lab_environment_data WHERE lab_id = '1';
-- MySQLä¼šè½¬æ¢ä¸ºï¼šWHERE CAST(lab_id AS CHAR) = '1'ï¼Œç´¢å¼•å¤±æ•ˆ

-- âœ… ç”Ÿæ•ˆï¼šç±»å‹åŒ¹é…
SELECT * FROM lab_environment_data WHERE lab_id = 1;
```

---

**3. LIKE å·¦æ¨¡ç³Š**
```sql
-- å‡è®¾ï¼šæœ‰ç´¢å¼• INDEX idx_name(lab_name)

-- âŒ å¤±æ•ˆï¼šå·¦æ¨¡ç³Š
SELECT * FROM laboratory WHERE lab_name LIKE '%å®éªŒå®¤';

-- âœ… ç”Ÿæ•ˆï¼šå³æ¨¡ç³Š
SELECT * FROM laboratory WHERE lab_name LIKE 'å®éªŒå®¤%';

-- âœ… ç”Ÿæ•ˆï¼šä¸ä½¿ç”¨é€šé…ç¬¦
SELECT * FROM laboratory WHERE lab_name = 'å®éªŒå®¤1';
```

---

**4. è”åˆç´¢å¼•ä¸éµå¾ªæœ€å·¦å‰ç¼€**
```sql
-- å‡è®¾ï¼šæœ‰è”åˆç´¢å¼• INDEX idx_lab_time(lab_id, monitor_time)

-- âœ… ç”Ÿæ•ˆï¼šä½¿ç”¨lab_idï¼ˆæœ€å·¦åˆ—ï¼‰
SELECT * FROM lab_environment_data WHERE lab_id = 1;

-- âœ… ç”Ÿæ•ˆï¼šä½¿ç”¨lab_idå’Œmonitor_time
SELECT * FROM lab_environment_data WHERE lab_id = 1 AND monitor_time > '2025-11-01';

-- âŒ å¤±æ•ˆï¼šè·³è¿‡lab_idï¼Œç›´æ¥ä½¿ç”¨monitor_time
SELECT * FROM lab_environment_data WHERE monitor_time > '2025-11-01';
```

**è”åˆç´¢å¼•è§„åˆ™ï¼ˆæœ€å·¦å‰ç¼€ï¼‰ï¼š**
```
ç´¢å¼•ï¼š(a, b, c)

âœ… WHERE a = 1              # ä½¿ç”¨ç´¢å¼•(a)
âœ… WHERE a = 1 AND b = 2    # ä½¿ç”¨ç´¢å¼•(a, b)
âœ… WHERE a = 1 AND c = 3    # ä½¿ç”¨ç´¢å¼•(a)ï¼Œcæ— æ³•ä½¿ç”¨
âŒ WHERE b = 2              # ä¸ä½¿ç”¨ç´¢å¼•
âŒ WHERE c = 3              # ä¸ä½¿ç”¨ç´¢å¼•
```

---

**5. ä½¿ç”¨ OR è¿æ¥ä¸åŒç´¢å¼•åˆ—**
```sql
-- âŒ å¤±æ•ˆï¼šORè¿æ¥ä¸åŒç´¢å¼•åˆ—
SELECT * FROM lab_environment_data
WHERE lab_id = 1 OR temperature > 30;
-- lab_idæœ‰ç´¢å¼•ï¼Œtemperatureæœ‰ç´¢å¼•ï¼Œä½†ORè¿æ¥å¯¼è‡´éƒ½å¤±æ•ˆ

-- âœ… æ”¹å†™ä¸ºUNION
SELECT * FROM lab_environment_data WHERE lab_id = 1
UNION
SELECT * FROM lab_environment_data WHERE temperature > 30;
```

---

**6. ä½¿ç”¨ != æˆ– <> æˆ– NOT IN**
```sql
-- âŒ å¯èƒ½å¤±æ•ˆï¼š!=
SELECT * FROM lab_environment_data WHERE lab_id != 1;

-- âŒ å¯èƒ½å¤±æ•ˆï¼šNOT IN
SELECT * FROM lab_environment_data WHERE lab_id NOT IN (1, 2, 3);

-- âœ… æ”¹å†™ä¸ºIN
SELECT * FROM lab_environment_data WHERE lab_id IN (4, 5, 6, 7, ...);
```

---

**é¢è¯•å›ç­”æ€»ç»“ï¼š**

> "ç´¢å¼•å¤±æ•ˆçš„å¸¸è§åœºæ™¯æœ‰ï¼š
>
> **1. ä½¿ç”¨å‡½æ•°æˆ–è®¡ç®—**ï¼šWHERE DATE(time) = ...ä¼šå¤±æ•ˆ
>
> **2. éšå¼ç±»å‹è½¬æ¢**ï¼šlab_idæ˜¯INTï¼Œä¼ å…¥'1'ä¼šå¤±æ•ˆ
>
> **3. LIKEå·¦æ¨¡ç³Š**ï¼šLIKE '%å…³é”®å­—'ä¼šå¤±æ•ˆï¼ŒLIKE 'å…³é”®å­—%'æ­£å¸¸
>
> **4. è”åˆç´¢å¼•ä¸éµå¾ªæœ€å·¦å‰ç¼€**ï¼šç´¢å¼•æ˜¯(a,b,c)ï¼ŒWHERE b=1ä¼šå¤±æ•ˆï¼Œå¿…é¡»ä»aå¼€å§‹
>
> **5. ORè¿æ¥ä¸åŒç´¢å¼•åˆ—**ï¼šä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ
>
> **6. ä½¿ç”¨!=ã€NOT IN**ï¼šå¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆ
>
> æˆ‘ä»¬é¡¹ç›®ä¸­ï¼Œé€šè¿‡EXPLAINæ£€æŸ¥æ‰§è¡Œè®¡åˆ’ï¼Œç¡®ä¿å…³é”®æŸ¥è¯¢éƒ½èµ°ç´¢å¼•ã€‚"

---

### â“ 8.3 å¦‚ä½•è®¾è®¡åˆç†çš„ç´¢å¼•ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**ç´¢å¼•è®¾è®¡åŸåˆ™ï¼ˆ5æ¡ï¼‰ï¼š**

**1. åœ¨WHEREã€ORDER BYã€GROUP BYçš„åˆ—ä¸Šå»ºç´¢å¼•**

```sql
-- æŸ¥è¯¢ç»å¸¸ç”¨åˆ°çš„åˆ—
SELECT * FROM lab_environment_data
WHERE lab_id = 1
ORDER BY monitor_time DESC;

-- åº”è¯¥åˆ›å»ºç´¢å¼•
CREATE INDEX idx_lab_time ON lab_environment_data(lab_id, monitor_time);
```

---

**2. ä¼˜å…ˆé€‰æ‹©åŒºåˆ†åº¦é«˜çš„åˆ—**

```sql
-- âŒ åŒºåˆ†åº¦ä½ï¼šæ€§åˆ«ï¼ˆåªæœ‰ç”·/å¥³ï¼‰
-- å…¨è¡¨100ä¸‡è¡Œï¼Œç”·50ä¸‡ï¼Œå¥³50ä¸‡ï¼ŒåŒºåˆ†åº¦ï¼š50%
CREATE INDEX idx_gender ON user(gender);  -- ä¸æ¨è

-- âœ… åŒºåˆ†åº¦é«˜ï¼šç”¨æˆ·IDï¼ˆå”¯ä¸€ï¼‰
-- åŒºåˆ†åº¦ï¼š100%
CREATE INDEX idx_user_id ON user(id);  -- æ¨è

-- è®¡ç®—åŒºåˆ†åº¦ï¼š
SELECT COUNT(DISTINCT lab_id) / COUNT(*) AS selectivity
FROM lab_environment_data;
-- ç»“æœï¼š0.001ï¼ˆåŒºåˆ†åº¦1%ï¼‰â†’ ä¸å»ºè®®å•ç‹¬å»ºç´¢å¼•
-- ç»“æœï¼š0.9ï¼ˆåŒºåˆ†åº¦90%ï¼‰â†’ é€‚åˆå»ºç´¢å¼•
```

---

**3. è”åˆç´¢å¼•éµå¾ªæœ€å·¦å‰ç¼€**

```sql
-- æŸ¥è¯¢åœºæ™¯ï¼š
-- 1. WHERE lab_id = 1
-- 2. WHERE lab_id = 1 AND monitor_time > '2025-11-01'
-- 3. WHERE lab_id = 1 ORDER BY monitor_time

-- åˆ›å»ºè”åˆç´¢å¼•ï¼ˆé«˜é¢‘åˆ—åœ¨å‰ï¼‰
CREATE INDEX idx_lab_time ON lab_environment_data(lab_id, monitor_time);

-- ä¸€ä¸ªç´¢å¼•è¦†ç›–å¤šä¸ªæŸ¥è¯¢åœºæ™¯
```

---

**4. æ§åˆ¶ç´¢å¼•æ•°é‡**

```sql
-- âŒ é”™è¯¯ï¼šå»ºå¤ªå¤šç´¢å¼•
CREATE INDEX idx_lab ON lab_environment_data(lab_id);
CREATE INDEX idx_time ON lab_environment_data(monitor_time);
CREATE INDEX idx_temp ON lab_environment_data(temperature);
CREATE INDEX idx_humi ON lab_environment_data(humidity);
-- é—®é¢˜ï¼š
-- - å ç”¨å¤§é‡å­˜å‚¨ç©ºé—´
-- - INSERT/UPDATEå˜æ…¢ï¼ˆéœ€è¦ç»´æŠ¤ç´¢å¼•ï¼‰
-- - MySQLé€‰æ‹©ç´¢å¼•å¯èƒ½é”™è¯¯

-- âœ… æ­£ç¡®ï¼šåˆç†è§„åˆ’ï¼Œåˆ›å»ºè”åˆç´¢å¼•
CREATE INDEX idx_lab_time ON lab_environment_data(lab_id, monitor_time);
CREATE INDEX idx_temp ON lab_environment_data(temperature);  -- å¦‚æœçœŸçš„éœ€è¦
```

**å»ºè®®ï¼š**
- å•è¡¨ç´¢å¼•æ•°é‡ â‰¤ 5ä¸ª
- ä¼˜å…ˆä½¿ç”¨è”åˆç´¢å¼•

---

**5. é¿å…å†—ä½™ç´¢å¼•**

```sql
-- âŒ å†—ä½™ç´¢å¼•ï¼š
CREATE INDEX idx_a ON table(a);
CREATE INDEX idx_ab ON table(a, b);
-- idx_aæ˜¯å†—ä½™çš„ï¼Œå› ä¸ºidx_abçš„æœ€å·¦å‰ç¼€å°±æ˜¯a

-- âœ… æ­£ç¡®ï¼šåªä¿ç•™idx_ab
CREATE INDEX idx_ab ON table(a, b);
```

---

**æˆ‘ä»¬é¡¹ç›®çš„ç´¢å¼•è®¾è®¡ï¼š**

```sql
-- lab_environment_dataè¡¨
CREATE INDEX idx_lab_time ON lab_environment_data(lab_id, monitor_time);
-- è¦†ç›–åœºæ™¯ï¼š
-- 1. æŸ¥è¯¢æŸå®éªŒå®¤æ•°æ®
-- 2. æŸ¥è¯¢æŸå®éªŒå®¤æŸæ—¶é—´æ®µæ•°æ®
-- 3. æŒ‰æ—¶é—´æ’åº

-- lab_alarmè¡¨
CREATE INDEX idx_lab_time ON lab_alarm(lab_id, alarm_time);
CREATE INDEX idx_level_time ON lab_alarm(alarm_level, alarm_time);
-- åœºæ™¯ï¼š
-- 1. æŸ¥è¯¢æŸå®éªŒå®¤å‘Šè­¦
-- 2. æŸ¥è¯¢æŸçº§åˆ«å‘Šè­¦

-- lab_daily_statisticsè¡¨
CREATE INDEX idx_lab_date ON lab_daily_statistics(lab_id, stat_date);
CREATE INDEX idx_date ON lab_daily_statistics(stat_date);
-- åœºæ™¯ï¼š
-- 1. æŸ¥è¯¢æŸå®éªŒå®¤ç»Ÿè®¡
-- 2. æŸ¥è¯¢æŸæ—¥æœŸæ‰€æœ‰ç»Ÿè®¡
```

---

**é¢è¯•å›ç­”æ€»ç»“ï¼š**

> "ç´¢å¼•è®¾è®¡åŸåˆ™ï¼š
>
> **1. åœ¨WHEREã€ORDER BYã€GROUP BYçš„åˆ—ä¸Šå»ºç´¢å¼•**
>
> **2. é€‰æ‹©åŒºåˆ†åº¦é«˜çš„åˆ—**ï¼šåŒºåˆ†åº¦ = COUNT(DISTINCT col) / COUNT(*)ï¼Œå»ºè®®â‰¥0.3
>
> **3. ä½¿ç”¨è”åˆç´¢å¼•ï¼Œéµå¾ªæœ€å·¦å‰ç¼€**ï¼šé«˜é¢‘æŸ¥è¯¢åˆ—åœ¨å‰
>
> **4. æ§åˆ¶ç´¢å¼•æ•°é‡**ï¼šå•è¡¨â‰¤5ä¸ªï¼Œé¿å…è¿‡å¤šç´¢å¼•å½±å“å†™å…¥æ€§èƒ½
>
> **5. é¿å…å†—ä½™ç´¢å¼•**ï¼š(a)å’Œ(a,b)å­˜åœ¨æ—¶ï¼Œ(a)æ˜¯å†—ä½™çš„
>
> æˆ‘ä»¬é¡¹ç›®ä¸­ï¼Œä¸»è¦è¡¨éƒ½å»ºç«‹äº†(lab_id, time)è”åˆç´¢å¼•ï¼Œè¦†ç›–äº†å¤§éƒ¨åˆ†æŸ¥è¯¢åœºæ™¯ã€‚"

---

## ä¹ã€JVM è°ƒä¼˜ï¼ˆåŸºç¡€ç‰ˆï¼‰

### â“ 9.1 ä¸ºä»€ä¹ˆä½¿ç”¨ G1 å›æ”¶å™¨ï¼Ÿæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**å¸¸è§åƒåœ¾å›æ”¶å™¨å¯¹æ¯”ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š**

| å›æ”¶å™¨ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|-------|------|---------|
| **Serial** | å•çº¿ç¨‹ï¼ŒStop-The-World | å•æ ¸CPUã€å°å†…å­˜ |
| **Parallel** | å¤šçº¿ç¨‹ï¼Œé«˜ååé‡ï¼Œé•¿åœé¡¿ | åå°ä»»åŠ¡ã€æ‰¹å¤„ç† |
| **CMS** | å¹¶å‘æ ‡è®°æ¸…é™¤ï¼ŒçŸ­åœé¡¿ï¼Œä¼šäº§ç”Ÿç¢ç‰‡ | å“åº”æ—¶é—´ä¼˜å…ˆ |
| **G1** | åˆ†åŒºå›æ”¶ï¼Œåœé¡¿æ—¶é—´å¯æ§ï¼Œæ— ç¢ç‰‡ | å¤§å †å†…å­˜ï¼ˆæ¨èï¼‰âœ… |

---

**G1 å›æ”¶å™¨çš„ä¼˜åŠ¿ï¼š**

**1. åœé¡¿æ—¶é—´å¯é¢„æµ‹**
```bash
# å¯åŠ¨å‚æ•°
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200  # ç›®æ ‡åœé¡¿æ—¶é—´200ms

# G1ä¼šå°½é‡æ»¡è¶³è¿™ä¸ªç›®æ ‡
# æˆ‘ä»¬é¡¹ç›®å®æµ‹ï¼š95%çš„GCåœé¡¿ < 200ms
```

**2. ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡**
```
Parallel GCï¼ˆæ ‡è®°-æ¸…é™¤ï¼‰ï¼š
[å¯¹è±¡][ç©º][å¯¹è±¡][ç©º][ç©º][å¯¹è±¡]  # äº§ç”Ÿç¢ç‰‡ï¼Œéœ€è¦Full GCæ•´ç†

G1 GCï¼ˆå¤åˆ¶ç®—æ³•ï¼‰ï¼š
[å¯¹è±¡][å¯¹è±¡][å¯¹è±¡][ç©ºé—²Region]  # æ— ç¢ç‰‡
```

**3. åˆ†ä»£æ”¶é›† + åˆ†åŒºç®¡ç†**
```
G1å†…å­˜å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Heap (2GB)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Regionâ”‚Regionâ”‚Regionâ”‚Regionâ”‚Regionâ”‚...â”‚ â”‚
â”‚  â”‚ Eden â”‚ Eden â”‚Survivorâ”‚Oldâ”‚Oldâ”‚Hugeâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªRegion = 1-32MBï¼ˆå¯é…ç½®ï¼‰
G1ä¼˜å…ˆå›æ”¶åƒåœ¾æœ€å¤šçš„Regionï¼ˆGarbage Firstï¼‰
```

---

**æˆ‘ä»¬é¡¹ç›®çš„JVMå‚æ•°ï¼š**

```bash
# å¯åŠ¨è„šæœ¬
java -jar monitor-service.jar \
  # å †å†…å­˜
  -Xms2g \              # åˆå§‹å †2GB
  -Xmx2g \              # æœ€å¤§å †2GB

  # ä½¿ç”¨G1å›æ”¶å™¨
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \     # ç›®æ ‡åœé¡¿200ms
  -XX:G1HeapRegionSize=16m \     # Regionå¤§å°16MB

  # GCæ—¥å¿—
  -XX:+PrintGCDetails \
  -Xloggc:/logs/gc.log
```

---

**ä¼˜åŒ–å‰åå¯¹æ¯”ï¼š**

| æŒ‡æ ‡ | Parallel GCï¼ˆä¼˜åŒ–å‰ï¼‰ | G1 GCï¼ˆä¼˜åŒ–åï¼‰ |
|-----|---------------------|----------------|
| Full GCæ¬¡æ•° | æ¯å°æ—¶5æ¬¡ | æ¯å¤©1æ¬¡ âœ… |
| GCåœé¡¿æ—¶é—´ | 500ms-2s | 100ms-200ms âœ… |
| å †å†…å­˜ | 4GB | 2GB âœ… |

---

**é¢è¯•å›ç­”æ€»ç»“ï¼š**

> "æˆ‘ä»¬é¡¹ç›®é€‰æ‹©G1å›æ”¶å™¨ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªåŸå› ï¼š
>
> **1. åœé¡¿æ—¶é—´å¯é¢„æµ‹**ï¼šå¯ä»¥è®¾ç½®MaxGCPauseMillis=200msï¼ŒG1ä¼šå°½é‡æ»¡è¶³è¿™ä¸ªç›®æ ‡ï¼Œä¿è¯ç”¨æˆ·ä½“éªŒã€‚
>
> **2. ä¸äº§ç”Ÿå†…å­˜ç¢ç‰‡**ï¼šG1ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œé¿å…äº†CMSçš„ç¢ç‰‡é—®é¢˜ï¼Œå‡å°‘Full GCã€‚
>
> **3. é€‚åˆå¤§å †å†…å­˜**ï¼šæˆ‘ä»¬é¡¹ç›®å †å†…å­˜2GBï¼ŒG1çš„åˆ†åŒºç®¡ç†æœºåˆ¶å¾ˆé€‚åˆã€‚
>
> ä¼˜åŒ–åï¼ŒFull GCä»æ¯å°æ—¶5æ¬¡é™åˆ°æ¯å¤©1æ¬¡ï¼ŒGCåœé¡¿æ—¶é—´ä»500ms-2sé™åˆ°100ms-200msã€‚"

---

### â“ 9.2 å¦‚ä½•å®šä½å’Œè§£å†³ OOM é—®é¢˜ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**OOMï¼ˆOutOfMemoryErrorï¼‰çš„å¸¸è§åŸå› ï¼š**

**1. å†…å­˜æ³„æ¼**
```java
// âŒ é—®é¢˜ä»£ç ï¼šThreadLocalæœªæ¸…ç†
@Component
public class UserInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle() {
        UserContext.setUserId(123L);
        return true;
    }
    // æ²¡æœ‰æ¸…ç†ï¼Œçº¿ç¨‹å¤ç”¨æ—¶å†…å­˜æ³„æ¼
}

// âœ… ä¿®å¤ï¼šåœ¨afterCompletionä¸­æ¸…ç†
@Override
public void afterCompletion() {
    UserContext.clear();
}
```

---

**2. åˆ›å»ºå¤§å¯¹è±¡**
```java
// âŒ é—®é¢˜ä»£ç ï¼šä¸€æ¬¡æ€§æŸ¥è¯¢100ä¸‡æ¡æ•°æ®
List<LabEnvironmentData> dataList = mapper.selectAll();  // OOM!

// âœ… ä¿®å¤ï¼šåˆ†æ‰¹æŸ¥è¯¢
int pageSize = 1000;
for (int page = 1; ; page++) {
    List<LabEnvironmentData> data = mapper.selectPage(page, pageSize);
    if (data.isEmpty()) break;
    processData(data);
}
```

---

**æ’æŸ¥æ­¥éª¤ï¼š**

**1. æ·»åŠ JVMå‚æ•°ï¼ŒOOMæ—¶è‡ªåŠ¨ç”ŸæˆHeap Dump**
```bash
java -jar app.jar \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/logs/heapdump.hprof
```

**2. ä½¿ç”¨ MAT åˆ†æ Heap Dump**
- ä¸‹è½½ Eclipse MATï¼ˆMemory Analyzer Toolï¼‰
- æ‰“å¼€ heapdump.hprof æ–‡ä»¶
- æŸ¥çœ‹ Leak Suspectsï¼ˆç–‘ä¼¼æ³„æ¼ï¼‰
- æ‰¾åˆ°å ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡

**3. å¸¸è§æ³„æ¼åŸå› **
- ThreadLocalæœªæ¸…ç†
- é™æ€é›†åˆæŒæœ‰å¤§å¯¹è±¡
- æ•°æ®åº“è¿æ¥æœªå…³é—­
- ç¼“å­˜æ— é™å¢é•¿

---

**é¢è¯•å›ç­”æ€»ç»“ï¼š**

> "OOMå¸¸è§åŸå› æœ‰ä¸¤ä¸ªï¼š
>
> **1. å†…å­˜æ³„æ¼**ï¼šThreadLocalæœªæ¸…ç†ã€é™æ€é›†åˆæ— é™å¢é•¿ç­‰
>
> **2. å¤§å¯¹è±¡**ï¼šä¸€æ¬¡æ€§æŸ¥è¯¢å¤§é‡æ•°æ®ã€å¤§æ–‡ä»¶è¯»å–ç­‰
>
> **æ’æŸ¥æ–¹æ³•ï¼š**
> - æ·»åŠ JVMå‚æ•°-XX:+HeapDumpOnOutOfMemoryErrorï¼ŒOOMæ—¶è‡ªåŠ¨ç”Ÿæˆå †å¿«ç…§
> - ä½¿ç”¨MATå·¥å…·åˆ†æheapdumpæ–‡ä»¶ï¼Œæ‰¾åˆ°å ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡
> - æ£€æŸ¥ä»£ç ï¼Œä¿®å¤å†…å­˜æ³„æ¼æˆ–æ”¹ä¸ºåˆ†æ‰¹å¤„ç†
>
> æˆ‘ä»¬é¡¹ç›®ä¸­é‡åˆ°è¿‡ThreadLocalæœªæ¸…ç†å¯¼è‡´çš„å†…å­˜æ³„æ¼ï¼Œæ·»åŠ afterCompletionæ¸…ç†åè§£å†³äº†ã€‚"

---

### â“ 9.3 å¸¸è§çš„JVMå‚æ•°æœ‰å“ªäº›ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**æˆ‘ä»¬é¡¹ç›®ä½¿ç”¨çš„JVMå‚æ•°ï¼š**

```bash
java -jar monitor-service.jar \
  # 1. å †å†…å­˜è®¾ç½®
  -Xms2g \                # åˆå§‹å †å¤§å°2GB
  -Xmx2g \                # æœ€å¤§å †å¤§å°2GBï¼ˆä¸Xmsç›¸åŒï¼Œé¿å…åŠ¨æ€æ‰©å®¹ï¼‰

  # 2. åƒåœ¾å›æ”¶å™¨
  -XX:+UseG1GC \          # ä½¿ç”¨G1å›æ”¶å™¨
  -XX:MaxGCPauseMillis=200 \  # ç›®æ ‡åœé¡¿200ms

  # 3. GCæ—¥å¿—
  -XX:+PrintGCDetails \   # æ‰“å°GCè¯¦æƒ…
  -XX:+PrintGCDateStamps \  # æ‰“å°GCæ—¶é—´æˆ³
  -Xloggc:/logs/gc.log \  # GCæ—¥å¿—æ–‡ä»¶

  # 4. OOMå¤„ç†
  -XX:+HeapDumpOnOutOfMemoryError \  # OOMæ—¶ç”Ÿæˆå †å¿«ç…§
  -XX:HeapDumpPath=/logs/heapdump.hprof  # å †å¿«ç…§è·¯å¾„
```

---

**å‚æ•°è¯´æ˜ï¼š**

**1. å †å†…å­˜å‚æ•°**
```bash
-Xms2g    # åˆå§‹å †å¤§å°
-Xmx2g    # æœ€å¤§å †å¤§å°
# å»ºè®®ï¼šXms = Xmxï¼Œé¿å…åŠ¨æ€æ‰©å®¹å¸¦æ¥çš„æ€§èƒ½å¼€é”€
```

**2. GCå‚æ•°**
```bash
-XX:+UseG1GC              # ä½¿ç”¨G1å›æ”¶å™¨ï¼ˆæ¨èï¼‰
-XX:+UseParallelGC        # ä½¿ç”¨Parallelå›æ”¶å™¨ï¼ˆååé‡ä¼˜å…ˆï¼‰
-XX:+UseConcMarkSweepGC   # ä½¿ç”¨CMSå›æ”¶å™¨ï¼ˆå·²è¿‡æ—¶ï¼‰
```

**3. GCè°ƒä¼˜å‚æ•°**
```bash
-XX:MaxGCPauseMillis=200  # G1ç›®æ ‡åœé¡¿æ—¶é—´
-XX:G1HeapRegionSize=16m  # G1 Regionå¤§å°ï¼ˆ1-32MBï¼‰
```

---

**é¢è¯•å›ç­”æ€»ç»“ï¼š**

> "æˆ‘ä»¬é¡¹ç›®çš„JVMå‚æ•°ï¼š
>
> **1. å †å†…å­˜**ï¼š-Xms2g -Xmx2gï¼Œè®¾ç½®ä¸ºç›¸åŒé¿å…åŠ¨æ€æ‰©å®¹
>
> **2. åƒåœ¾å›æ”¶å™¨**ï¼š-XX:+UseG1GCï¼Œä½¿ç”¨G1å›æ”¶å™¨
>
> **3. GCè°ƒä¼˜**ï¼š-XX:MaxGCPauseMillis=200ï¼Œç›®æ ‡åœé¡¿200ms
>
> **4. é—®é¢˜æ’æŸ¥**ï¼š-XX:+HeapDumpOnOutOfMemoryErrorï¼ŒOOMæ—¶ç”Ÿæˆå †å¿«ç…§
>
> è¿™å¥—å‚æ•°é…ç½®åï¼Œç³»ç»Ÿè¿è¡Œç¨³å®šï¼ŒFull GCå¾ˆå°‘å‘ç”Ÿã€‚"

---

## ğŸ¯ ç¬¬ä¸‰éƒ¨åˆ†æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹ï¼š**

### ä¸ƒã€Kafkaæ¶ˆæ¯é˜Ÿåˆ—
1. **ä¸ºä»€ä¹ˆç”¨Kafka**ï¼šå¼‚æ­¥è§£è€¦ã€å‰Šå³°å¡«è°·ã€æé«˜å¯ç”¨æ€§
2. **åŸºæœ¬æ¦‚å¿µ**ï¼šTopicã€Partitionã€Consumer Group
3. **é¡¹ç›®åº”ç”¨**ï¼šç¯å¢ƒæ•°æ®ä¸ŠæŠ¥ â†’ Kafka â†’ ä¸‰ä¸ªæ¶ˆè´¹è€…ç»„
4. **æ¶ˆæ¯ä¸ä¸¢å¤±**ï¼šacksã€å‰¯æœ¬ã€æ‰‹åŠ¨æäº¤offset

### å…«ã€MySQLä¼˜åŒ–
1. **æ…¢SQLä¼˜åŒ–**ï¼šEXPLAINåˆ†æ â†’ æ·»åŠ ç´¢å¼• â†’ é¿å…ç´¢å¼•å¤±æ•ˆ
2. **ç´¢å¼•å¤±æ•ˆ**ï¼šå‡½æ•°ã€ç±»å‹è½¬æ¢ã€å·¦æ¨¡ç³Šã€æœ€å·¦å‰ç¼€ã€ORã€!=
3. **ç´¢å¼•è®¾è®¡**ï¼šWHERE/ORDER BYåˆ—ã€åŒºåˆ†åº¦é«˜ã€è”åˆç´¢å¼•ã€æ§åˆ¶æ•°é‡

### ä¹ã€JVMè°ƒä¼˜
1. **G1å›æ”¶å™¨**ï¼šåœé¡¿å¯æ§ã€æ— ç¢ç‰‡ã€é€‚åˆå¤§å †
2. **OOMæ’æŸ¥**ï¼šHeapDump + MATåˆ†æ
3. **JVMå‚æ•°**ï¼šXms/Xmxã€UseG1GCã€MaxGCPauseMillis

---

## ğŸ“ ä¸‰éƒ¨åˆ†åˆé›†

**ç¬¬ä¸€éƒ¨åˆ†ï¼šå¾®æœåŠ¡åŸºç¡€ç»„ä»¶ä¸æ¶æ„**
- Nacosæ³¨å†Œä¸­å¿ƒï¼ˆå¿ƒè·³æœºåˆ¶ã€AP/CPæ¨¡å¼ï¼‰
- Gatewayç½‘å…³ï¼ˆè·¯ç”±ã€è¿‡æ»¤å™¨ã€é™æµï¼‰
- è®¤è¯é‰´æƒï¼ˆJWTã€æ‹¦æˆªå™¨ã€ThreadLocalï¼‰

**ç¬¬äºŒéƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–ä¸WebSocketå®æ—¶é€šä¿¡**
- æ€§èƒ½ä¼˜åŒ–ï¼ˆSQLæ‹†åˆ†ã€å¼‚æ­¥å¤„ç†ã€ç¼“å­˜ï¼‰
- WebSocketå®ç°ï¼ˆ@ServerEndpointã€æ¨é€ï¼‰
- Redisç¼“å­˜ï¼ˆ5ç§ç±»å‹ã€ç©¿é€/å‡»ç©¿/é›ªå´©ï¼‰

**ç¬¬ä¸‰éƒ¨åˆ†ï¼šKafkaæ¶ˆæ¯é˜Ÿåˆ—ä¸ç³»ç»Ÿè°ƒä¼˜**
- Kafkaåº”ç”¨ï¼ˆå¼‚æ­¥è§£è€¦ã€å‰Šå³°å¡«è°·ï¼‰
- MySQLä¼˜åŒ–ï¼ˆæ…¢SQLã€ç´¢å¼•ï¼‰
- JVMè°ƒä¼˜ï¼ˆG1ã€OOMã€å‚æ•°ï¼‰

---

## ğŸ“ é¢è¯•å»ºè®®

**1. å›ç­”ç»“æ„**
```
é—®é¢˜ â†’ èƒŒæ™¯ â†’ åŸç† â†’ é¡¹ç›®å®è·µ â†’ æ•ˆæœå¯¹æ¯”
```

**2. åŠ åˆ†é¡¹**
- ç»“åˆé¡¹ç›®çœŸå®åœºæ™¯
- è¯´å‡ºä¼˜åŒ–å‰åçš„æ•°æ®å¯¹æ¯”
- æåŠé‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- é€‚å½“å±•å¼€ï¼ˆä½†ä¸è¦è¿‡åº¦ï¼‰

**3. æ³¨æ„äº‹é¡¹**
- ä¸è¦èƒŒä¹¦ï¼Œç”¨è‡ªå·±çš„è¯è¯´
- ä¸æ‡‚çš„ä¸è¦ç¡¬ç­”ï¼Œè¯šå®è¯´"æ²¡æœ‰ç”¨è¿‡"
- ç®€å†ä¸Šçš„æŠ€æœ¯ä¸€å®šè¦ç†Ÿæ‚‰
- å‡†å¤‡å¥½é¡¹ç›®ä¸­çš„éš¾ç‚¹å’Œäº®ç‚¹

---

**ç¥ä½ é¢è¯•é¡ºåˆ©ï¼ğŸ‰**

æœ‰ä»»ä½•é—®é¢˜éšæ—¶é—®æˆ‘ï¼
