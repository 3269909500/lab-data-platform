# å®éªŒå®¤ç‰©è”æ•°æ®ä¸­å° - é¢è¯•é—®ç­”æ‰‹å†Œï¼ˆç¬¬2éƒ¨åˆ†ï¼‰

> åŸºäºä½ çš„é¡¹ç›®ç»éªŒï¼Œé’ˆå¯¹é¢è¯•ä¸­å¸¸è§é—®é¢˜çš„æ·±åº¦è§£ç­”
> æœ¬æ–‡æ¡£åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œè¿™æ˜¯ç¬¬äºŒéƒ¨åˆ†ï¼š**æ€§èƒ½ä¼˜åŒ–ä¸WebSocketå®æ—¶é€šä¿¡**

---

## ğŸ“š ç›®å½•

- [å››ã€æ€§èƒ½ä¼˜åŒ–åœºæ™¯é¢˜](#å››æ€§èƒ½ä¼˜åŒ–åœºæ™¯é¢˜)
- [äº”ã€WebSocket å®æ—¶é€šä¿¡](#äº”websocket-å®æ—¶é€šä¿¡)
- [å…­ã€Redis ç¼“å­˜åº”ç”¨](#å…­redis-ç¼“å­˜åº”ç”¨)

---

## å››ã€æ€§èƒ½ä¼˜åŒ–åœºæ™¯é¢˜

### â“ 4.1 ã€æ ¸å¿ƒåœºæ™¯é¢˜ã€‘æ¥å£æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå¦‚ä½•ä¼˜åŒ–ï¼Ÿ

**ğŸ¯ é¢è¯•å®˜è¿½é—®ï¼š**
> "å‡å¦‚ç°åœ¨æœ‰ä¸€ä¸ªæ¥å£æ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿ï¼Œè¶…è¿‡äº†10ç§’ï¼Œç”¨æˆ·ä½“éªŒå¾ˆå·®ï¼Œä½ ä¼šå¦‚ä½•ä¼˜åŒ–ï¼Ÿè¯·è¯´å‡ºå®Œæ•´çš„æ’æŸ¥æ€è·¯å’Œä¼˜åŒ–æ–¹æ¡ˆã€‚"

**ğŸ’¡ å®Œæ•´çš„å›ç­”æ€è·¯ï¼ˆåˆ†å±‚ä¼˜åŒ–ï¼‰ï¼š**

---

#### ç¬¬ä¸€æ­¥ï¼šå®šä½é—®é¢˜ï¼ˆæ‰¾å‡ºç“¶é¢ˆåœ¨å“ªï¼‰

**1. å¼€å¯æ…¢æ¥å£æ—¥å¿—**
```java
// æ‹¦æˆªå™¨ä¸­è®°å½•æ¥å£è€—æ—¶
@Override
public void afterCompletion(HttpServletRequest request, HttpServletResponse response,
                            Object handler, Exception ex) {
    Long startTime = (Long) request.getAttribute("startTime");
    if (startTime != null) {
        long duration = System.currentTimeMillis() - startTime;
        if (duration > 3000) {  // è¶…è¿‡3ç§’è®°å½•
            log.warn("âš ï¸ æ…¢æ¥å£ - URI: {}, è€—æ—¶: {}ms", request.getRequestURI(), duration);
        }
    }
}
```

**2. åˆ†æè€—æ—¶åˆ†å¸ƒ**
```
æ€»è€—æ—¶: 10ç§’
â”œâ”€ æ•°æ®åº“æŸ¥è¯¢: 8ç§’  â† ä¸»è¦ç“¶é¢ˆ
â”œâ”€ Redisæ“ä½œ: 0.5ç§’
â”œâ”€ ä¸šåŠ¡è®¡ç®—: 1ç§’
â””â”€ ç½‘ç»œä¼ è¾“: 0.5ç§’
```

**å·¥å…·ï¼š**
- Spring Boot Actuatorï¼š`/actuator/metrics`
- Arthasï¼šé˜¿é‡Œå¼€æºçš„Javaè¯Šæ–­å·¥å…·
- MySQLæ…¢æŸ¥è¯¢æ—¥å¿—ï¼š`slow_query_log`

---

#### ç¬¬äºŒæ­¥ï¼šé’ˆå¯¹æ€§ä¼˜åŒ–ï¼ˆå¯¹ç—‡ä¸‹è¯ï¼‰

**åœºæ™¯1ï¼šæ•°æ®åº“æŸ¥è¯¢æ…¢ï¼ˆ8ç§’ï¼‰**

**åŸå› åˆ†æï¼š**
```sql
-- é—®é¢˜SQLï¼šå¤æ‚çš„ç»Ÿè®¡æŸ¥è¯¢
SELECT
    lab.id,
    lab.lab_name,
    AVG(data.temperature) as avg_temp,
    AVG(data.humidity) as avg_humidity,
    AVG(data.pm25) as avg_pm25,
    AVG(data.co2) as avg_co2,
    COUNT(alarm.id) as alarm_count
FROM laboratory lab
LEFT JOIN lab_environment_data data ON lab.id = data.lab_id
    AND data.monitor_time >= '2025-11-01' AND data.monitor_time < '2025-12-01'
LEFT JOIN lab_alarm alarm ON lab.id = alarm.lab_id
    AND alarm.alarm_time >= '2025-11-01' AND alarm.alarm_time < '2025-12-01'
GROUP BY lab.id
ORDER BY avg_temp DESC;

-- æ‰§è¡Œè®¡åˆ’æ˜¾ç¤ºï¼š
-- type: ALL (å…¨è¡¨æ‰«æ)
-- rows: 100ä¸‡+
-- Extra: Using filesort, Using temporary
```

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

**âœ… æ–¹æ¡ˆ1ï¼šSQLæ‹†åˆ†ï¼ˆæˆ‘ä»¬é¡¹ç›®å®é™…é‡‡ç”¨ï¼‰**

å°†ä¸€æ¡å¤æ‚SQLæ‹†åˆ†ä¸ºå¤šæ¡ç®€å•SQLï¼š

```java
// ä¼˜åŒ–å‰ï¼šä¸€æ¡å¤æ‚SQLï¼Œè€—æ—¶8ç§’
public LabStatistics getStatistics(Long labId, LocalDate startDate, LocalDate endDate) {
    return labStatisticsMapper.getComplexStatistics(labId, startDate, endDate);  // 8ç§’
}

// ä¼˜åŒ–åï¼šæ‹†åˆ†ä¸º3æ¡ç®€å•SQLï¼Œæ€»è€—æ—¶1.5ç§’
public LabStatistics getStatistics(Long labId, LocalDate startDate, LocalDate endDate) {
    // 1. æŸ¥è¯¢ç¯å¢ƒæ•°æ®ç»Ÿè®¡ (0.5ç§’)
    EnvironmentStats envStats = labEnvironmentDataMapper.selectStats(labId, startDate, endDate);

    // 2. æŸ¥è¯¢å‘Šè­¦ç»Ÿè®¡ (0.5ç§’)
    AlarmStats alarmStats = labAlarmMapper.selectStats(labId, startDate, endDate);

    // 3. æŸ¥è¯¢äººå‘˜ç»Ÿè®¡ (0.5ç§’)
    PersonStats personStats = labPersonMapper.selectStats(labId, startDate, endDate);

    // 4. åœ¨Javaå±‚ç»„è£…ç»“æœ
    return LabStatistics.builder()
        .labId(labId)
        .avgTemperature(envStats.getAvgTemperature())
        .avgHumidity(envStats.getAvgHumidity())
        .alarmCount(alarmStats.getTotalCount())
        .reservationCount(personStats.getReservationCount())
        .build();
}
```

**ä¸ºä»€ä¹ˆæ‹†åˆ†æ›´å¿«ï¼Ÿ**
- æ¯æ¡SQLåªå…³è”ä¸€å¼ è¡¨ï¼Œé¿å…å¤šè¡¨JOIN
- æ¯æ¡SQLéƒ½èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œé¿å…å…¨è¡¨æ‰«æ
- MySQLä¼˜åŒ–å™¨æ›´å®¹æ˜“ä¼˜åŒ–ç®€å•SQL

---

**âœ… æ–¹æ¡ˆ2ï¼šæ·»åŠ è”åˆç´¢å¼•**

```sql
-- åˆ†ææŸ¥è¯¢æ¡ä»¶
-- WHERE lab_id = ? AND monitor_time >= ? AND monitor_time < ?

-- åˆ›å»ºè”åˆç´¢å¼•
CREATE INDEX idx_lab_time ON lab_environment_data(lab_id, monitor_time);

-- æ•ˆæœï¼š
-- ä¼˜åŒ–å‰ï¼šå…¨è¡¨æ‰«æ 100ä¸‡è¡Œï¼Œ8ç§’
-- ä¼˜åŒ–åï¼šç´¢å¼•æŸ¥è¯¢ 1000è¡Œï¼Œ0.5ç§’
```

**è”åˆç´¢å¼•è®¾è®¡åŸåˆ™ï¼ˆæœ€å·¦å‰ç¼€ï¼‰ï¼š**
```sql
-- âœ… æ­£ç¡®ï¼šlab_idåœ¨å‰ï¼ˆåŒºåˆ†åº¦é«˜ï¼‰
CREATE INDEX idx_lab_time ON lab_environment_data(lab_id, monitor_time);

-- æŸ¥è¯¢1ï¼šå¯ä»¥ä½¿ç”¨ç´¢å¼•
WHERE lab_id = 1 AND monitor_time >= '2025-11-01'

-- æŸ¥è¯¢2ï¼šå¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼ˆæœ€å·¦å‰ç¼€ï¼‰
WHERE lab_id = 1

-- æŸ¥è¯¢3ï¼šä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼ˆè·³è¿‡äº†lab_idï¼‰
WHERE monitor_time >= '2025-11-01'
```

**æˆ‘ä»¬é¡¹ç›®ä¸­æ·»åŠ çš„ç´¢å¼•ï¼š**
```sql
-- 1. ç¯å¢ƒæ•°æ®è¡¨
ALTER TABLE lab_environment_data
ADD INDEX idx_lab_time (lab_id, monitor_time),
ADD INDEX idx_time (monitor_time);  -- ç”¨äºæ—¶é—´èŒƒå›´æŸ¥è¯¢

-- 2. å‘Šè­¦è¡¨
ALTER TABLE lab_alarm
ADD INDEX idx_lab_time (lab_id, alarm_time),
ADD INDEX idx_level_time (alarm_level, alarm_time);  -- ç”¨äºæŒ‰çº§åˆ«æŸ¥è¯¢

-- 3. æ—¥ç»Ÿè®¡è¡¨
ALTER TABLE lab_daily_statistics
ADD INDEX idx_lab_date (lab_id, stat_date),
ADD INDEX idx_date (stat_date);  -- ç”¨äºæ—¥æœŸèŒƒå›´æŸ¥è¯¢
```

---

**âœ… æ–¹æ¡ˆ3ï¼šè®¡ç®—é€»è¾‘ç§»è‡³Javaå±‚**

```java
// ä¼˜åŒ–å‰ï¼šåœ¨SQLä¸­è®¡ç®—ï¼ˆæ…¢ï¼‰
SELECT
    lab_id,
    AVG(temperature) as avg_temp,
    MAX(temperature) as max_temp,
    MIN(temperature) as min_temp,
    STDDEV(temperature) as std_temp  -- æ ‡å‡†å·®è®¡ç®—å¾ˆæ…¢
FROM lab_environment_data
WHERE lab_id = ? AND monitor_time >= ? AND monitor_time < ?
GROUP BY lab_id;

// ä¼˜åŒ–åï¼šåœ¨Javaä¸­è®¡ç®—ï¼ˆå¿«ï¼‰
// 1. SQLåªæŸ¥è¯¢åŸå§‹æ•°æ®
List<LabEnvironmentData> dataList = labEnvironmentDataMapper.selectList(
    new LambdaQueryWrapper<LabEnvironmentData>()
        .eq(LabEnvironmentData::getLabId, labId)
        .between(LabEnvironmentData::getMonitorTime, startTime, endTime)
);

// 2. Javaè®¡ç®—ç»Ÿè®¡å€¼
DoubleSummaryStatistics stats = dataList.stream()
    .mapToDouble(LabEnvironmentData::getTemperature)
    .summaryStatistics();

BigDecimal avgTemp = BigDecimal.valueOf(stats.getAverage());
BigDecimal maxTemp = BigDecimal.valueOf(stats.getMax());
BigDecimal minTemp = BigDecimal.valueOf(stats.getMin());
```

**ä¸ºä»€ä¹ˆJavaè®¡ç®—æ›´å¿«ï¼Ÿ**
- é¿å…MySQLçš„å¤æ‚è®¡ç®—ï¼ˆGROUP BYã€èšåˆå‡½æ•°ï¼‰
- Javaå¤šçº¿ç¨‹å¹¶è¡Œè®¡ç®—
- æ•°æ®å¯ä»¥ç¼“å­˜åœ¨åº”ç”¨å±‚

---

**âœ… æ–¹æ¡ˆ4ï¼šåˆ†é¡µæŸ¥è¯¢ + æµå¼å¤„ç†**

```java
// ä¼˜åŒ–å‰ï¼šä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼ˆOOMé£é™©ï¼‰
List<LabEnvironmentData> dataList = labEnvironmentDataMapper.selectAll();  // 100ä¸‡æ¡

// ä¼˜åŒ–åï¼šåˆ†é¡µæŸ¥è¯¢ + æµå¼å¤„ç†
int pageSize = 1000;
int pageNum = 1;
while (true) {
    Page<LabEnvironmentData> page = new Page<>(pageNum, pageSize);
    IPage<LabEnvironmentData> result = labEnvironmentDataMapper.selectPage(page, wrapper);

    if (result.getRecords().isEmpty()) {
        break;
    }

    // å¤„ç†å½“å‰æ‰¹æ¬¡æ•°æ®
    processData(result.getRecords());

    pageNum++;
}
```

---

**åœºæ™¯2ï¼šä¸šåŠ¡è®¡ç®—æ…¢ï¼ˆ1ç§’ï¼‰**

**âœ… æ–¹æ¡ˆï¼šå¹¶è¡Œè®¡ç®—ï¼ˆå¤šçº¿ç¨‹ï¼‰**

```java
// ä¼˜åŒ–å‰ï¼šä¸²è¡Œè®¡ç®—
public LabStatistics getStatistics(Long labId) {
    EnvironmentStats envStats = calculateEnvStats(labId);      // 0.3ç§’
    AlarmStats alarmStats = calculateAlarmStats(labId);        // 0.3ç§’
    PersonStats personStats = calculatePersonStats(labId);      // 0.4ç§’
    // æ€»è€—æ—¶ï¼š1ç§’
}

// ä¼˜åŒ–åï¼šå¹¶è¡Œè®¡ç®—ï¼ˆCompletableFutureï¼‰
public LabStatistics getStatistics(Long labId) {
    CompletableFuture<EnvironmentStats> envFuture = CompletableFuture.supplyAsync(
        () -> calculateEnvStats(labId),
        executor
    );

    CompletableFuture<AlarmStats> alarmFuture = CompletableFuture.supplyAsync(
        () -> calculateAlarmStats(labId),
        executor
    );

    CompletableFuture<PersonStats> personFuture = CompletableFuture.supplyAsync(
        () -> calculatePersonStats(labId),
        executor
    );

    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    CompletableFuture.allOf(envFuture, alarmFuture, personFuture).join();

    // ç»„è£…ç»“æœ
    return LabStatistics.builder()
        .envStats(envFuture.join())
        .alarmStats(alarmFuture.join())
        .personStats(personFuture.join())
        .build();
    // æ€»è€—æ—¶ï¼š0.4ç§’ï¼ˆæœ€æ…¢çš„é‚£ä¸ªä»»åŠ¡ï¼‰
}
```

---

**åœºæ™¯3ï¼šRedisæ“ä½œæ…¢ï¼ˆ0.5ç§’ï¼‰**

**âœ… æ–¹æ¡ˆï¼šä½¿ç”¨Pipelineæ‰¹é‡æ“ä½œ**

```java
// ä¼˜åŒ–å‰ï¼šå¤šæ¬¡ç½‘ç»œå¾€è¿”
for (int i = 1; i <= 100; i++) {
    String key = "lab:latest:" + i;
    redisTemplate.opsForValue().get(key);  // 100æ¬¡ç½‘ç»œå¾€è¿”ï¼Œ0.5ç§’
}

// ä¼˜åŒ–åï¼šPipelineæ‰¹é‡æ“ä½œ
List<Object> results = redisTemplate.executePipelined(new RedisCallback<Object>() {
    @Override
    public Object doInRedis(RedisConnection connection) {
        for (int i = 1; i <= 100; i++) {
            String key = "lab:latest:" + i;
            connection.get(key.getBytes());
        }
        return null;
    }
});
// æ€»è€—æ—¶ï¼š0.05ç§’ï¼ˆåªæœ‰1æ¬¡ç½‘ç»œå¾€è¿”ï¼‰
```

---

#### ç¬¬ä¸‰æ­¥ï¼šå¼‚æ­¥å¤„ç† + å®æ—¶æ¨é€ï¼ˆç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼‰

**è¿™å°±æ˜¯ä½ ç®€å†ä¸­æåˆ°çš„é‡ç‚¹ä¼˜åŒ–ï¼**

```java
// monitor-service/src/main/java/com/sewage/monitor/controller/ReportController.java
@PostMapping("/generate")
public Result<Map<String, String>> generateReport(@RequestBody Map<String, String> request) {
    // 1. ç«‹å³è¿”å›taskIdï¼ˆ200mså†…å“åº”ï¼‰
    String taskId = asyncTaskManager.createTask("MANUAL_REPORT");

    // 2. å¼‚æ­¥ç”ŸæˆæŠ¥è¡¨ï¼ˆåå°æ‰§è¡Œï¼Œä¸é˜»å¡ç”¨æˆ·ï¼‰
    scheduledReportService.generateReportAsync(taskId, startDate, endDate);

    // 3. è¿”å›ä»»åŠ¡IDï¼ˆç”¨æˆ·å¯ä»¥è½®è¯¢æˆ–ç­‰å¾…WebSocketæ¨é€ï¼‰
    return Result.success(Map.of(
        "taskId", taskId,
        "message", "æŠ¥è¡¨ç”Ÿæˆä»»åŠ¡å·²æäº¤ï¼Œè¯·ç¨åæŸ¥è¯¢"
    ));
}

// monitor-service/src/main/java/com/sewage/monitor/schedule/ScheduledReportService.java
@Async("reportExecutor")  // åœ¨ç‹¬ç«‹çº¿ç¨‹æ± ä¸­æ‰§è¡Œ
public void generateReportAsync(String taskId, LocalDate startDate, LocalDate endDate) {
    try {
        // 1. æ›´æ–°ä»»åŠ¡çŠ¶æ€
        asyncTaskManager.updateTask(taskId, TaskStatus.PROCESSING, 10, "å¼€å§‹ç”ŸæˆæŠ¥è¡¨");

        // 2. æ‰§è¡Œè€—æ—¶æ“ä½œï¼ˆ2-10ç§’ï¼‰
        byte[] excelBytes = reportExportService.generateDailyStatisticsReport(startDate, endDate);

        // 3. ä¿å­˜æ–‡ä»¶
        String filePath = reportExportService.saveReportToFile(excelBytes, fileName);

        // 4. å®Œæˆä»»åŠ¡
        asyncTaskManager.completeTask(taskId, Map.of("filePath", filePath));

        // 5. ğŸ”¥ æ¨é€WebSocketé€šçŸ¥ï¼ˆç”¨æˆ·å®æ—¶æ”¶åˆ°ï¼‰
        webSocketPushService.pushToAll(Map.of(
            "type", "REPORT_READY",
            "taskId", taskId,
            "fileName", fileName,
            "downloadUrl", "/report/download/" + fileName
        ));

        log.info("âœ… æŠ¥è¡¨ç”ŸæˆæˆåŠŸï¼Œå·²æ¨é€WebSocketé€šçŸ¥");

    } catch (Exception e) {
        asyncTaskManager.failTask(taskId, e.getMessage());
        webSocketPushService.pushToAll(Map.of(
            "type", "REPORT_FAILED",
            "taskId", taskId,
            "error", e.getMessage()
        ));
    }
}
```

**ä¼˜åŒ–æ•ˆæœå¯¹æ¯”ï¼š**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ï¼ˆåŒæ­¥ï¼‰ | ä¼˜åŒ–åï¼ˆå¼‚æ­¥ï¼‰ |
|-----|--------------|--------------|
| æ¥å£å“åº”æ—¶é—´ | 10ç§’ | 200ms âœ… |
| ç”¨æˆ·ä½“éªŒ | ç­‰å¾…10ç§’ | ç«‹å³å“åº” âœ… |
| ç³»ç»Ÿååé‡ | 1ä¸ªè¯·æ±‚/10ç§’ | 50ä¸ªè¯·æ±‚/ç§’ âœ… |
| å¹¶å‘èƒ½åŠ› | 10ä¸ªçº¿ç¨‹ | 100ä¸ªä»»åŠ¡ âœ… |

---

#### ç¬¬å››æ­¥ï¼šç¼“å­˜ä¼˜åŒ–ï¼ˆå‡å°‘é‡å¤è®¡ç®—ï¼‰

**âœ… ä½¿ç”¨Redisç¼“å­˜ç»Ÿè®¡ç»“æœ**

```java
// ä¼˜åŒ–å‰ï¼šæ¯æ¬¡æŸ¥è¯¢éƒ½è®¡ç®—
public LabStatistics getStatistics(Long labId, LocalDate date) {
    return calculateStatistics(labId, date);  // 2ç§’
}

// ä¼˜åŒ–åï¼šå…ˆæŸ¥ç¼“å­˜
public LabStatistics getStatistics(Long labId, LocalDate date) {
    String cacheKey = "statistics:" + labId + ":" + date;

    // 1. æŸ¥è¯¢ç¼“å­˜
    LabStatistics cached = (LabStatistics) redisTemplate.opsForValue().get(cacheKey);
    if (cached != null) {
        log.info("ğŸ¯ ç¼“å­˜å‘½ä¸­ - Key: {}", cacheKey);
        return cached;  // 0.01ç§’
    }

    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œè®¡ç®—
    LabStatistics result = calculateStatistics(labId, date);  // 2ç§’

    // 3. å†™å…¥ç¼“å­˜ï¼ˆè¿‡æœŸæ—¶é—´1å°æ—¶ï¼‰
    redisTemplate.opsForValue().set(cacheKey, result, 1, TimeUnit.HOURS);

    return result;
}
```

**ç¼“å­˜å‘½ä¸­ç‡ï¼š**
- ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼š2ç§’ï¼ˆè®¡ç®—ï¼‰
- åç»­æŸ¥è¯¢ï¼š0.01ç§’ï¼ˆç¼“å­˜ï¼‰
- å‘½ä¸­ç‡ï¼š95%+

---

### å®Œæ•´çš„ä¼˜åŒ–æ€»ç»“ï¼ˆé¢è¯•å›ç­”æ¨¡æ¿ï¼‰

**ğŸ¯ æ ‡å‡†å›ç­”ï¼š**

> "é‡åˆ°æ¥å£æ‰§è¡Œæ—¶é—´è¿‡é•¿çš„é—®é¢˜ï¼Œæˆ‘ä¼šåˆ†å››æ­¥ä¼˜åŒ–ï¼š
>
> **ç¬¬ä¸€æ­¥ï¼šå®šä½ç“¶é¢ˆ**
> - é€šè¿‡æ‹¦æˆªå™¨è®°å½•æ…¢æ¥å£æ—¥å¿—
> - åˆ†æè€—æ—¶åˆ†å¸ƒï¼ˆæ•°æ®åº“ã€Redisã€ä¸šåŠ¡è®¡ç®—ã€ç½‘ç»œï¼‰
> - ä½¿ç”¨MySQLæ…¢æŸ¥è¯¢æ—¥å¿—å®šä½æ…¢SQL
>
> **ç¬¬äºŒæ­¥ï¼šé’ˆå¯¹æ€§ä¼˜åŒ–**
> - æ•°æ®åº“ä¼˜åŒ–ï¼šSQLæ‹†åˆ†ã€æ·»åŠ ç´¢å¼•ã€è®¡ç®—ç§»è‡³Javaå±‚
> - ä¸šåŠ¡ä¼˜åŒ–ï¼šå¹¶è¡Œè®¡ç®—ã€ç®—æ³•ä¼˜åŒ–
> - ç¼“å­˜ä¼˜åŒ–ï¼šä½¿ç”¨Redisç¼“å­˜ç»“æœ
>
> **ç¬¬ä¸‰æ­¥ï¼šå¼‚æ­¥å¤„ç†ï¼ˆæˆ‘ä»¬é¡¹ç›®çš„æ ¸å¿ƒï¼‰**
> - æ¥å£ç«‹å³è¿”å›taskIdï¼ˆ200mså“åº”ï¼‰
> - ä½¿ç”¨@Asyncåœ¨çº¿ç¨‹æ± ä¸­å¼‚æ­¥æ‰§è¡Œè€—æ—¶ä»»åŠ¡
> - é€šè¿‡WebSocketæ¨é€å®æ—¶é€šçŸ¥ç”¨æˆ·ä»»åŠ¡å®Œæˆ
> - ç”¨æˆ·ä½“éªŒä»'ç­‰å¾…10ç§’'æå‡åˆ°'ç«‹å³å“åº”+å®æ—¶é€šçŸ¥'
>
> **ç¬¬å››æ­¥ï¼šæŒç»­ç›‘æ§**
> - Spring Boot Actuatorç›‘æ§æ¥å£æ€§èƒ½
> - æ…¢æ¥å£å‘Šè­¦ï¼ˆè¶…è¿‡3ç§’è‡ªåŠ¨å‘Šè­¦ï¼‰
> - å®šæœŸReviewæ…¢SQLæ—¥å¿—
>
> **æœ€ç»ˆæ•ˆæœï¼š**
> - å…³é”®æŸ¥è¯¢ä»10ç§’ä¼˜åŒ–è‡³2ç§’ï¼ˆSQLä¼˜åŒ–ï¼‰
> - æ¥å£å“åº”æ—¶é—´ä»10ç§’é™è‡³200msï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
> - ç¼“å­˜å‘½ä¸­ç‡95%ï¼ŒæŸ¥è¯¢è€—æ—¶é™è‡³10ms"

---

### â“ 4.2 å¦‚ä½•ä¼˜åŒ–å¤§é‡æ•°æ®çš„å¯¼å‡ºï¼ˆ100ä¸‡æ¡ï¼‰ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**é—®é¢˜åœºæ™¯ï¼š**
- ç”¨æˆ·éœ€è¦å¯¼å‡º100ä¸‡æ¡ç¯å¢ƒç›‘æµ‹æ•°æ®ä¸ºExcel
- åŒæ­¥å¯¼å‡ºä¼šå¯¼è‡´è¶…æ—¶ã€OOMã€ç”¨æˆ·ç­‰å¾…æ—¶é—´è¿‡é•¿

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

**1. å¼‚æ­¥å¯¼å‡º + æ–‡ä»¶ä¸‹è½½**

```java
// 1. æ¥å£ç«‹å³è¿”å›taskId
@PostMapping("/export")
public Result<String> exportData(@RequestBody ExportRequest request) {
    String taskId = asyncTaskManager.createTask("DATA_EXPORT");

    // å¼‚æ­¥æ‰§è¡Œå¯¼å‡º
    exportService.exportAsync(taskId, request);

    return Result.success(taskId);
}

// 2. å¼‚æ­¥å¯¼å‡º
@Async("exportExecutor")
public void exportAsync(String taskId, ExportRequest request) {
    try {
        asyncTaskManager.updateTask(taskId, TaskStatus.PROCESSING, 0, "å¼€å§‹å¯¼å‡º");

        // åˆ†æ‰¹å¯¼å‡ºï¼ˆé¿å…OOMï¼‰
        exportInBatches(taskId, request);

        // å®Œæˆ
        asyncTaskManager.completeTask(taskId, filePath);

        // WebSocketæ¨é€é€šçŸ¥
        webSocketPushService.pushToAll(Map.of(
            "type", "EXPORT_READY",
            "taskId", taskId,
            "downloadUrl", "/export/download/" + fileName
        ));

    } catch (Exception e) {
        asyncTaskManager.failTask(taskId, e.getMessage());
    }
}
```

**2. åˆ†æ‰¹å†™å…¥Excelï¼ˆé¿å…OOMï¼‰**

```java
public void exportInBatches(String taskId, ExportRequest request) throws IOException {
    // åˆ›å»ºExcel
    SXSSFWorkbook workbook = new SXSSFWorkbook(1000);  // å†…å­˜ä¸­åªä¿ç•™1000è¡Œ
    Sheet sheet = workbook.createSheet("ç¯å¢ƒæ•°æ®");

    // å†™å…¥è¡¨å¤´
    writeHeader(sheet);

    // åˆ†æ‰¹æŸ¥è¯¢å¹¶å†™å…¥
    int pageSize = 10000;  // æ¯æ‰¹1ä¸‡æ¡
    int pageNum = 1;
    int rowNum = 1;
    int totalRows = 0;

    while (true) {
        // æŸ¥è¯¢ä¸€æ‰¹æ•°æ®
        Page<LabEnvironmentData> page = new Page<>(pageNum, pageSize);
        IPage<LabEnvironmentData> result = labEnvironmentDataMapper.selectPage(page, buildWrapper(request));

        if (result.getRecords().isEmpty()) {
            break;
        }

        // å†™å…¥Excel
        for (LabEnvironmentData data : result.getRecords()) {
            Row row = sheet.createRow(rowNum++);
            writeRow(row, data);
            totalRows++;
        }

        // æ›´æ–°è¿›åº¦
        int progress = (int) ((pageNum * pageSize * 100.0) / result.getTotal());
        asyncTaskManager.updateTask(taskId, TaskStatus.PROCESSING, progress,
            "å·²å¯¼å‡º " + totalRows + " æ¡æ•°æ®");

        pageNum++;
    }

    // ä¿å­˜æ–‡ä»¶
    String fileName = "ç¯å¢ƒæ•°æ®_" + System.currentTimeMillis() + ".xlsx";
    String filePath = "exports/" + fileName;
    try (FileOutputStream fos = new FileOutputStream(filePath)) {
        workbook.write(fos);
    }
    workbook.dispose();  // é‡Šæ”¾ä¸´æ—¶æ–‡ä»¶

    log.info("âœ… å¯¼å‡ºå®Œæˆ - æ–‡ä»¶: {}, è¡Œæ•°: {}", fileName, totalRows);
}
```

**3. ä½¿ç”¨SXSSFWorkbookï¼ˆä½å†…å­˜æ¨¡å¼ï¼‰**

```java
// âŒ é”™è¯¯ï¼šXSSFWorkbookä¼šæŠŠæ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜
XSSFWorkbook workbook = new XSSFWorkbook();  // OOMï¼

// âœ… æ­£ç¡®ï¼šSXSSFWorkbookæ˜¯æµå¼å†™å…¥
SXSSFWorkbook workbook = new SXSSFWorkbook(1000);  // å†…å­˜ä¸­åªä¿ç•™1000è¡Œ
// è¶…è¿‡1000è¡Œçš„æ•°æ®ä¼šå†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œé¿å…OOM
```

**4. å‹ç¼©å¤§æ–‡ä»¶**

```java
// å¦‚æœæ–‡ä»¶å¾ˆå¤§ï¼ˆ>10MBï¼‰ï¼Œå‹ç¼©åå†ä¸‹è½½
File excelFile = new File(filePath);
String zipPath = filePath.replace(".xlsx", ".zip");

try (ZipOutputStream zos = new ZipOutputStream(new FileOutputStream(zipPath))) {
    ZipEntry entry = new ZipEntry(fileName);
    zos.putNextEntry(entry);

    Files.copy(excelFile.toPath(), zos);
    zos.closeEntry();
}

// åˆ é™¤åŸExcelæ–‡ä»¶
excelFile.delete();
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- å†…å­˜å ç”¨ï¼šä»2GBé™è‡³100MB
- å¯¼å‡ºé€Ÿåº¦ï¼š100ä¸‡æ¡æ•°æ®ï¼Œ15ç§’å®Œæˆ
- ç”¨æˆ·ä½“éªŒï¼šå¼‚æ­¥å¯¼å‡º+è¿›åº¦æ¨é€

---

### â“ 4.3 å¦‚ä½•å®šä½å’Œè§£å†³å†…å­˜æ³„æ¼é—®é¢˜ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**é—®é¢˜è¡¨ç°ï¼š**
- åº”ç”¨è¿è¡Œä¸€æ®µæ—¶é—´åå˜æ…¢
- Full GCé¢‘ç¹
- æœ€ç»ˆOOMï¼ˆOutOfMemoryErrorï¼‰

**æ’æŸ¥æ­¥éª¤ï¼š**

**1. ä½¿ç”¨JVMå‚æ•°ç”ŸæˆHeap Dump**

```bash
# å¯åŠ¨å‚æ•°
java -jar app.jar \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/logs/heapdump.hprof \
  -XX:+PrintGCDetails \
  -XX:+PrintGCDateStamps
```

**2. ä½¿ç”¨MATåˆ†æHeap Dump**

ä¸‹è½½Eclipse MATï¼ˆMemory Analyzer Toolï¼‰ï¼š

```
File -> Open Heap Dump -> heapdump.hprof

æŸ¥çœ‹ï¼š
1. Leak Suspectsï¼ˆç–‘ä¼¼æ³„æ¼ï¼‰
2. Dominator Treeï¼ˆæ”¯é…æ ‘ï¼‰
3. Histogramï¼ˆå¯¹è±¡ç›´æ–¹å›¾ï¼‰
```

**å¸¸è§å†…å­˜æ³„æ¼åŸå› ï¼š**

**åŸå› 1ï¼šThreadLocalæœªæ¸…ç†**

```java
// âŒ é—®é¢˜ä»£ç 
@Component
public class UserInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        UserContext.setUserId(123L);
        return true;
    }
    // æ²¡æœ‰æ¸…ç†ThreadLocalï¼
}

// âœ… ä¿®å¤
@Override
public void afterCompletion(HttpServletRequest request, HttpServletResponse response,
                            Object handler, Exception ex) {
    UserContext.clear();  // å¿…é¡»æ¸…ç†
}
```

**åŸå› 2ï¼šé™æ€é›†åˆæŒæœ‰å¤§å¯¹è±¡**

```java
// âŒ é—®é¢˜ä»£ç 
public class CacheManager {
    private static final Map<String, LabEnvironmentData> CACHE = new HashMap<>();

    public void cache(String key, LabEnvironmentData data) {
        CACHE.put(key, data);  // æ— é™å¢é•¿ï¼Œæ°¸ä¸é‡Šæ”¾
    }
}

// âœ… ä¿®å¤ï¼šä½¿ç”¨LRUç¼“å­˜
public class CacheManager {
    private static final int MAX_SIZE = 1000;

    private static final Map<String, LabEnvironmentData> CACHE =
        new LinkedHashMap<String, LabEnvironmentData>(MAX_SIZE, 0.75f, true) {
            @Override
            protected boolean removeEldestEntry(Map.Entry eldest) {
                return size() > MAX_SIZE;  // è¶…è¿‡1000æ¡è‡ªåŠ¨åˆ é™¤æœ€è€çš„
            }
        };
}

// æ›´å¥½çš„æ–¹æ¡ˆï¼šä½¿ç”¨Caffeineç¼“å­˜
private static final Cache<String, LabEnvironmentData> CACHE = Caffeine.newBuilder()
    .maximumSize(1000)
    .expireAfterWrite(10, TimeUnit.MINUTES)
    .build();
```

**åŸå› 3ï¼šæ•°æ®åº“è¿æ¥æœªå…³é—­**

```java
// âŒ é—®é¢˜ä»£ç 
public List<User> getUsers() {
    Connection conn = dataSource.getConnection();
    Statement stmt = conn.createStatement();
    ResultSet rs = stmt.executeQuery("SELECT * FROM user");
    // æ²¡æœ‰å…³é—­è¿æ¥ï¼
}

// âœ… ä¿®å¤ï¼šä½¿ç”¨try-with-resources
public List<User> getUsers() {
    try (Connection conn = dataSource.getConnection();
         Statement stmt = conn.createStatement();
         ResultSet rs = stmt.executeQuery("SELECT * FROM user")) {
        // è‡ªåŠ¨å…³é—­
    }
}
```

**åŸå› 4ï¼šç›‘å¬å™¨æœªæ³¨é”€**

```java
// âŒ é—®é¢˜ä»£ç 
public class EventPublisher {
    private List<EventListener> listeners = new ArrayList<>();

    public void addListener(EventListener listener) {
        listeners.add(listener);  // æ°¸ä¸åˆ é™¤
    }
}

// âœ… ä¿®å¤ï¼šä½¿ç”¨WeakReference
public class EventPublisher {
    private List<WeakReference<EventListener>> listeners = new ArrayList<>();

    public void addListener(EventListener listener) {
        listeners.add(new WeakReference<>(listener));
    }

    public void fireEvent(Event event) {
        // æ¸…ç†å·²å›æ”¶çš„ç›‘å¬å™¨
        listeners.removeIf(ref -> ref.get() == null);

        for (WeakReference<EventListener> ref : listeners) {
            EventListener listener = ref.get();
            if (listener != null) {
                listener.onEvent(event);
            }
        }
    }
}
```

**æˆ‘ä»¬é¡¹ç›®ä¸­é‡åˆ°çš„çœŸå®æ¡ˆä¾‹ï¼š**

> WebSocketè¿æ¥æœªæ¸…ç†å¯¼è‡´å†…å­˜æ³„æ¼ã€‚æ¯ä¸ªè¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªSessionå¯¹è±¡ï¼Œå¦‚æœè¿æ¥æ–­å¼€æ—¶æ²¡æœ‰ä»é›†åˆä¸­ç§»é™¤ï¼Œå°±ä¼šä¸€ç›´å ç”¨å†…å­˜ã€‚

```java
// ä¿®å¤å‰
@OnClose
public void onClose() {
    // åªæ‰“å°æ—¥å¿—ï¼Œæ²¡æœ‰æ¸…ç†
    log.info("è¿æ¥å…³é—­");
}

// ä¿®å¤å
@OnClose
public void onClose() {
    webSocketSet.remove(this);  // ä»é›†åˆä¸­ç§»é™¤
    subOnlineCount();
    UserContext.clear();  // æ¸…ç†ThreadLocal
    log.info("è¿æ¥å…³é—­ï¼Œå·²æ¸…ç†èµ„æº");
}
```

---

### â“ 4.4 å¦‚ä½•ä¼˜åŒ–é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**åœºæ™¯ï¼š**
- å®éªŒå®¤ä¼ æ„Ÿå™¨æ¯ç§’ä¸ŠæŠ¥100æ¬¡æ•°æ®
- å¤šä¸ªå®éªŒå®¤åŒæ—¶ä¸ŠæŠ¥ï¼ŒQPSè¾¾åˆ°1000+
- éœ€è¦ä¿è¯ä½å»¶è¿Ÿã€é«˜å¯ç”¨

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

**1. Kafkaå¼‚æ­¥è§£è€¦ï¼ˆæˆ‘ä»¬é¡¹ç›®çš„æ ¸å¿ƒï¼‰**

```java
// ä¼˜åŒ–å‰ï¼šåŒæ­¥å¤„ç†ï¼ˆé˜»å¡ï¼‰
@PostMapping("/data/upload")
public Result<Void> uploadData(@RequestBody LabEnvironmentData data) {
    // 1. ä¿å­˜æ•°æ®åº“ï¼ˆ100msï¼‰
    labEnvironmentDataMapper.insert(data);

    // 2. å‘Šè­¦æ£€æŸ¥ï¼ˆ50msï¼‰
    alarmService.checkAlarm(data);

    // 3. æ›´æ–°ç»Ÿè®¡ï¼ˆ50msï¼‰
    statisticsService.updateStats(data);

    // æ€»è€—æ—¶ï¼š200ms
    // QPSä¸Šé™ï¼š5æ¬¡/ç§’ï¼ˆå•çº¿ç¨‹ï¼‰
    return Result.success();
}

// ä¼˜åŒ–åï¼šå¼‚æ­¥å¤„ç†ï¼ˆéé˜»å¡ï¼‰
@PostMapping("/data/upload")
public Result<Void> uploadData(@RequestBody LabEnvironmentData data) {
    // 1. å‘é€åˆ°Kafkaï¼ˆ5msï¼‰
    labEnvironmentProducer.sendData(data);

    // ç«‹å³è¿”å›
    return Result.success();
    // QPSä¸Šé™ï¼š200æ¬¡/ç§’ï¼ˆæå‡40å€ï¼‰
}

// Kafkaæ¶ˆè´¹è€…å¼‚æ­¥å¤„ç†
@KafkaListener(topics = "lab-environment-data", concurrency = "3")
public void consume(String message) {
    LabEnvironmentData data = JSON.parseObject(message, LabEnvironmentData.class);

    // 1. ä¿å­˜æ•°æ®åº“
    labEnvironmentDataMapper.insert(data);

    // 2. å‘Šè­¦æ£€æŸ¥
    alarmService.checkAlarm(data);

    // 3. æ›´æ–°ç»Ÿè®¡
    statisticsService.updateStats(data);
}
```

**æ•ˆæœï¼š**
- æ¥å£å“åº”æ—¶é—´ï¼šä»200msé™è‡³5ms
- ååé‡ï¼šä»5 QPSæå‡è‡³200 QPS
- å‰Šå³°å¡«è°·ï¼šKafkaç¼“å†²çªå‘æµé‡

---

**2. Redisç¼“å­˜çƒ­ç‚¹æ•°æ®**

```java
// ä¼˜åŒ–å‰ï¼šæ¯æ¬¡æŸ¥è¯¢æ•°æ®åº“
public LabEnvironmentData getLatestData(Long labId) {
    return labEnvironmentDataMapper.selectLatest(labId);  // 50ms
}

// ä¼˜åŒ–åï¼šRedisç¼“å­˜
public LabEnvironmentData getLatestData(Long labId) {
    String key = "lab:latest:" + labId;

    // 1. æŸ¥è¯¢ç¼“å­˜
    LabEnvironmentData cached = (LabEnvironmentData) redisTemplate.opsForValue().get(key);
    if (cached != null) {
        return cached;  // 1ms
    }

    // 2. æŸ¥è¯¢æ•°æ®åº“
    LabEnvironmentData data = labEnvironmentDataMapper.selectLatest(labId);

    // 3. å†™å…¥ç¼“å­˜ï¼ˆ30ç§’è¿‡æœŸï¼‰
    redisTemplate.opsForValue().set(key, data, 30, TimeUnit.SECONDS);

    return data;
}
```

**ç¼“å­˜æ›´æ–°ç­–ç•¥ï¼š**
```java
// æ•°æ®ä¸ŠæŠ¥æ—¶æ›´æ–°ç¼“å­˜
public void saveData(LabEnvironmentData data) {
    // 1. ä¿å­˜æ•°æ®åº“
    labEnvironmentDataMapper.insert(data);

    // 2. æ›´æ–°ç¼“å­˜
    String key = "lab:latest:" + data.getLabId();
    redisTemplate.opsForValue().set(key, data, 30, TimeUnit.SECONDS);

    // 3. æ¨é€WebSocket
    webSocketPushService.pushEnvironmentData(data);
}
```

---

**3. æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–**

```yaml
# application.yml
spring:
  datasource:
    hikari:
      # è¿æ¥æ± é…ç½®
      minimum-idle: 10           # æœ€å°ç©ºé—²è¿æ¥
      maximum-pool-size: 50      # æœ€å¤§è¿æ¥æ•°
      connection-timeout: 30000  # è¿æ¥è¶…æ—¶30ç§’
      idle-timeout: 600000       # ç©ºé—²è¶…æ—¶10åˆ†é’Ÿ
      max-lifetime: 1800000      # æœ€å¤§ç”Ÿå‘½å‘¨æœŸ30åˆ†é’Ÿ

      # æ€§èƒ½ä¼˜åŒ–
      connection-test-query: SELECT 1  # è¿æ¥æµ‹è¯•æŸ¥è¯¢
      validation-timeout: 3000         # éªŒè¯è¶…æ—¶3ç§’
```

**ä¸ºä»€ä¹ˆç”¨HikariCPï¼Ÿ**
- æ€§èƒ½æœ€å¥½çš„Javaè¿æ¥æ± 
- Spring Boot 2.xé»˜è®¤è¿æ¥æ± 
- æ¯”Druidå¿«10%-20%

---

**4. çº¿ç¨‹æ± ä¼˜åŒ–**

```java
// monitor-service/src/main/java/com/sewage/monitor/config/AsyncConfig.java
@Bean("statisticsExecutor")
public Executor statisticsExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();

    // æ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•°
    executor.setCorePoolSize(Runtime.getRuntime().availableProcessors());

    // æœ€å¤§çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° * 2
    executor.setMaxPoolSize(Runtime.getRuntime().availableProcessors() * 2);

    // é˜Ÿåˆ—å®¹é‡
    executor.setQueueCapacity(100);

    // æ‹’ç»ç­–ç•¥ï¼šCallerRunsPolicyï¼ˆè°ƒç”¨çº¿ç¨‹æ‰§è¡Œï¼‰
    executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());

    executor.initialize();
    return executor;
}
```

**çº¿ç¨‹æ± å¤§å°å¦‚ä½•ç¡®å®šï¼Ÿ**
- **CPUå¯†é›†å‹**ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° + 1
- **IOå¯†é›†å‹**ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° * 2
- **æˆ‘ä»¬é¡¹ç›®**ï¼šæ•°æ®åº“æ“ä½œä¸ºä¸»ï¼Œå±äºIOå¯†é›†å‹

---

**5. æ‰¹é‡æ“ä½œ**

```java
// ä¼˜åŒ–å‰ï¼šå¾ªç¯æ’å…¥
for (LabEnvironmentData data : dataList) {
    labEnvironmentDataMapper.insert(data);  // 100æ¬¡æ•°æ®åº“æ“ä½œ
}

// ä¼˜åŒ–åï¼šæ‰¹é‡æ’å…¥
labEnvironmentDataMapper.insertBatch(dataList);  // 1æ¬¡æ•°æ®åº“æ“ä½œ

// MyBatis-Plusæ‰¹é‡æ’å…¥
public void saveBatch(List<LabEnvironmentData> dataList) {
    this.saveBatch(dataList, 1000);  // æ¯æ‰¹1000æ¡
}
```

---

### â“ 4.5 JVMå‚æ•°å¦‚ä½•è°ƒä¼˜ï¼ŸG1å›æ”¶å™¨çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**æˆ‘ä»¬é¡¹ç›®çš„JVMå‚æ•°é…ç½®ï¼š**

```bash
# å¯åŠ¨è„šæœ¬
java -jar monitor-service.jar \
  # å †å†…å­˜è®¾ç½®
  -Xms2g \              # åˆå§‹å †å¤§å°2GB
  -Xmx2g \              # æœ€å¤§å †å¤§å°2GBï¼ˆä¸Xmsç›¸åŒï¼Œé¿å…åŠ¨æ€æ‰©å®¹ï¼‰

  # ä½¿ç”¨G1å›æ”¶å™¨
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \     # æœ€å¤§GCåœé¡¿æ—¶é—´200ms
  -XX:G1HeapRegionSize=16m \     # G1 Regionå¤§å°16MB
  -XX:InitiatingHeapOccupancyPercent=45 \  # å †å ç”¨45%æ—¶è§¦å‘å¹¶å‘æ ‡è®°

  # GCæ—¥å¿—
  -XX:+PrintGCDetails \
  -XX:+PrintGCDateStamps \
  -Xloggc:/logs/gc.log \

  # OOMæ—¶ç”ŸæˆHeap Dump
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/logs/heapdump.hprof
```

---

**ä¸ºä»€ä¹ˆä½¿ç”¨G1å›æ”¶å™¨ï¼Ÿ**

**å¯¹æ¯”è¡¨æ ¼ï¼š**

| GCå›æ”¶å™¨ | åœé¡¿æ—¶é—´ | ååé‡ | é€‚ç”¨åœºæ™¯ |
|---------|---------|--------|---------|
| **Serial** | é•¿ | ä½ | å•æ ¸CPUã€å°å†…å­˜ |
| **Parallel** | é•¿ | é«˜ | å¤šæ ¸CPUã€åå°ä»»åŠ¡ |
| **CMS** | çŸ­ | ä¸­ | å“åº”æ—¶é—´ä¼˜å…ˆã€å¤§å † |
| **G1** | å¯é¢„æµ‹ | é«˜ | å¤§å †ï¼ˆ>4GBï¼‰ã€å“åº”æ—¶é—´è¦æ±‚é«˜ |
| **ZGC** | æçŸ­(<10ms) | é«˜ | è¶…å¤§å †ï¼ˆ>100GBï¼‰ã€æä½å»¶è¿Ÿ |

**G1çš„ä¼˜åŠ¿ï¼ˆæˆ‘ä»¬é¡¹ç›®é€‰æ‹©å®ƒçš„åŸå› ï¼‰ï¼š**

**1. åœé¡¿æ—¶é—´å¯é¢„æµ‹**
```bash
-XX:MaxGCPauseMillis=200  # ç›®æ ‡åœé¡¿æ—¶é—´200ms
```
- G1ä¼šå°½é‡æ»¡è¶³è¿™ä¸ªç›®æ ‡
- CMSæ— æ³•ä¿è¯åœé¡¿æ—¶é—´

**2. ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡**
- G1ä½¿ç”¨**å¤åˆ¶ç®—æ³•**ï¼Œæ²¡æœ‰ç¢ç‰‡
- CMSä½¿ç”¨**æ ‡è®°-æ¸…é™¤**ï¼Œä¼šäº§ç”Ÿç¢ç‰‡

**3. åˆ†ä»£æ”¶é›† + å¹¶å‘æ ‡è®°**
```
G1å†…å­˜å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Heap (2GB)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Regionâ”‚Regionâ”‚Regionâ”‚Regionâ”‚Regionâ”‚...â”‚ â”‚
â”‚  â”‚ Eden â”‚ Eden â”‚Survivorâ”‚Oldâ”‚Oldâ”‚...â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªRegion = 16MBï¼ˆå¯é…ç½®1MB-32MBï¼‰
G1ä¼šä¼˜å…ˆå›æ”¶åƒåœ¾æœ€å¤šçš„Regionï¼ˆGarbage Firstï¼‰
```

**4. å¹¶å‘æ ‡è®°å‡å°‘STW**
```
G1 GCæµç¨‹ï¼š
1. åˆå§‹æ ‡è®°ï¼ˆSTWï¼‰          â† å¾ˆçŸ­ï¼Œåªæ ‡è®°GC Roots
2. å¹¶å‘æ ‡è®°ï¼ˆConcurrentï¼‰   â† ä¸åœé¡¿ï¼Œä¸åº”ç”¨å¹¶å‘æ‰§è¡Œ
3. æœ€ç»ˆæ ‡è®°ï¼ˆSTWï¼‰          â† å¾ˆçŸ­ï¼Œå¤„ç†å¹¶å‘æ ‡è®°é—æ¼çš„å¯¹è±¡
4. ç­›é€‰å›æ”¶ï¼ˆSTWï¼‰          â† å›æ”¶åƒåœ¾æœ€å¤šçš„Region
```

---

**ä¼˜åŒ–å‰åå¯¹æ¯”ï¼ˆæˆ‘ä»¬é¡¹ç›®çš„çœŸå®æ•°æ®ï¼‰ï¼š**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ï¼ˆParallel GCï¼‰ | ä¼˜åŒ–åï¼ˆG1 GCï¼‰ |
|-----|---------------------|----------------|
| Full GCæ¬¡æ•° | æ¯å°æ—¶5æ¬¡ | æ¯å¤©1æ¬¡ âœ… |
| GCåœé¡¿æ—¶é—´ | 500ms-2s | 100ms-200ms âœ… |
| ååé‡ | 95% | 98% âœ… |
| å †å†…å­˜ | 4GB | 2GB âœ… |

**è°ƒä¼˜è¿‡ç¨‹ï¼š**

**é—®é¢˜1ï¼šFull GCé¢‘ç¹**
```bash
# åŸå› ï¼šå †å†…å­˜å¤ªå°
# è§£å†³ï¼šå¢å¤§å †å†…å­˜
-Xms1g -Xmx1g  â†’  -Xms2g -Xmx2g
```

**é—®é¢˜2ï¼šGCåœé¡¿æ—¶é—´é•¿**
```bash
# åŸå› ï¼šç›®æ ‡åœé¡¿æ—¶é—´è®¾ç½®è¿‡çŸ­
# è§£å†³ï¼šè°ƒæ•´ç›®æ ‡åœé¡¿æ—¶é—´
-XX:MaxGCPauseMillis=50  â†’  -XX:MaxGCPauseMillis=200
```

**é—®é¢˜3ï¼šè€å¹´ä»£å ç”¨è¿‡é«˜**
```bash
# åŸå› ï¼šå¹¶å‘æ ‡è®°é˜ˆå€¼è¿‡é«˜
# è§£å†³ï¼šé™ä½é˜ˆå€¼ï¼Œæå‰è§¦å‘å¹¶å‘æ ‡è®°
-XX:InitiatingHeapOccupancyPercent=75  â†’  -XX:InitiatingHeapOccupancyPercent=45
```

---

**GCæ—¥å¿—åˆ†æï¼š**

```bash
# æŸ¥çœ‹GCæ—¥å¿—
tail -f /logs/gc.log

# ç¤ºä¾‹æ—¥å¿—
[GC pause (G1 Evacuation Pause) (young), 0.0234567 secs]
   [Parallel Time: 18.5 ms]
   [Eden: 512.0M(512.0M)->0.0B(480.0M) Survivors: 32.0M->64.0M Heap: 1024.0M(2048.0M)->544.0M(2048.0M)]

è§£è¯»ï¼š
- youngï¼šå¹´è½»ä»£GC
- 0.0234567 secsï¼šåœé¡¿23ms
- Eden: 512M â†’ 0ï¼šå›æ”¶äº†512MB
- Heap: 1024M â†’ 544Mï¼šå †ä»1GBé™è‡³544MB
```

---

## äº”ã€WebSocket å®æ—¶é€šä¿¡

### â“ 5.1 ã€æ ¸å¿ƒé—®é¢˜ã€‘WebSocketæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿè¯·è¯¦ç»†è¯´æ˜ã€‚

**ğŸ¯ é¢è¯•å®˜è¿½é—®ï¼š**
> "ä½ ç®€å†ä¸Šå†™äº†ä½¿ç”¨WebSocketæ¨é€å®æ—¶æ•°æ®ï¼Œå…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿä»è¿æ¥å»ºç«‹åˆ°æ¶ˆæ¯æ¨é€çš„å®Œæ•´æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ"

**ğŸ’¡ å®Œæ•´å›ç­”ï¼ˆè¿™å°±æ˜¯ä½ é¢è¯•æ—¶éœ€è¦è¯´çš„ï¼‰ï¼š**

---

#### WebSocket vs HTTP å¯¹æ¯”

**HTTPï¼ˆä¼ ç»Ÿè½®è¯¢ï¼‰ï¼š**
```
å®¢æˆ·ç«¯                      æœåŠ¡ç«¯
  â”‚                          â”‚
  â”œâ”€ 1. è¯·æ±‚ï¼šæœ‰æ–°æ•°æ®å—ï¼Ÿ â”€â”€â–ºâ”‚
  â”‚â—„â”€ å“åº”ï¼šæ²¡æœ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                          â”‚
  â”œâ”€ 2. è¯·æ±‚ï¼šæœ‰æ–°æ•°æ®å—ï¼Ÿ â”€â”€â–ºâ”‚
  â”‚â—„â”€ å“åº”ï¼šæ²¡æœ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                          â”‚
  â”œâ”€ 3. è¯·æ±‚ï¼šæœ‰æ–°æ•°æ®å—ï¼Ÿ â”€â”€â–ºâ”‚
  â”‚â—„â”€ å“åº”ï¼šæœ‰ï¼Œè¿”å›æ•°æ® â”€â”€â”€â”€â”¤

ç¼ºç‚¹ï¼š
- é¢‘ç¹è¯·æ±‚æµªè´¹å¸¦å®½
- æœ‰å»¶è¿Ÿï¼ˆè½®è¯¢é—´éš”ï¼‰
- æœåŠ¡å™¨å‹åŠ›å¤§
```

**WebSocketï¼ˆé•¿è¿æ¥ï¼‰ï¼š**
```
å®¢æˆ·ç«¯                      æœåŠ¡ç«¯
  â”‚                          â”‚
  â”œâ”€ 1. æ¡æ‰‹ï¼ˆHTTP Upgradeï¼‰â”€â–ºâ”‚
  â”‚â—„â”€ æ¡æ‰‹å“åº” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                          â”‚
  â”‚ â•â•â•â•â•â• è¿æ¥ä¿æŒ â•â•â•â•â•â•â•â•â•â•â”‚
  â”‚                          â”‚
  â”‚â—„â”€ 2. ä¸»åŠ¨æ¨é€æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚â—„â”€ 3. ä¸»åŠ¨æ¨é€æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚â—„â”€ 4. ä¸»åŠ¨æ¨é€æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”¤

ä¼˜ç‚¹ï¼š
- å…¨åŒå·¥é€šä¿¡ï¼ˆæœåŠ¡ç«¯å¯ä¸»åŠ¨æ¨é€ï¼‰
- ä½å»¶è¿Ÿï¼ˆå®æ—¶ï¼‰
- å‡å°‘HTTPè¯·æ±‚å¼€é”€
```

---

#### æˆ‘ä»¬é¡¹ç›®çš„WebSocketå®ç°

**æ¶æ„å›¾ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯é¡µé¢                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ const ws = new WebSocket(                         â”‚  â”‚
â”‚  â”‚   'ws://localhost:8080/ws/realtime/1'             â”‚  â”‚
â”‚  â”‚ );                                                â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚ ws.onmessage = (event) => {                       â”‚  â”‚
â”‚  â”‚   const message = JSON.parse(event.data);         â”‚  â”‚
â”‚  â”‚   // å¤„ç†æ¶ˆæ¯                                      â”‚  â”‚
â”‚  â”‚ };                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“ WebSocketè¿æ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Gatewayï¼ˆç½‘å…³å±‚ï¼‰                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ WebSocketè·¯ç”±é…ç½®                                  â”‚  â”‚
â”‚  â”‚ /ws/** â†’ ws://monitor-service                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“ è½¬å‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Monitor Serviceï¼ˆç›‘æ§æœåŠ¡ï¼‰                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ @ServerEndpoint("/ws/realtime/{labId}") â”‚           â”‚
â”‚  â”‚ public class WebSocketServer {          â”‚           â”‚
â”‚  â”‚                                         â”‚           â”‚
â”‚  â”‚   @OnOpen  â†’ è¿æ¥å»ºç«‹                   â”‚           â”‚
â”‚  â”‚   @OnMessage â†’ æ¥æ”¶æ¶ˆæ¯                 â”‚           â”‚
â”‚  â”‚   @OnClose â†’ è¿æ¥å…³é—­                   â”‚           â”‚
â”‚  â”‚   @OnError â†’ é”™è¯¯å¤„ç†                   â”‚           â”‚
â”‚  â”‚                                         â”‚           â”‚
â”‚  â”‚   // ç®¡ç†æ‰€æœ‰è¿æ¥                        â”‚           â”‚
â”‚  â”‚   static Set<WebSocketServer> clients;  â”‚           â”‚
â”‚  â”‚ }                                       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                         â”‚
â”‚  æ¶ˆæ¯æ¨é€è§¦å‘ç‚¹ï¼š                                        â”‚
â”‚  â”œâ”€ Kafkaæ¶ˆè´¹è€…æ”¶åˆ°æ•°æ® â†’ æ¨é€ç¯å¢ƒæ•°æ®                   â”‚
â”‚  â”œâ”€ å‘Šè­¦æ£€æŸ¥è§¦å‘ â†’ æ¨é€å‘Šè­¦                              â”‚
â”‚  â””â”€ æŠ¥è¡¨ç”Ÿæˆå®Œæˆ â†’ æ¨é€é€šçŸ¥                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### å®Œæ•´çš„ä»£ç å®ç°

**1. WebSocketæœåŠ¡ç«¯ï¼ˆæ ¸å¿ƒï¼‰**

```java
// monitor-service/src/main/java/com/sewage/monitor/websocket/WebSocketServer.java
@Slf4j
@Component
@ServerEndpoint("/ws/realtime/{labId}")  // WebSocketç«¯ç‚¹
public class WebSocketServer {

    // é™æ€å˜é‡ï¼šå­˜å‚¨æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
    private static CopyOnWriteArraySet<WebSocketServer> webSocketSet = new CopyOnWriteArraySet<>();

    // å½“å‰è¿æ¥çš„Session
    private Session session;

    // å®éªŒå®¤IDï¼ˆä»è·¯å¾„å‚æ•°è·å–ï¼‰
    private Long labId;

    /**
     * è¿æ¥å»ºç«‹æˆåŠŸè°ƒç”¨
     *
     * æµç¨‹ï¼š
     * 1. å‰ç«¯ï¼šnew WebSocket('ws://localhost:8080/ws/realtime/1')
     * 2. æœåŠ¡ç«¯ï¼šè§¦å‘@OnOpenæ–¹æ³•
     * 3. ä¿å­˜è¿æ¥åˆ°é›†åˆä¸­
     */
    @OnOpen
    public void onOpen(Session session, @PathParam("labId") Long labId) {
        this.session = session;
        this.labId = labId;

        // åŠ å…¥é›†åˆ
        webSocketSet.add(this);

        log.info("âœ… WebSocketè¿æ¥å»ºç«‹ - å®éªŒå®¤ID: {}, å½“å‰åœ¨çº¿: {} äºº",
            labId, webSocketSet.size());

        // å‘é€è¿æ¥æˆåŠŸæ¶ˆæ¯
        try {
            sendMessage(JSON.toJSONString(Map.of(
                "type", "CONNECTION",
                "message", "è¿æ¥æˆåŠŸ",
                "labId", labId,
                "timestamp", System.currentTimeMillis()
            )));
        } catch (IOException e) {
            log.error("å‘é€è¿æ¥æˆåŠŸæ¶ˆæ¯å¤±è´¥", e);
        }
    }

    /**
     * è¿æ¥å…³é—­è°ƒç”¨
     */
    @OnClose
    public void onClose() {
        // ä»é›†åˆä¸­ç§»é™¤
        webSocketSet.remove(this);

        log.info("âŒ WebSocketè¿æ¥å…³é—­ - å®éªŒå®¤ID: {}, å½“å‰åœ¨çº¿: {} äºº",
            labId, webSocketSet.size());
    }

    /**
     * æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯
     * ï¼ˆæˆ‘ä»¬é¡¹ç›®ä¸»è¦æ˜¯æœåŠ¡ç«¯æ¨é€ï¼Œå®¢æˆ·ç«¯å¾ˆå°‘å‘æ¶ˆæ¯ï¼‰
     */
    @OnMessage
    public void onMessage(String message, Session session) {
        log.info("ğŸ“¨ æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ - å®éªŒå®¤ID: {}, æ¶ˆæ¯: {}", labId, message);

        // å¯ä»¥å¤„ç†å®¢æˆ·ç«¯å‘½ä»¤ï¼Œæ¯”å¦‚è®¢é˜…/å–æ¶ˆè®¢é˜…
    }

    /**
     * å‘ç”Ÿé”™è¯¯
     */
    @OnError
    public void onError(Session session, Throwable error) {
        log.error("âŒ WebSocketé”™è¯¯ - å®éªŒå®¤ID: {}", labId, error);
    }

    /**
     * å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
     */
    public void sendMessage(String message) throws IOException {
        this.session.getBasicRemote().sendText(message);
    }

    /**
     * æ¨é€ç¯å¢ƒæ•°æ®ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰
     *
     * è°ƒç”¨æ—¶æœºï¼šKafkaæ¶ˆè´¹è€…æ”¶åˆ°ç¯å¢ƒæ•°æ®
     */
    public static void pushEnvironmentData(LabEnvironmentData data) {
        String message = JSON.toJSONString(Map.of(
            "type", "ENVIRONMENT_DATA",
            "labId", data.getLabId(),
            "data", data,
            "timestamp", System.currentTimeMillis()
        ));

        // åªæ¨é€ç»™è®¢é˜…äº†è¯¥å®éªŒå®¤çš„å®¢æˆ·ç«¯
        for (WebSocketServer client : webSocketSet) {
            if (client.labId.equals(data.getLabId())) {
                try {
                    client.sendMessage(message);
                    log.debug("ğŸ“¤ æ¨é€ç¯å¢ƒæ•°æ® - å®éªŒå®¤ID: {}", data.getLabId());
                } catch (IOException e) {
                    log.error("æ¨é€å¤±è´¥", e);
                }
            }
        }
    }

    /**
     * æ¨é€å‘Šè­¦ä¿¡æ¯
     *
     * è°ƒç”¨æ—¶æœºï¼šå‘Šè­¦æ£€æŸ¥è§¦å‘
     */
    public static void pushAlarm(LabAlarm alarm) {
        String message = JSON.toJSONString(Map.of(
            "type", "ALARM",
            "labId", alarm.getLabId(),
            "data", alarm,
            "timestamp", System.currentTimeMillis()
        ));

        for (WebSocketServer client : webSocketSet) {
            if (client.labId.equals(alarm.getLabId())) {
                try {
                    client.sendMessage(message);
                    log.info("ğŸš¨ æ¨é€å‘Šè­¦ - å®éªŒå®¤ID: {}, çº§åˆ«: {}",
                        alarm.getLabId(), alarm.getAlarmLevel());
                } catch (IOException e) {
                    log.error("æ¨é€å¤±è´¥", e);
                }
            }
        }
    }

    /**
     * å¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
     *
     * è°ƒç”¨æ—¶æœºï¼šæŠ¥è¡¨ç”Ÿæˆå®Œæˆ
     */
    public static void broadcastToAll(Object message) {
        String jsonMessage = JSON.toJSONString(message);

        for (WebSocketServer client : webSocketSet) {
            try {
                client.sendMessage(jsonMessage);
            } catch (IOException e) {
                log.error("å¹¿æ’­å¤±è´¥", e);
            }
        }

        log.info("ğŸ“¢ å¹¿æ’­æ¶ˆæ¯ - æ¥æ”¶äººæ•°: {}", webSocketSet.size());
    }
}
```

---

**2. WebSocketé…ç½®**

```java
// monitor-service/src/main/java/com/sewage/monitor/config/WebSocketConfig.java
@Configuration
public class WebSocketConfig {

    /**
     * æ³¨å…¥ServerEndpointExporter
     * ä½œç”¨ï¼šæ‰«æå¹¶æ³¨å†Œ@ServerEndpointæ³¨è§£çš„ç±»
     */
    @Bean
    public ServerEndpointExporter serverEndpointExporter() {
        return new ServerEndpointExporter();
    }
}
```

---

**3. Gateway WebSocketè·¯ç”±é…ç½®**

```yaml
# gateway-service/src/main/resources/application.yml
spring:
  cloud:
    gateway:
      routes:
        # WebSocketè·¯ç”±
        - id: websocket-route
          uri: lb:ws://monitor-service  # ws://åè®®
          predicates:
            - Path=/ws/**
          filters:
            - StripPrefix=0  # ä¸å»æ‰å‰ç¼€
```

---

**4. ä¸šåŠ¡å±‚è°ƒç”¨ï¼ˆæ¨é€æœåŠ¡ï¼‰**

```java
// monitor-service/src/main/java/com/sewage/monitor/service/WebSocketPushService.java
@Slf4j
@Service
public class WebSocketPushService {

    /**
     * æ¨é€ç¯å¢ƒæ•°æ®
     *
     * è°ƒç”¨ä½ç½®ï¼šLabEnvironmentDataService.saveMonitorData()
     */
    public void pushEnvironmentData(LabEnvironmentData data) {
        try {
            WebSocketServer.pushEnvironmentData(data);
            log.debug("ğŸ“¡ WebSocketæ¨é€ç¯å¢ƒæ•°æ® - å®éªŒå®¤ID: {}", data.getLabId());
        } catch (Exception e) {
            log.error("âŒ WebSocketæ¨é€å¤±è´¥", e);
        }
    }

    /**
     * æ¨é€å‘Šè­¦
     *
     * è°ƒç”¨ä½ç½®ï¼šAlarmService.checkAndSendAlarm()
     */
    public void pushAlarm(LabAlarm alarm) {
        try {
            WebSocketServer.pushAlarm(alarm);
            log.info("ğŸš¨ WebSocketæ¨é€å‘Šè­¦ - å®éªŒå®¤ID: {}, ç±»å‹: {}",
                alarm.getLabId(), alarm.getAlarmType());
        } catch (Exception e) {
            log.error("âŒ WebSocketæ¨é€å¤±è´¥", e);
        }
    }

    /**
     * å¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
     *
     * è°ƒç”¨ä½ç½®ï¼šScheduledReportService.pushReportNotification()
     */
    public void pushToAll(Object message) {
        try {
            WebSocketServer.broadcastToAll(message);
            log.info("ğŸ“¢ WebSocketå¹¿æ’­æ¶ˆæ¯");
        } catch (Exception e) {
            log.error("âŒ WebSocketå¹¿æ’­å¤±è´¥", e);
        }
    }
}
```

---

**5. å®Œæ•´çš„è°ƒç”¨æµç¨‹**

```java
// æ•°æ®é‡‡é›†æµç¨‹ï¼ˆç¯å¢ƒæ•°æ®ä¸ŠæŠ¥ï¼‰
Kafkaæ¶ˆæ¯
  â†“
LabEnvironmentDataConsumer.consume()
  â†“
LabEnvironmentDataService.saveMonitorData()
  â”œâ”€ 1. ä¿å­˜æ•°æ®åº“
  â”œâ”€ 2. æ›´æ–°Redisç¼“å­˜
  â”œâ”€ 3. å‘Šè­¦æ£€æŸ¥
  â””â”€ 4. ğŸ“¡ WebSocketæ¨é€ï¼ˆå®æ—¶ï¼‰
      â†“
WebSocketPushService.pushEnvironmentData()
  â†“
WebSocketServer.pushEnvironmentData()
  â†“
éå†æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
  â”œâ”€ è¿‡æ»¤ï¼šåªæ¨é€ç»™è®¢é˜…äº†è¯¥å®éªŒå®¤çš„å®¢æˆ·ç«¯
  â””â”€ æ¨é€ï¼šsession.getBasicRemote().sendText(message)
      â†“
å‰ç«¯å®æ—¶æ”¶åˆ°æ•°æ®ï¼Œæ›´æ–°å›¾è¡¨
```

---

**6. å‰ç«¯ä»£ç **

```html
<!-- websocket-test.html -->
<!DOCTYPE html>
<html>
<head>
    <title>WebSocketå®æ—¶ç›‘æµ‹</title>
</head>
<body>
    <h1>å®éªŒå®¤1 - å®æ—¶ç›‘æµ‹</h1>
    <div id="data"></div>

    <script>
        // 1. å»ºç«‹WebSocketè¿æ¥
        const ws = new WebSocket('ws://localhost:8080/ws/realtime/1');

        // 2. è¿æ¥æˆåŠŸ
        ws.onopen = function() {
            console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
            document.getElementById('status').textContent = 'å·²è¿æ¥';
        };

        // 3. æ¥æ”¶æ¶ˆæ¯
        ws.onmessage = function(event) {
            const message = JSON.parse(event.data);
            console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', message);

            // æ ¹æ®æ¶ˆæ¯ç±»å‹å¤„ç†
            switch(message.type) {
                case 'CONNECTION':
                    console.log('è¿æ¥æˆåŠŸ:', message.message);
                    break;

                case 'ENVIRONMENT_DATA':
                    // æ›´æ–°ç¯å¢ƒæ•°æ®
                    updateEnvironmentData(message.data);
                    break;

                case 'ALARM':
                    // æ˜¾ç¤ºå‘Šè­¦
                    showAlarm(message.data);
                    break;

                case 'REPORT_READY':
                    // æŠ¥è¡¨ç”Ÿæˆå®Œæˆ
                    showNotification('æŠ¥è¡¨å·²ç”Ÿæˆ', message.downloadUrl);
                    break;
            }
        };

        // 4. è¿æ¥å…³é—­
        ws.onclose = function() {
            console.log('âŒ WebSocketè¿æ¥å…³é—­');
            // è‡ªåŠ¨é‡è¿
            setTimeout(() => {
                location.reload();
            }, 3000);
        };

        // 5. é”™è¯¯å¤„ç†
        ws.onerror = function(error) {
            console.error('âŒ WebSocketé”™è¯¯:', error);
        };

        // æ›´æ–°ç¯å¢ƒæ•°æ®
        function updateEnvironmentData(data) {
            document.getElementById('data').innerHTML = `
                <p>æ¸©åº¦: ${data.temperature}Â°C</p>
                <p>æ¹¿åº¦: ${data.humidity}%</p>
                <p>PM2.5: ${data.pm25} Î¼g/mÂ³</p>
                <p>CO2: ${data.co2} ppm</p>
                <p>æ—¶é—´: ${data.monitorTime}</p>
            `;
        }

        // æ˜¾ç¤ºå‘Šè­¦
        function showAlarm(alarm) {
            alert(`ğŸš¨ å‘Šè­¦ï¼š${alarm.alarmMessage}`);
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, url) {
            if (confirm(message + '\næ˜¯å¦ç«‹å³ä¸‹è½½ï¼Ÿ')) {
                window.open(url);
            }
        }
    </script>
</body>
</html>
```

---

#### é¢è¯•å›ç­”æ€»ç»“æ¨¡æ¿

**ğŸ¯ æ ‡å‡†å›ç­”ï¼š**

> "æˆ‘ä»¬é¡¹ç›®ä½¿ç”¨WebSocketå®ç°äº†å®æ—¶æ•°æ®æ¨é€ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š
>
> **1. æŠ€æœ¯é€‰å‹ï¼š**
> - æœåŠ¡ç«¯ï¼šJava WebSocket APIï¼ˆ@ServerEndpointæ³¨è§£ï¼‰
> - å®¢æˆ·ç«¯ï¼šJavaScriptåŸç”ŸWebSocket API
> - ç½‘å…³ï¼šSpring Cloud Gatewayæ”¯æŒWebSocketåè®®è½¬å‘
>
> **2. æ¶æ„è®¾è®¡ï¼š**
> - å‰ç«¯é€šè¿‡ ws://gateway/ws/realtime/{labId} å»ºç«‹è¿æ¥
> - Gatewayå°†WebSocketè¯·æ±‚è½¬å‘åˆ°Monitor Service
> - Monitor Serviceä½¿ç”¨@ServerEndpointåˆ›å»ºWebSocketç«¯ç‚¹
> - ç”¨CopyOnWriteArraySetç®¡ç†æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
>
> **3. æ¶ˆæ¯æ¨é€æ—¶æœºï¼š**
> - ç¯å¢ƒæ•°æ®ä¸ŠæŠ¥ï¼šKafkaæ¶ˆè´¹è€…æ”¶åˆ°æ•°æ®åï¼Œç«‹å³æ¨é€ç»™è®¢é˜…è¯¥å®éªŒå®¤çš„å®¢æˆ·ç«¯
> - å‘Šè­¦è§¦å‘ï¼šå‘Šè­¦æ£€æŸ¥å‘ç°å¼‚å¸¸æ—¶ï¼Œæ¨é€å‘Šè­¦æ¶ˆæ¯
> - æŠ¥è¡¨ç”Ÿæˆï¼šå¼‚æ­¥æŠ¥è¡¨ç”Ÿæˆå®Œæˆåï¼Œå¹¿æ’­é€šçŸ¥æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
>
> **4. æ ¸å¿ƒä»£ç ï¼š**
> ```java
> // æ¨é€ç¯å¢ƒæ•°æ®
> public static void pushEnvironmentData(LabEnvironmentData data) {
>     for (WebSocketServer client : webSocketSet) {
>         if (client.labId.equals(data.getLabId())) {
>             client.sendMessage(JSON.toJSONString(data));
>         }
>     }
> }
> ```
>
> **5. ä¼˜åŠ¿ï¼š**
> - ä½å»¶è¿Ÿï¼šæ•°æ®äº§ç”Ÿåç«‹å³æ¨é€ï¼Œæ— è½®è¯¢å»¶è¿Ÿ
> - å‡å°‘è¯·æ±‚ï¼šé¿å…å®¢æˆ·ç«¯é¢‘ç¹è½®è¯¢
> - å®æ—¶æ€§ï¼šç”¨æˆ·æ— éœ€åˆ·æ–°é¡µé¢ï¼Œè‡ªåŠ¨æ›´æ–°æ•°æ®
>
> **6. æ³¨æ„äº‹é¡¹ï¼š**
> - è¿æ¥ç®¡ç†ï¼š@OnCloseæ—¶å¿…é¡»ä»é›†åˆä¸­ç§»é™¤ï¼Œé¿å…å†…å­˜æ³„æ¼
> - å¼‚å¸¸å¤„ç†ï¼š@OnErroræ•è·å¼‚å¸¸ï¼Œé¿å…å•ä¸ªè¿æ¥å¼‚å¸¸å½±å“å…¶ä»–è¿æ¥
> - çº¿ç¨‹å®‰å…¨ï¼šä½¿ç”¨CopyOnWriteArraySetä¿è¯å¹¶å‘å®‰å…¨"

---

### â“ 5.2 WebSocketå¦‚ä½•å®ç°å¿ƒè·³ä¿æ´»ï¼Ÿå¦‚ä½•å¤„ç†æ–­çº¿é‡è¿ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**é—®é¢˜ï¼š**
- WebSocketé•¿è¿æ¥å¯èƒ½å› ä¸ºç½‘ç»œæ³¢åŠ¨ã€æœåŠ¡å™¨é‡å¯ç­‰åŸå› æ–­å¼€
- å®¢æˆ·ç«¯éœ€è¦æ£€æµ‹è¿æ¥çŠ¶æ€å¹¶è‡ªåŠ¨é‡è¿
- æœåŠ¡ç«¯éœ€è¦æ¸…ç†æ— æ•ˆè¿æ¥

**è§£å†³æ–¹æ¡ˆï¼š**

**1. å®¢æˆ·ç«¯å¿ƒè·³æ£€æµ‹**

```javascript
// å‰ç«¯ä»£ç 
class WebSocketClient {
    constructor(url, labId) {
        this.url = url;
        this.labId = labId;
        this.ws = null;
        this.heartbeatInterval = null;
        this.reconnectTimeout = null;
        this.isManualClose = false;  // æ˜¯å¦æ‰‹åŠ¨å…³é—­
    }

    // å»ºç«‹è¿æ¥
    connect() {
        this.ws = new WebSocket(this.url);

        this.ws.onopen = () => {
            console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
            this.startHeartbeat();  // å¼€å§‹å¿ƒè·³
        };

        this.ws.onmessage = (event) => {
            const message = JSON.parse(event.data);

            // å¤„ç†å¿ƒè·³å“åº”
            if (message.type === 'PONG') {
                console.log('ğŸ’“ æ”¶åˆ°å¿ƒè·³å“åº”');
                return;
            }

            // å¤„ç†ä¸šåŠ¡æ¶ˆæ¯
            this.handleMessage(message);
        };

        this.ws.onclose = () => {
            console.log('âŒ WebSocketè¿æ¥å…³é—­');
            this.stopHeartbeat();  // åœæ­¢å¿ƒè·³

            // å¦‚æœä¸æ˜¯æ‰‹åŠ¨å…³é—­ï¼Œè‡ªåŠ¨é‡è¿
            if (!this.isManualClose) {
                this.reconnect();
            }
        };

        this.ws.onerror = (error) => {
            console.error('âŒ WebSocketé”™è¯¯:', error);
        };
    }

    // å¼€å§‹å¿ƒè·³ï¼ˆæ¯30ç§’å‘é€ä¸€æ¬¡ï¼‰
    startHeartbeat() {
        this.heartbeatInterval = setInterval(() => {
            if (this.ws.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify({
                    type: 'PING',
                    timestamp: Date.now()
                }));
                console.log('ğŸ’“ å‘é€å¿ƒè·³');
            }
        }, 30000);  // 30ç§’
    }

    // åœæ­¢å¿ƒè·³
    stopHeartbeat() {
        if (this.heartbeatInterval) {
            clearInterval(this.heartbeatInterval);
            this.heartbeatInterval = null;
        }
    }

    // æ–­çº¿é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ç­–ç•¥ï¼‰
    reconnect() {
        let retryCount = 0;
        const maxRetries = 10;

        const doReconnect = () => {
            if (retryCount >= maxRetries) {
                console.error('âŒ é‡è¿å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
                return;
            }

            // æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s, 8s, 16s, ...
            const delay = Math.min(1000 * Math.pow(2, retryCount), 30000);

            console.log(`ğŸ”„ ${delay/1000}ç§’åå°è¯•é‡è¿ï¼ˆç¬¬${retryCount + 1}æ¬¡ï¼‰`);

            this.reconnectTimeout = setTimeout(() => {
                retryCount++;
                this.connect();
            }, delay);
        };

        doReconnect();
    }

    // æ‰‹åŠ¨å…³é—­
    close() {
        this.isManualClose = true;
        this.stopHeartbeat();
        if (this.reconnectTimeout) {
            clearTimeout(this.reconnectTimeout);
        }
        if (this.ws) {
            this.ws.close();
        }
    }

    // å¤„ç†ä¸šåŠ¡æ¶ˆæ¯
    handleMessage(message) {
        // ä¸šåŠ¡é€»è¾‘
    }
}

// ä½¿ç”¨
const wsClient = new WebSocketClient('ws://localhost:8080/ws/realtime/1', 1);
wsClient.connect();
```

---

**2. æœåŠ¡ç«¯å¿ƒè·³å“åº”**

```java
// WebSocketServer.java
@OnMessage
public void onMessage(String message, Session session) {
    try {
        Map<String, Object> msg = JSON.parseObject(message, Map.class);
        String type = (String) msg.get("type");

        // å¤„ç†å¿ƒè·³
        if ("PING".equals(type)) {
            // å“åº”PONG
            sendMessage(JSON.toJSONString(Map.of(
                "type", "PONG",
                "timestamp", System.currentTimeMillis()
            )));

            // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
            this.lastActiveTime = System.currentTimeMillis();

            log.debug("ğŸ’“ æ”¶åˆ°å¿ƒè·³ - å®éªŒå®¤ID: {}", labId);
            return;
        }

        // å¤„ç†å…¶ä»–æ¶ˆæ¯...

    } catch (Exception e) {
        log.error("å¤„ç†æ¶ˆæ¯å¤±è´¥", e);
    }
}
```

---

**3. æœåŠ¡ç«¯å®šæ—¶æ¸…ç†æ— æ•ˆè¿æ¥**

```java
// WebSocketServer.java
@Scheduled(fixedDelay = 60000)  // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
public void cleanInactiveConnections() {
    long now = System.currentTimeMillis();
    int removed = 0;

    Iterator<WebSocketServer> iterator = webSocketSet.iterator();
    while (iterator.hasNext()) {
        WebSocketServer client = iterator.next();

        // è¶…è¿‡2åˆ†é’Ÿæœªæ´»è·ƒï¼Œå…³é—­è¿æ¥
        if (now - client.lastActiveTime > 120000) {
            try {
                client.session.close();
                iterator.remove();
                removed++;
                log.warn("âš ï¸ æ¸…ç†æ— æ•ˆè¿æ¥ - å®éªŒå®¤ID: {}", client.labId);
            } catch (Exception e) {
                log.error("å…³é—­è¿æ¥å¤±è´¥", e);
            }
        }
    }

    if (removed > 0) {
        log.info("ğŸ§¹ æ¸…ç†äº† {} ä¸ªæ— æ•ˆè¿æ¥", removed);
    }
}
```

---

**4. æ–­çº¿é‡è¿æ•ˆæœ**

```
æ­£å¸¸æƒ…å†µï¼š
å®¢æˆ·ç«¯ â”€â”€PINGâ”€â”€â–º æœåŠ¡ç«¯
å®¢æˆ·ç«¯ â—„â”€PONGâ”€â”€â”€ æœåŠ¡ç«¯
ï¼ˆæ¯30ç§’ä¸€æ¬¡ï¼‰

ç½‘ç»œæ–­å¼€ï¼š
å®¢æˆ·ç«¯ â”€â”€PINGâ”€â”€X æœåŠ¡ç«¯
å®¢æˆ·ç«¯è§¦å‘oncloseäº‹ä»¶
  â†“
å»¶è¿Ÿ1ç§’åé‡è¿
  â†“
è¿æ¥æˆåŠŸ âœ…

é‡è¿å¤±è´¥ï¼š
å»¶è¿Ÿ2ç§’åé‡è¿
  â†“
è¿æ¥æˆåŠŸ âœ…

å¤šæ¬¡é‡è¿å¤±è´¥ï¼š
å»¶è¿Ÿ4ç§’ã€8ç§’ã€16ç§’...
æœ€å¤šé‡è¿10æ¬¡
```

---

### â“ 5.3 å¦‚ä½•ä¿è¯WebSocketæ¶ˆæ¯çš„å¯é æ€§ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**é—®é¢˜ï¼š**
- WebSocketæ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼ˆç½‘ç»œæ³¢åŠ¨ï¼‰
- æ¶ˆæ¯é¡ºåºå¯èƒ½ä¹±åºï¼ˆTCPé‡ä¼ ï¼‰
- å®¢æˆ·ç«¯æ–­çº¿é‡è¿åå¦‚ä½•æ¢å¤æ•°æ®ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**

**1. æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆACKï¼‰**

```javascript
// å®¢æˆ·ç«¯
class ReliableWebSocket {
    constructor(url) {
        this.ws = new WebSocket(url);
        this.pendingMessages = new Map();  // å¾…ç¡®è®¤çš„æ¶ˆæ¯
        this.messageId = 0;
    }

    // å‘é€æ¶ˆæ¯ï¼ˆå¸¦ç¡®è®¤ï¼‰
    sendWithAck(data) {
        const messageId = ++this.messageId;

        const message = {
            id: messageId,
            data: data,
            timestamp: Date.now()
        };

        // å­˜å‚¨å¾…ç¡®è®¤æ¶ˆæ¯
        this.pendingMessages.set(messageId, message);

        // å‘é€æ¶ˆæ¯
        this.ws.send(JSON.stringify(message));

        // 5ç§’æœªç¡®è®¤ï¼Œé‡å‘
        setTimeout(() => {
            if (this.pendingMessages.has(messageId)) {
                console.warn('âš ï¸ æ¶ˆæ¯æœªç¡®è®¤ï¼Œé‡å‘:', messageId);
                this.ws.send(JSON.stringify(message));
            }
        }, 5000);
    }

    // å¤„ç†ACK
    handleAck(ack) {
        const messageId = ack.messageId;
        if (this.pendingMessages.has(messageId)) {
            this.pendingMessages.delete(messageId);
            console.log('âœ… æ¶ˆæ¯å·²ç¡®è®¤:', messageId);
        }
    }
}
```

```java
// æœåŠ¡ç«¯
@OnMessage
public void onMessage(String message, Session session) {
    Map<String, Object> msg = JSON.parseObject(message, Map.class);
    Long messageId = (Long) msg.get("id");

    // å¤„ç†æ¶ˆæ¯...

    // å‘é€ACK
    sendMessage(JSON.toJSONString(Map.of(
        "type", "ACK",
        "messageId", messageId
    )));
}
```

---

**2. æ¶ˆæ¯åºåˆ—å·ï¼ˆä¿è¯é¡ºåºï¼‰**

```java
// æœåŠ¡ç«¯æ¨é€æ—¶æ·»åŠ åºåˆ—å·
private static AtomicLong messageSeq = new AtomicLong(0);

public static void pushEnvironmentData(LabEnvironmentData data) {
    String message = JSON.toJSONString(Map.of(
        "type", "ENVIRONMENT_DATA",
        "seq", messageSeq.incrementAndGet(),  // åºåˆ—å·
        "data", data,
        "timestamp", System.currentTimeMillis()
    ));

    // æ¨é€...
}
```

```javascript
// å®¢æˆ·ç«¯æ£€æŸ¥åºåˆ—å·
let lastSeq = 0;

ws.onmessage = (event) => {
    const message = JSON.parse(event.data);

    // æ£€æŸ¥åºåˆ—å·
    if (message.seq <= lastSeq) {
        console.warn('âš ï¸ æ”¶åˆ°é‡å¤æˆ–ä¹±åºæ¶ˆæ¯');
        return;
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸¢å¤±çš„æ¶ˆæ¯
    if (message.seq > lastSeq + 1) {
        console.warn('âš ï¸ ä¸¢å¤±æ¶ˆæ¯ï¼Œåºåˆ—å·ä»', lastSeq, 'è·³åˆ°', message.seq);
        // è¯·æ±‚é‡ä¼ ä¸¢å¤±çš„æ¶ˆæ¯
        requestMissingMessages(lastSeq + 1, message.seq - 1);
    }

    lastSeq = message.seq;

    // å¤„ç†æ¶ˆæ¯...
};
```

---

**3. æ–­çº¿é‡è¿åæ•°æ®æ¢å¤**

```javascript
// å®¢æˆ·ç«¯é‡è¿åè¯·æ±‚æœ€æ–°æ•°æ®
ws.onopen = () => {
    console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');

    // è¯·æ±‚æœ€æ–°æ•°æ®ï¼ˆä»ä¸Šæ¬¡æ–­å¼€çš„åºåˆ—å·å¼€å§‹ï¼‰
    ws.send(JSON.stringify({
        type: 'SYNC',
        lastSeq: lastSeq  // ä¸Šæ¬¡æ”¶åˆ°çš„åºåˆ—å·
    }));
};
```

```java
// æœåŠ¡ç«¯å¤„ç†åŒæ­¥è¯·æ±‚
@OnMessage
public void onMessage(String message, Session session) {
    Map<String, Object> msg = JSON.parseObject(message, Map.class);
    String type = (String) msg.get("type");

    if ("SYNC".equals(type)) {
        Long lastSeq = (Long) msg.get("lastSeq");

        // æŸ¥è¯¢lastSeqä¹‹åçš„æ¶ˆæ¯ï¼ˆä»Redisæˆ–æ•°æ®åº“ï¼‰
        List<LabEnvironmentData> missedData = getMissedData(labId, lastSeq);

        // æ¨é€ç»™å®¢æˆ·ç«¯
        for (LabEnvironmentData data : missedData) {
            sendMessage(JSON.toJSONString(data));
        }

        log.info("âœ… åŒæ­¥äº† {} æ¡æ¶ˆæ¯", missedData.size());
    }
}
```

---

## å…­ã€Redis ç¼“å­˜åº”ç”¨

### â“ 6.1 Redis åœ¨é¡¹ç›®ä¸­çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**æˆ‘ä»¬é¡¹ç›®ä¸­Redisçš„5å¤§åº”ç”¨åœºæ™¯ï¼š**

**1. å®æ—¶æ•°æ®ç¼“å­˜ï¼ˆHashï¼‰**

```java
// ç¼“å­˜å®éªŒå®¤æœ€æ–°ç¯å¢ƒæ•°æ®
public void updateRealtimeCache(LabEnvironmentData data) {
    String key = "lab:latest:" + data.getLabId();

    // Hashç»“æ„å­˜å‚¨
    Map<String, Object> hashData = new HashMap<>();
    hashData.put("temperature", data.getTemperature());
    hashData.put("humidity", data.getHumidity());
    hashData.put("pm25", data.getPm25());
    hashData.put("co2", data.getCo2());
    hashData.put("monitorTime", data.getMonitorTime().toString());

    redisTemplate.opsForHash().putAll(key, hashData);
    redisTemplate.expire(key, 30, TimeUnit.SECONDS);  // 30ç§’è¿‡æœŸ
}

// æŸ¥è¯¢ç¼“å­˜
public LabEnvironmentData getLatestData(Long labId) {
    String key = "lab:latest:" + labId;
    Map<Object, Object> map = redisTemplate.opsForHash().entries(key);

    if (map.isEmpty()) {
        // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        return queryFromDatabase(labId);
    }

    // ä»Hashæ„å»ºå¯¹è±¡
    return LabEnvironmentData.builder()
        .temperature((BigDecimal) map.get("temperature"))
        .humidity((BigDecimal) map.get("humidity"))
        .pm25((BigDecimal) map.get("pm25"))
        .co2((BigDecimal) map.get("co2"))
        .build();
}
```

**ä¸ºä»€ä¹ˆç”¨Hashè€Œä¸æ˜¯Stringï¼Ÿ**
- Hashæ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼ˆåªæ›´æ–°æ¸©åº¦ï¼Œä¸å½±å“æ¹¿åº¦ï¼‰
- å†…å­˜å ç”¨æ›´å°‘
- å¯ä»¥ç›´æ¥è·å–å•ä¸ªå­—æ®µ

---

**2. å†å²æ•°æ®ç¼“å­˜ï¼ˆSorted Setï¼‰**

```java
// ç¼“å­˜æœ€è¿‘1å°æ—¶çš„å†å²æ•°æ®
public void cacheHistoryData(LabEnvironmentData data) {
    String key = "lab:history:" + data.getLabId();

    // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºscore
    long score = data.getMonitorTime().atZone(ZoneId.systemDefault()).toEpochSecond();

    // æ·»åŠ åˆ°Sorted Set
    redisTemplate.opsForZSet().add(key, JSON.toJSONString(data), score);

    // åªä¿ç•™æœ€è¿‘1å°æ—¶çš„æ•°æ®
    long oneHourAgo = System.currentTimeMillis() / 1000 - 3600;
    redisTemplate.opsForZSet().removeRangeByScore(key, 0, oneHourAgo);

    // è®¾ç½®è¿‡æœŸæ—¶é—´
    redisTemplate.expire(key, 1, TimeUnit.HOURS);
}

// æŸ¥è¯¢æ—¶é—´èŒƒå›´å†…çš„æ•°æ®
public List<LabEnvironmentData> getHistoryData(Long labId, LocalDateTime start, LocalDateTime end) {
    String key = "lab:history:" + labId;

    long startScore = start.atZone(ZoneId.systemDefault()).toEpochSecond();
    long endScore = end.atZone(ZoneId.systemDefault()).toEpochSecond();

    // æŸ¥è¯¢åŒºé—´æ•°æ®
    Set<String> dataSet = redisTemplate.opsForZSet().rangeByScore(key, startScore, endScore);

    return dataSet.stream()
        .map(json -> JSON.parseObject(json, LabEnvironmentData.class))
        .collect(Collectors.toList());
}
```

---

**3. ç»Ÿè®¡æ•°æ®ç¼“å­˜ï¼ˆString + JSONï¼‰**

```java
// ç¼“å­˜æ—¥ç»Ÿè®¡æ•°æ®
public void cacheStatistics(LabDailyStatistics statistics) {
    String key = "statistics:" + statistics.getLabId() + ":" + statistics.getStatDate();

    // åºåˆ—åŒ–ä¸ºJSON
    String json = JSON.toJSONString(statistics);

    // ç¼“å­˜1å°æ—¶
    redisTemplate.opsForValue().set(key, json, 1, TimeUnit.HOURS);
}

// æŸ¥è¯¢ç»Ÿè®¡æ•°æ®
public LabDailyStatistics getStatistics(Long labId, LocalDate date) {
    String key = "statistics:" + labId + ":" + date;

    String json = redisTemplate.opsForValue().get(key);
    if (json != null) {
        return JSON.parseObject(json, LabDailyStatistics.class);
    }

    // ç¼“å­˜æœªå‘½ä¸­ï¼Œè®¡ç®—ç»Ÿè®¡
    LabDailyStatistics statistics = calculateStatistics(labId, date);
    cacheStatistics(statistics);

    return statistics;
}
```

---

**4. é™æµï¼ˆString + incrï¼‰**

```java
// Gatewayé™æµ
public boolean isAllowed(String ip) {
    String key = "rate_limit:" + ip;

    // åŸå­é€’å¢
    Long count = redisTemplate.opsForValue().increment(key);

    // ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´1ç§’
    if (count == 1) {
        redisTemplate.expire(key, 1, TimeUnit.SECONDS);
    }

    // æ¯ç§’æœ€å¤š100æ¬¡
    return count <= 100;
}
```

---

**5. Tokené»‘åå•ï¼ˆStringï¼‰**

```java
// ç”¨æˆ·ç™»å‡ºæ—¶ï¼Œå°†TokenåŠ å…¥é»‘åå•
@PostMapping("/logout")
public Result<Void> logout(@RequestHeader("Authorization") String authHeader) {
    String token = authHeader.substring(7);

    // è·å–Tokenè¿‡æœŸæ—¶é—´
    Date expiration = jwtUtil.getExpirationDate(token);
    long ttl = expiration.getTime() - System.currentTimeMillis();

    // åŠ å…¥é»‘åå•ï¼ˆè¿‡æœŸåè‡ªåŠ¨åˆ é™¤ï¼‰
    redisTemplate.opsForValue().set(
        "token:blacklist:" + token,
        "1",
        ttl,
        TimeUnit.MILLISECONDS
    );

    return Result.success();
}

// éªŒè¯Tokenæ—¶æ£€æŸ¥é»‘åå•
public boolean validateToken(String token) {
    // æ£€æŸ¥é»‘åå•
    Boolean isBlacklisted = redisTemplate.hasKey("token:blacklist:" + token);
    if (Boolean.TRUE.equals(isBlacklisted)) {
        return false;
    }

    // éªŒè¯ç­¾åå’Œè¿‡æœŸæ—¶é—´
    return jwtUtil.validateToken(token);
}
```

---

### â“ 6.2 å¦‚ä½•è§£å†³ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜é›ªå´©é—®é¢˜ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**ä¸‰å¤§ç¼“å­˜é—®é¢˜å¯¹æ¯”ï¼š**

| é—®é¢˜ | åŸå›  | åæœ | è§£å†³æ–¹æ¡ˆ |
|-----|------|------|---------|
| **ç¼“å­˜ç©¿é€** | æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® | æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“ | å¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜ |
| **ç¼“å­˜å‡»ç©¿** | çƒ­ç‚¹Keyè¿‡æœŸ | ç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ | äº’æ–¥é”ã€çƒ­ç‚¹Keyä¸è¿‡æœŸ |
| **ç¼“å­˜é›ªå´©** | å¤§é‡KeyåŒæ—¶è¿‡æœŸ | æ•°æ®åº“ç¬é—´å‹åŠ›å·¨å¤§ | è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ |

---

**é—®é¢˜1ï¼šç¼“å­˜ç©¿é€ï¼ˆæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼‰**

**åœºæ™¯ï¼š**
```
å®¢æˆ·ç«¯è¯·æ±‚ï¼šGET /api/monitor/data/latest/999999
ï¼ˆå®éªŒå®¤ID 999999ä¸å­˜åœ¨ï¼‰

RedisæŸ¥è¯¢ï¼šnull
æ•°æ®åº“æŸ¥è¯¢ï¼šnull

æ¶æ„æ”»å‡»ï¼šå¾ªç¯è¯·æ±‚ä¸å­˜åœ¨çš„ID
  â†“
Redisä¸€ç›´æŸ¥ä¸åˆ°
  â†“
æ•°æ®åº“å‹åŠ›å·¨å¤§
  â†“
ç³»ç»Ÿå´©æºƒ
```

**è§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨**

```java
// å¯åŠ¨æ—¶å°†æ‰€æœ‰å®éªŒå®¤IDåŠ è½½åˆ°å¸ƒéš†è¿‡æ»¤å™¨
@PostConstruct
public void initBloomFilter() {
    BloomFilter<Long> bloomFilter = BloomFilter.create(
        Funnels.longFunnel(),
        10000,  // é¢„è®¡å…ƒç´ æ•°é‡
        0.01    // è¯¯åˆ¤ç‡1%
    );

    // åŠ è½½æ‰€æœ‰å®éªŒå®¤ID
    List<Long> labIds = laboratoryMapper.selectAllIds();
    for (Long labId : labIds) {
        bloomFilter.put(labId);
    }

    // åºåˆ—åŒ–å­˜å‚¨åˆ°Redis
    redisTemplate.opsForValue().set("bloom:lab_ids", bloomFilter);
}

// æŸ¥è¯¢å‰å…ˆæ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨
public LabEnvironmentData getLatestData(Long labId) {
    // 1. å¸ƒéš†è¿‡æ»¤å™¨æ£€æŸ¥
    BloomFilter<Long> bloomFilter = (BloomFilter<Long>) redisTemplate.opsForValue().get("bloom:lab_ids");
    if (!bloomFilter.mightContain(labId)) {
        log.warn("âš ï¸ å®éªŒå®¤IDä¸å­˜åœ¨ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰- ID: {}", labId);
        return null;  // ç›´æ¥è¿”å›ï¼Œä¸æŸ¥æ•°æ®åº“
    }

    // 2. æŸ¥è¯¢Redisç¼“å­˜
    // 3. æŸ¥è¯¢æ•°æ®åº“
    // ...
}
```

**è§£å†³æ–¹æ¡ˆ2ï¼šç©ºå€¼ç¼“å­˜**

```java
public LabEnvironmentData getLatestData(Long labId) {
    String key = "lab:latest:" + labId;

    // 1. æŸ¥è¯¢ç¼“å­˜
    String cached = redisTemplate.opsForValue().get(key);

    // ç¼“å­˜äº†ç©ºå€¼
    if ("NULL".equals(cached)) {
        log.info("ğŸ¯ ç¼“å­˜å‘½ä¸­ï¼ˆç©ºå€¼ï¼‰- ID: {}", labId);
        return null;
    }

    if (cached != null) {
        return JSON.parseObject(cached, LabEnvironmentData.class);
    }

    // 2. æŸ¥è¯¢æ•°æ®åº“
    LabEnvironmentData data = labEnvironmentDataMapper.selectLatest(labId);

    if (data != null) {
        // å­˜åœ¨ï¼Œç¼“å­˜30ç§’
        redisTemplate.opsForValue().set(key, JSON.toJSONString(data), 30, TimeUnit.SECONDS);
    } else {
        // ä¸å­˜åœ¨ï¼Œç¼“å­˜ç©ºå€¼ï¼ˆè¿‡æœŸæ—¶é—´çŸ­ä¸€äº›ï¼‰
        redisTemplate.opsForValue().set(key, "NULL", 60, TimeUnit.SECONDS);
        log.info("ğŸ’¾ ç¼“å­˜ç©ºå€¼ - ID: {}", labId);
    }

    return data;
}
```

---

**é—®é¢˜2ï¼šç¼“å­˜å‡»ç©¿ï¼ˆçƒ­ç‚¹Keyè¿‡æœŸï¼‰**

**åœºæ™¯ï¼š**
```
çƒ­ç‚¹å®éªŒå®¤ï¼ˆID=1ï¼‰çš„æ•°æ®è¿‡æœŸ
  â†“
åŒä¸€æ—¶åˆ»1000ä¸ªè¯·æ±‚æŸ¥è¯¢å®éªŒå®¤1çš„æ•°æ®
  â†“
1000ä¸ªè¯·æ±‚éƒ½å‘ç°ç¼“å­˜ä¸å­˜åœ¨
  â†“
1000ä¸ªè¯·æ±‚åŒæ—¶æŸ¥è¯¢æ•°æ®åº“
  â†“
æ•°æ®åº“å‹åŠ›éª¤å¢
```

**è§£å†³æ–¹æ¡ˆ1ï¼šäº’æ–¥é”ï¼ˆåªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŸ¥æ•°æ®åº“ï¼‰**

```java
public LabEnvironmentData getLatestData(Long labId) {
    String key = "lab:latest:" + labId;
    String lockKey = "lock:" + key;

    // 1. æŸ¥è¯¢ç¼“å­˜
    String cached = redisTemplate.opsForValue().get(key);
    if (cached != null) {
        return JSON.parseObject(cached, LabEnvironmentData.class);
    }

    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œå°è¯•è·å–é”
    Boolean lockAcquired = redisTemplate.opsForValue().setIfAbsent(
        lockKey,
        "1",
        10,  // é”è¿‡æœŸæ—¶é—´10ç§’
        TimeUnit.SECONDS
    );

    if (Boolean.TRUE.equals(lockAcquired)) {
        // è·å–é”æˆåŠŸï¼ŒæŸ¥è¯¢æ•°æ®åº“
        try {
            LabEnvironmentData data = labEnvironmentDataMapper.selectLatest(labId);

            // å†™å…¥ç¼“å­˜
            if (data != null) {
                redisTemplate.opsForValue().set(key, JSON.toJSONString(data), 30, TimeUnit.SECONDS);
            }

            return data;

        } finally {
            // é‡Šæ”¾é”
            redisTemplate.delete(lockKey);
        }
    } else {
        // è·å–é”å¤±è´¥ï¼Œç­‰å¾…100msåé‡è¯•
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }

        // é‡è¯•æŸ¥è¯¢ï¼ˆæ­¤æ—¶å¯èƒ½å·²ç»æœ‰ç¼“å­˜äº†ï¼‰
        return getLatestData(labId);
    }
}
```

**è§£å†³æ–¹æ¡ˆ2ï¼šçƒ­ç‚¹Keyæ°¸ä¸è¿‡æœŸ**

```java
// çƒ­ç‚¹å®éªŒå®¤çš„æ•°æ®æ°¸ä¸è¿‡æœŸ
public void cacheHotLabData(LabEnvironmentData data) {
    String key = "lab:latest:" + data.getLabId();

    // åŒ…è£…ä¸€ä¸ªå¯¹è±¡ï¼Œè®°å½•é€»è¾‘è¿‡æœŸæ—¶é—´
    CacheData cacheData = CacheData.builder()
        .data(data)
        .expireTime(LocalDateTime.now().plusSeconds(30))  // é€»è¾‘è¿‡æœŸæ—¶é—´
        .build();

    // æ°¸ä¸è¿‡æœŸ
    redisTemplate.opsForValue().set(key, JSON.toJSONString(cacheData));
}

// æŸ¥è¯¢æ—¶æ£€æŸ¥é€»è¾‘è¿‡æœŸæ—¶é—´
public LabEnvironmentData getLatestData(Long labId) {
    String key = "lab:latest:" + labId;
    String cached = redisTemplate.opsForValue().get(key);

    if (cached == null) {
        return queryFromDatabase(labId);
    }

    CacheData cacheData = JSON.parseObject(cached, CacheData.class);

    // æ£€æŸ¥é€»è¾‘è¿‡æœŸæ—¶é—´
    if (cacheData.getExpireTime().isBefore(LocalDateTime.now())) {
        // å·²è¿‡æœŸï¼Œå¼‚æ­¥åˆ·æ–°ç¼“å­˜
        CompletableFuture.runAsync(() -> {
            LabEnvironmentData newData = queryFromDatabase(labId);
            cacheHotLabData(newData);
        });

        // è¿”å›æ—§æ•°æ®ï¼ˆä¿è¯å¯ç”¨æ€§ï¼‰
        return cacheData.getData();
    }

    // æœªè¿‡æœŸï¼Œè¿”å›ç¼“å­˜æ•°æ®
    return cacheData.getData();
}
```

---

**é—®é¢˜3ï¼šç¼“å­˜é›ªå´©ï¼ˆå¤§é‡KeyåŒæ—¶è¿‡æœŸï¼‰**

**åœºæ™¯ï¼š**
```
ç³»ç»Ÿé‡å¯åï¼Œæ‰¹é‡å†™å…¥ç¼“å­˜ï¼ˆè¿‡æœŸæ—¶é—´éƒ½æ˜¯30ç§’ï¼‰
  â†“
30ç§’åï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶è¿‡æœŸ
  â†“
å¤§é‡è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“
  â†“
æ•°æ®åº“å‹åŠ›éª¤å¢
```

**è§£å†³æ–¹æ¡ˆï¼šè¿‡æœŸæ—¶é—´åŠ éšæœºå€¼**

```java
public void cacheData(String key, Object data) {
    // åŸºç¡€è¿‡æœŸæ—¶é—´30ç§’ + éšæœº0-10ç§’
    int expireTime = 30 + new Random().nextInt(10);

    redisTemplate.opsForValue().set(
        key,
        JSON.toJSONString(data),
        expireTime,
        TimeUnit.SECONDS
    );
}

// æ•ˆæœï¼š
// Key1: 30ç§’è¿‡æœŸ
// Key2: 35ç§’è¿‡æœŸ
// Key3: 32ç§’è¿‡æœŸ
// ...
// è¿‡æœŸæ—¶é—´åˆ†æ•£ï¼Œé¿å…åŒæ—¶å¤±æ•ˆ
```

---

### â“ 6.3 Redis çš„æ•°æ®ç±»å‹åŠåº”ç”¨åœºæ™¯ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**Redis 5ç§åŸºæœ¬æ•°æ®ç±»å‹ + 3ç§é«˜çº§ç±»å‹ï¼š**

| æ•°æ®ç±»å‹ | å­˜å‚¨å†…å®¹ | å…¸å‹åº”ç”¨ | æˆ‘ä»¬é¡¹ç›®çš„ä½¿ç”¨ |
|---------|---------|---------|---------------|
| **String** | å­—ç¬¦ä¸²ã€æ•°å­— | ç¼“å­˜ã€è®¡æ•°å™¨ã€åˆ†å¸ƒå¼é” | Tokené»‘åå•ã€é™æµè®¡æ•° |
| **Hash** | é”®å€¼å¯¹é›†åˆ | å¯¹è±¡ç¼“å­˜ | å®éªŒå®¤æœ€æ–°æ•°æ®ç¼“å­˜ |
| **List** | åŒå‘é“¾è¡¨ | æ¶ˆæ¯é˜Ÿåˆ—ã€æœ€æ–°åˆ—è¡¨ | ï¼ˆæœªä½¿ç”¨ï¼‰ |
| **Set** | æ— åºé›†åˆ | å»é‡ã€äº¤é›†/å¹¶é›† | ï¼ˆæœªä½¿ç”¨ï¼‰ |
| **Sorted Set** | æœ‰åºé›†åˆ | æ’è¡Œæ¦œã€æ—¶é—´çº¿ | å†å²æ•°æ®ç¼“å­˜ |
| **Bitmap** | ä½å›¾ | ç­¾åˆ°ã€åœ¨çº¿çŠ¶æ€ | ï¼ˆæœªä½¿ç”¨ï¼‰ |
| **HyperLogLog** | åŸºæ•°ç»Ÿè®¡ | UVç»Ÿè®¡ | ï¼ˆæœªä½¿ç”¨ï¼‰ |
| **Geo** | åœ°ç†ä½ç½® | é™„è¿‘çš„äºº | ï¼ˆæœªä½¿ç”¨ï¼‰ |

---

**è¯¦ç»†è¯´æ˜ï¼š**

**1. Stringï¼ˆå­—ç¬¦ä¸²ï¼‰**

```java
// ç®€å•ç¼“å­˜
redisTemplate.opsForValue().set("key", "value");
String value = redisTemplate.opsForValue().get("key");

// è®¡æ•°å™¨ï¼ˆåŸå­é€’å¢ï¼‰
Long count = redisTemplate.opsForValue().increment("counter");

// åˆ†å¸ƒå¼é”
Boolean locked = redisTemplate.opsForValue().setIfAbsent(
    "lock:key",
    "1",
    10,
    TimeUnit.SECONDS
);
```

**åº”ç”¨ï¼š**
- Tokené»‘åå•
- é™æµè®¡æ•°
- åˆ†å¸ƒå¼é”

---

**2. Hashï¼ˆå“ˆå¸Œï¼‰**

```java
// å­˜å‚¨å¯¹è±¡
Map<String, Object> map = new HashMap<>();
map.put("temperature", 25.5);
map.put("humidity", 60.0);
redisTemplate.opsForHash().putAll("lab:1", map);

// è·å–å•ä¸ªå­—æ®µ
Object temperature = redisTemplate.opsForHash().get("lab:1", "temperature");

// è·å–æ‰€æœ‰å­—æ®µ
Map<Object, Object> allFields = redisTemplate.opsForHash().entries("lab:1");
```

**åº”ç”¨ï¼š**
- å®éªŒå®¤æœ€æ–°æ•°æ®ç¼“å­˜ï¼ˆæ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼‰
- è´­ç‰©è½¦ï¼ˆå•†å“IDä¸ºfieldï¼Œæ•°é‡ä¸ºvalueï¼‰

---

**3. Listï¼ˆåˆ—è¡¨ï¼‰**

```java
// å·¦ä¾§æ’å…¥
redisTemplate.opsForList().leftPush("list", "value1");
redisTemplate.opsForList().leftPush("list", "value2");

// å³ä¾§å¼¹å‡º
String value = redisTemplate.opsForList().rightPop("list");

// è·å–èŒƒå›´
List<String> range = redisTemplate.opsForList().range("list", 0, 9);  // å‰10æ¡
```

**åº”ç”¨ï¼š**
- æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆLPUSH + BRPOPï¼‰
- æœ€æ–°åˆ—è¡¨ï¼ˆæœ€æ–°æ–‡ç« ã€è¯„è®ºï¼‰

---

**4. Setï¼ˆé›†åˆï¼‰**

```java
// æ·»åŠ å…ƒç´ 
redisTemplate.opsForSet().add("set", "value1", "value2", "value3");

// åˆ¤æ–­æ˜¯å¦å­˜åœ¨
Boolean exists = redisTemplate.opsForSet().isMember("set", "value1");

// äº¤é›†
Set<String> intersection = redisTemplate.opsForSet().intersect("set1", "set2");

// å¹¶é›†
Set<String> union = redisTemplate.opsForSet().union("set1", "set2");
```

**åº”ç”¨ï¼š**
- å»é‡ï¼ˆç”¨æˆ·æ ‡ç­¾ã€æ–‡ç« æ ‡ç­¾ï¼‰
- å…±åŒå¥½å‹ï¼ˆäº¤é›†ï¼‰
- æ¨èç³»ç»Ÿï¼ˆå¹¶é›†ï¼‰

---

**5. Sorted Setï¼ˆæœ‰åºé›†åˆï¼‰**

```java
// æ·»åŠ å…ƒç´ ï¼ˆscoreä¸ºåˆ†æ•°ï¼‰
redisTemplate.opsForZSet().add("zset", "member1", 100);
redisTemplate.opsForZSet().add("zset", "member2", 200);

// æŒ‰åˆ†æ•°èŒƒå›´æŸ¥è¯¢
Set<String> range = redisTemplate.opsForZSet().rangeByScore("zset", 0, 150);

// æŒ‰æ’åæŸ¥è¯¢
Set<String> top10 = redisTemplate.opsForZSet().reverseRange("zset", 0, 9);

// è·å–æ’å
Long rank = redisTemplate.opsForZSet().rank("zset", "member1");
```

**åº”ç”¨ï¼š**
- å†å²æ•°æ®ç¼“å­˜ï¼ˆscoreä¸ºæ—¶é—´æˆ³ï¼‰
- æ’è¡Œæ¦œï¼ˆscoreä¸ºåˆ†æ•°ï¼‰
- å»¶æ—¶é˜Ÿåˆ—ï¼ˆscoreä¸ºæ‰§è¡Œæ—¶é—´æˆ³ï¼‰

---

**æˆ‘ä»¬é¡¹ç›®ä¸­çš„å®Œæ•´ä½¿ç”¨ç¤ºä¾‹ï¼š**

```java
// CacheService.java - å°è£…Redisæ“ä½œ
@Service
@RequiredArgsConstructor
public class CacheService {
    private final RedisTemplate<String, Object> redisTemplate;

    // 1. String - ç¼“å­˜ç»Ÿè®¡æ•°æ®
    public void cacheStatistics(String key, LabDailyStatistics statistics) {
        redisTemplate.opsForValue().set(
            key,
            JSON.toJSONString(statistics),
            1,
            TimeUnit.HOURS
        );
    }

    // 2. Hash - ç¼“å­˜å®æ—¶æ•°æ®
    public void hSetAll(String key, Map<String, Object> map) {
        redisTemplate.opsForHash().putAll(key, map);
    }

    public Object hGet(String key, String field) {
        return redisTemplate.opsForHash().get(key, field);
    }

    // 3. Sorted Set - ç¼“å­˜å†å²æ•°æ®
    public void zAdd(String key, Object value, double score) {
        redisTemplate.opsForZSet().add(key, value, score);
    }

    public Set<Object> zRangeByScore(String key, double min, double max) {
        return redisTemplate.opsForZSet().rangeByScore(key, min, max);
    }

    // 4. è®¾ç½®è¿‡æœŸæ—¶é—´
    public void expire(String key, long timeout, TimeUnit unit) {
        redisTemplate.expire(key, timeout, unit);
    }

    // 5. åˆ é™¤
    public void delete(String key) {
        redisTemplate.delete(key);
    }
}
```

---

### â“ 6.4 Redis æŒä¹…åŒ–æœºåˆ¶ï¼ˆRDB vs AOFï¼‰ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**RedisæŒä¹…åŒ–çš„ä¸¤ç§æ–¹å¼ï¼š**

| ç‰¹æ€§ | RDBï¼ˆå¿«ç…§ï¼‰ | AOFï¼ˆæ—¥å¿—ï¼‰ |
|-----|-----------|-----------|
| **æŒä¹…åŒ–æ–¹å¼** | å®šæ—¶ä¿å­˜å†…å­˜å¿«ç…§ | è®°å½•æ¯ä¸ªå†™å‘½ä»¤ |
| **æ–‡ä»¶å¤§å°** | å°ï¼ˆå‹ç¼©ï¼‰ | å¤§ï¼ˆæ—¥å¿—ï¼‰ |
| **æ¢å¤é€Ÿåº¦** | å¿« | æ…¢ |
| **æ•°æ®å®Œæ•´æ€§** | å¯èƒ½ä¸¢å¤±æœ€åä¸€æ¬¡å¿«ç…§åçš„æ•°æ® | ä¸¢å¤±æœ€å¤š1ç§’æ•°æ® |
| **æ€§èƒ½å½±å“** | forkå­è¿›ç¨‹ï¼Œæœ‰å»¶è¿Ÿ | æ¯ç§’åˆ·ç›˜ï¼Œå½±å“å° |
| **é€‚ç”¨åœºæ™¯** | å¤‡ä»½ã€ç¾éš¾æ¢å¤ | æ•°æ®å®Œæ•´æ€§è¦æ±‚é«˜ |

---

**1. RDBï¼ˆRedis Databaseï¼‰**

**åŸç†ï¼š**
```
Redisä¸»è¿›ç¨‹
    â†“ fork()
åˆ›å»ºå­è¿›ç¨‹
    â†“
å­è¿›ç¨‹éå†å†…å­˜æ•°æ®
    â†“
å†™å…¥ä¸´æ—¶RDBæ–‡ä»¶
    â†“
é‡å‘½åä¸ºdump.rdb
    â†“
å®Œæˆï¼ˆä¸»è¿›ç¨‹ç»§ç»­å¤„ç†è¯·æ±‚ï¼‰
```

**é…ç½®ï¼š**
```bash
# redis.conf
save 900 1      # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ–ï¼Œè§¦å‘ä¿å­˜
save 300 10     # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ–ï¼Œè§¦å‘ä¿å­˜
save 60 10000   # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ–ï¼Œè§¦å‘ä¿å­˜

# RDBæ–‡ä»¶å
dbfilename dump.rdb

# RDBæ–‡ä»¶ç›®å½•
dir /var/lib/redis
```

**ä¼˜ç‚¹ï¼š**
- æ–‡ä»¶ç´§å‡‘ï¼Œé€‚åˆå¤‡ä»½
- æ¢å¤é€Ÿåº¦å¿«ï¼ˆç›´æ¥åŠ è½½åˆ°å†…å­˜ï¼‰
- å¯¹æ€§èƒ½å½±å“å°ï¼ˆå­è¿›ç¨‹å¤„ç†ï¼‰

**ç¼ºç‚¹ï¼š**
- å¯èƒ½ä¸¢å¤±æœ€åä¸€æ¬¡å¿«ç…§åçš„æ•°æ®
- fork()è€—æ—¶ï¼Œæ•°æ®é‡å¤§æ—¶æœ‰å»¶è¿Ÿ

---

**2. AOFï¼ˆAppend Only Fileï¼‰**

**åŸç†ï¼š**
```
å®¢æˆ·ç«¯å‘é€å‘½ä»¤ï¼šSET key value
    â†“
Redisæ‰§è¡Œå‘½ä»¤
    â†“
è®°å½•åˆ°AOFç¼“å†²åŒº
    â†“
æ ¹æ®ç­–ç•¥åˆ·ç›˜ï¼š
  - always: æ¯ä¸ªå‘½ä»¤ç«‹å³åˆ·ç›˜
  - everysec: æ¯ç§’åˆ·ç›˜ï¼ˆæ¨èï¼‰
  - no: ç”±æ“ä½œç³»ç»Ÿå†³å®š
```

**é…ç½®ï¼š**
```bash
# redis.conf
appendonly yes  # å¼€å¯AOF

# AOFæ–‡ä»¶å
appendfilename "appendonly.aof"

# åˆ·ç›˜ç­–ç•¥
appendfsync everysec  # æ¯ç§’åˆ·ç›˜ï¼ˆæ¨èï¼‰

# AOFé‡å†™é…ç½®
auto-aof-rewrite-percentage 100  # AOFæ–‡ä»¶å¤§å°æ˜¯ä¸Šæ¬¡é‡å†™åçš„100%æ—¶è§¦å‘é‡å†™
auto-aof-rewrite-min-size 64mb   # AOFæ–‡ä»¶è‡³å°‘64MBæ‰è§¦å‘é‡å†™
```

**AOFé‡å†™ï¼ˆå‹ç¼©æ—¥å¿—ï¼‰ï¼š**
```
åŸAOFæ–‡ä»¶ï¼š
SET key1 value1
SET key2 value2
SET key1 value3
DEL key2
SET key1 value4

é‡å†™åï¼š
SET key1 value4  # åªä¿ç•™æœ€ç»ˆçŠ¶æ€
```

**ä¼˜ç‚¹ï¼š**
- æ•°æ®å®Œæ•´æ€§å¥½ï¼ˆæœ€å¤šä¸¢å¤±1ç§’ï¼‰
- æ—¥å¿—æ–‡ä»¶å¯è¯»ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
- è‡ªåŠ¨é‡å†™é¿å…æ–‡ä»¶è¿‡å¤§

**ç¼ºç‚¹ï¼š**
- æ–‡ä»¶å¤§
- æ¢å¤æ…¢ï¼ˆéœ€è¦é‡æ”¾å‘½ä»¤ï¼‰
- æ€§èƒ½ç•¥ä½ï¼ˆæ¯ç§’åˆ·ç›˜ï¼‰

---

**3. æ··åˆæŒä¹…åŒ–ï¼ˆRDB + AOFï¼‰**

Redis 4.0+æ”¯æŒæ··åˆæŒä¹…åŒ–ï¼š

```bash
# redis.conf
aof-use-rdb-preamble yes  # å¼€å¯æ··åˆæŒä¹…åŒ–
```

**åŸç†ï¼š**
- AOFæ–‡ä»¶çš„å‰åŠéƒ¨åˆ†æ˜¯RDBæ ¼å¼ï¼ˆå¿«ç…§ï¼‰
- ååŠéƒ¨åˆ†æ˜¯AOFæ ¼å¼ï¼ˆå¢é‡æ—¥å¿—ï¼‰
- æ¢å¤æ—¶ï¼šå…ˆåŠ è½½RDBå¿«ç…§ï¼Œå†é‡æ”¾AOFæ—¥å¿—

**ä¼˜åŠ¿ï¼š**
- ç»“åˆä¸¤è€…ä¼˜ç‚¹
- æ¢å¤é€Ÿåº¦å¿«ï¼ˆRDBå¿«é€ŸåŠ è½½ï¼‰
- æ•°æ®å®Œæ•´æ€§å¥½ï¼ˆAOFè¡¥å……ï¼‰

---

**æˆ‘ä»¬é¡¹ç›®çš„é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š**

```bash
# redis.conf

# å¼€å¯AOFï¼ˆæ•°æ®å®Œæ•´æ€§ä¼˜å…ˆï¼‰
appendonly yes
appendfsync everysec  # æ¯ç§’åˆ·ç›˜

# å¼€å¯æ··åˆæŒä¹…åŒ–
aof-use-rdb-preamble yes

# RDBä½œä¸ºå¤‡ä»½
save 900 1
save 300 10
save 60 10000

# AOFé‡å†™
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

**é€‰æ‹©ç†ç”±ï¼š**
- å®éªŒå®¤ç›‘æµ‹æ•°æ®é‡è¦ï¼Œä¸èƒ½ä¸¢å¤± â†’ AOF
- æ¯ç§’åˆ·ç›˜ï¼Œæœ€å¤šä¸¢å¤±1ç§’æ•°æ® â†’ å¯æ¥å—
- æ··åˆæŒä¹…åŒ–ï¼Œå…¼é¡¾æ¢å¤é€Ÿåº¦å’Œå®Œæ•´æ€§

---

## ğŸ¯ ç¬¬äºŒéƒ¨åˆ†æ€»ç»“

**æ ¸å¿ƒè¦ç‚¹ï¼š**

1. **æ€§èƒ½ä¼˜åŒ–**
   - SQLæ‹†åˆ†ã€ç´¢å¼•ä¼˜åŒ–ã€è®¡ç®—ç§»è‡³Javaå±‚
   - å¼‚æ­¥å¤„ç† + WebSocketæ¨é€
   - å¹¶è¡Œè®¡ç®—ã€ç¼“å­˜ä¼˜åŒ–

2. **WebSocketå®ç°**
   - @ServerEndpointæ³¨è§£åˆ›å»ºç«¯ç‚¹
   - CopyOnWriteArraySetç®¡ç†è¿æ¥
   - å¿ƒè·³ä¿æ´»ã€æ–­çº¿é‡è¿ã€æ¶ˆæ¯ç¡®è®¤

3. **Redisåº”ç”¨**
   - 5ç§æ•°æ®ç±»å‹ï¼šStringã€Hashã€Listã€Setã€Sorted Set
   - ç¼“å­˜ç©¿é€/å‡»ç©¿/é›ªå´©è§£å†³æ–¹æ¡ˆ
   - RDB + AOFæ··åˆæŒä¹…åŒ–

**é¢è¯•åŠ åˆ†é¡¹ï¼š**
- ç»“åˆé¡¹ç›®çœŸå®æ¡ˆä¾‹è¯´æ˜
- è¯´æ˜ä¼˜åŒ–å‰åçš„æ•°æ®å¯¹æ¯”
- æåŠé‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

---

**ğŸ“Œ ä¸‹ä¸€éƒ¨åˆ†é¢„å‘Šï¼š**

**ç¬¬ä¸‰éƒ¨åˆ†ï¼šKafkaæ¶ˆæ¯é˜Ÿåˆ—ä¸ç³»ç»Ÿè°ƒä¼˜**
- Kafkaç›¸å…³é—®é¢˜
- JVMè°ƒä¼˜ç›¸å…³é—®é¢˜
- MySQLä¼˜åŒ–ç›¸å…³é—®é¢˜

å‡†å¤‡å¥½æŸ¥çœ‹ç¬¬ä¸‰éƒ¨åˆ†äº†å—ï¼Ÿ
