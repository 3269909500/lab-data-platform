# å®éªŒå®¤ç‰©è”æ•°æ®ä¸­å° - é¢è¯•é—®ç­”æ‰‹å†Œï¼ˆç¬¬1éƒ¨åˆ†ï¼‰

> åŸºäºä½ çš„é¡¹ç›®ç»éªŒï¼Œé’ˆå¯¹é¢è¯•ä¸­å¸¸è§é—®é¢˜çš„æ·±åº¦è§£ç­”
> æœ¬æ–‡æ¡£åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œè¿™æ˜¯ç¬¬ä¸€éƒ¨åˆ†ï¼š**å¾®æœåŠ¡åŸºç¡€ç»„ä»¶ä¸æ¶æ„**

---

## ğŸ“š ç›®å½•

- [ä¸€ã€Nacos æ³¨å†Œä¸­å¿ƒç›¸å…³é—®é¢˜](#ä¸€nacos-æ³¨å†Œä¸­å¿ƒç›¸å…³é—®é¢˜)
- [äºŒã€Gateway ç½‘å…³ç›¸å…³é—®é¢˜](#äºŒgateway-ç½‘å…³ç›¸å…³é—®é¢˜)
- [ä¸‰ã€è®¤è¯é‰´æƒç›¸å…³é—®é¢˜](#ä¸‰è®¤è¯é‰´æƒç›¸å…³é—®é¢˜)

---

## ä¸€ã€Nacos æ³¨å†Œä¸­å¿ƒç›¸å…³é—®é¢˜

### â“ 1.1 Nacos çš„å¿ƒè·³æœºåˆ¶æ˜¯ä»€ä¹ˆï¼ŸæœåŠ¡å¦‚ä½•ä¿æŒå­˜æ´»ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

Nacosçš„å¿ƒè·³æœºåˆ¶åˆ†ä¸º**ä¸´æ—¶å®ä¾‹**å’Œ**æŒä¹…åŒ–å®ä¾‹**ä¸¤ç§æ¨¡å¼ï¼Œæˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ä¸´æ—¶å®ä¾‹æ¨¡å¼ã€‚

**æ ¸å¿ƒæœºåˆ¶ï¼š**

1ï¸âƒ£ **å®¢æˆ·ç«¯ä¸»åŠ¨å¿ƒè·³ï¼ˆä¸´æ—¶å®ä¾‹ï¼‰**
- æœåŠ¡å¯åŠ¨åï¼Œæ¯éš” **5ç§’** å‘Nacos Serverå‘é€ä¸€æ¬¡å¿ƒè·³
- å¿ƒè·³åŒ…å«ï¼šæœåŠ¡åã€IPã€ç«¯å£ã€æƒé‡ã€å¥åº·çŠ¶æ€ç­‰ä¿¡æ¯
- Nacos Serveræ”¶åˆ°å¿ƒè·³åæ›´æ–°å®ä¾‹çš„ `lastBeat` æ—¶é—´æˆ³

2ï¸âƒ£ **æœåŠ¡ç«¯å¥åº·æ£€æŸ¥**
- Nacos Serveræ¯éš” **20ç§’** æ‰«æä¸€æ¬¡æ‰€æœ‰ä¸´æ—¶å®ä¾‹
- å¦‚æœæŸä¸ªå®ä¾‹è¶…è¿‡ **15ç§’** æœªå‘é€å¿ƒè·³ï¼Œæ ‡è®°ä¸º**ä¸å¥åº·**ï¼ˆunhealthyï¼‰
- å¦‚æœè¶…è¿‡ **30ç§’** ä»æœªæ”¶åˆ°å¿ƒè·³ï¼Œå°†å®ä¾‹**å‰”é™¤**ï¼ˆä»æœåŠ¡åˆ—è¡¨ä¸­åˆ é™¤ï¼‰

3ï¸âƒ£ **æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€ï¼ˆæŒä¹…åŒ–å®ä¾‹ï¼‰**
- æŒä¹…åŒ–å®ä¾‹ç”±Nacos Serverä¸»åŠ¨æ¢æµ‹ï¼ˆTCP/HTTPæ¢é’ˆï¼‰
- å³ä½¿æœåŠ¡æŒ‚äº†ï¼Œå®ä¾‹ä¿¡æ¯ä¹Ÿä¸ä¼šè¢«åˆ é™¤ï¼Œåªæ˜¯æ ‡è®°ä¸ºä¸å¥åº·

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„é…ç½®ï¼š**
```yaml
# application.yml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        ephemeral: true  # ä¸´æ—¶å®ä¾‹ï¼ˆé»˜è®¤trueï¼‰
        heart-beat-interval: 5000  # å¿ƒè·³é—´éš”5ç§’
        heart-beat-timeout: 15000  # å¿ƒè·³è¶…æ—¶15ç§’
        ip-delete-timeout: 30000   # å®ä¾‹åˆ é™¤è¶…æ—¶30ç§’
```

**å¯¹æ¯”å…¶ä»–æ³¨å†Œä¸­å¿ƒï¼š**
| æ³¨å†Œä¸­å¿ƒ | å¿ƒè·³æœºåˆ¶ | å‰”é™¤æ—¶é—´ |
|---------|---------|---------|
| Nacos   | å®¢æˆ·ç«¯ä¸»åŠ¨å‘é€ï¼ˆ5ç§’ï¼‰ | 30ç§’ |
| Eureka  | å®¢æˆ·ç«¯ä¸»åŠ¨å‘é€ï¼ˆ30ç§’ï¼‰| 90ç§’ |
| Consul  | TTLæˆ–TCP/HTTPæ¢æµ‹ | å¯é…ç½® |

**ä¼˜åŠ¿ï¼š**
- å¿«é€Ÿå‘ç°æœåŠ¡æ•…éšœï¼ˆ30ç§’å‰”é™¤ vs Eurekaçš„90ç§’ï¼‰
- å‡å°‘æ— æ•ˆè¯·æ±‚ï¼ˆåŠæ—¶å‰”é™¤ä¸å¥åº·å®ä¾‹ï¼‰
- æ”¯æŒä¸´æ—¶å®ä¾‹å’ŒæŒä¹…åŒ–å®ä¾‹ä¸¤ç§æ¨¡å¼

---

### â“ 1.2 æœåŠ¡æ³¨å†Œåˆ° Nacos çš„å®Œæ•´æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

æœåŠ¡æ³¨å†Œæµç¨‹åˆ†ä¸º **5ä¸ªå…³é”®æ­¥éª¤**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æœåŠ¡å¯åŠ¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¯»å–é…ç½®                      â”‚
â”‚    - æœåŠ¡å: monitor-service     â”‚
â”‚    - Nacosåœ°å€: localhost:8848   â”‚
â”‚    - å®ä¾‹ä¿¡æ¯: IP, Port, æƒé‡ç­‰  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å‘èµ·æ³¨å†Œè¯·æ±‚                  â”‚
â”‚    POST /nacos/v1/ns/instance    â”‚
â”‚    {                             â”‚
â”‚      serviceName: "monitor-service",â”‚
â”‚      ip: "192.168.1.100",       â”‚
â”‚      port: 8083,                â”‚
â”‚      weight: 1.0,               â”‚
â”‚      healthy: true,             â”‚
â”‚      ephemeral: true            â”‚
â”‚    }                            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Nacos Server å¤„ç†             â”‚
â”‚    - å­˜å‚¨å®ä¾‹ä¿¡æ¯åˆ°å†…å­˜Map       â”‚
â”‚    - è§¦å‘æœåŠ¡å˜æ›´äº‹ä»¶            â”‚
â”‚    - æ¨é€å˜æ›´ç»™è®¢é˜…è€…            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å¼€å§‹å¿ƒè·³ä¿æ´»                  â”‚
â”‚    - æ¯5ç§’å‘é€å¿ƒè·³               â”‚
â”‚    - ç»´æŒå¥åº·çŠ¶æ€                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„å®ç°ï¼š**

æˆ‘ä»¬æœ‰4ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦æ³¨å†Œåˆ°Nacosï¼š
- `auth-service` (è®¤è¯æœåŠ¡ï¼Œç«¯å£8081)
- `system-service` (ç³»ç»ŸæœåŠ¡ï¼Œç«¯å£8082)
- `monitor-service` (ç›‘æ§æœåŠ¡ï¼Œç«¯å£8083)
- `gateway-service` (ç½‘å…³æœåŠ¡ï¼Œç«¯å£8080)

**å…³é”®ä»£ç ä½ç½®ï¼š**
```java
// æ¯ä¸ªæœåŠ¡çš„ application.yml
spring:
  application:
    name: monitor-service  # æœåŠ¡å
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: public  # å‘½åç©ºé—´
        group: DEFAULT_GROUP  # åˆ†ç»„
```

**æ³¨å†ŒæˆåŠŸçš„æ ‡å¿—ï¼š**
1. æ§åˆ¶å°æ—¥å¿—ï¼š`Nacos registry, monitor-service is registered`
2. Nacosæ§åˆ¶å°å¯è§æœåŠ¡å®ä¾‹
3. å…¶ä»–æœåŠ¡å¯ä»¥é€šè¿‡æœåŠ¡åè°ƒç”¨

**å¸¸è§é—®é¢˜ï¼š**
- **é—®é¢˜1**ï¼šæœåŠ¡æ³¨å†Œå¤±è´¥
  - åŸå› ï¼šNacos Serveræœªå¯åŠ¨æˆ–åœ°å€é…ç½®é”™è¯¯
  - è§£å†³ï¼šæ£€æŸ¥ `server-addr` é…ç½®å’ŒNacos ServerçŠ¶æ€

- **é—®é¢˜2**ï¼šæœåŠ¡æ³¨å†Œåç«‹å³è¢«å‰”é™¤
  - åŸå› ï¼šå¿ƒè·³å‘é€å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜æˆ–æœåŠ¡é˜»å¡ï¼‰
  - è§£å†³ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥å’Œçº¿ç¨‹æ± é…ç½®

---

### â“ 1.3 Nacos çš„ AP å’Œ CP æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä½ ä»¬é¡¹ç›®ç”¨çš„æ˜¯å“ªç§ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

è¿™æ˜¯æ ¹æ®**CAPç†è®º**ï¼ˆä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹é”™æ€§ï¼‰æ¥è®¾è®¡çš„ä¸¤ç§æ¨¡å¼ã€‚

**AP æ¨¡å¼ï¼ˆå¯ç”¨æ€§ä¼˜å…ˆï¼‰ï¼š**
- **ç‰¹ç‚¹**ï¼šä¼˜å…ˆä¿è¯**å¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§**ï¼Œæ”¾å¼ƒå¼ºä¸€è‡´æ€§
- **é€‚ç”¨åœºæ™¯**ï¼šä¸´æ—¶å®ä¾‹ï¼ˆçŸ­è¿æ¥æœåŠ¡ï¼‰
- **å®ç°æ–¹å¼**ï¼šåŸºäº Distro åè®®ï¼ˆç±»ä¼¼ Gossipï¼‰
- **ä¸€è‡´æ€§**ï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼ˆå¯èƒ½å‡ºç°çŸ­æš‚çš„æ•°æ®ä¸ä¸€è‡´ï¼‰
- **æ€§èƒ½**ï¼šè¯»å†™æ€§èƒ½é«˜ï¼Œä¸éœ€è¦ç­‰å¾…å¤šæ•°èŠ‚ç‚¹ç¡®è®¤

**CP æ¨¡å¼ï¼ˆä¸€è‡´æ€§ä¼˜å…ˆï¼‰ï¼š**
- **ç‰¹ç‚¹**ï¼šä¼˜å…ˆä¿è¯**ä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™æ€§**ï¼Œå¯èƒ½ç‰ºç‰²å¯ç”¨æ€§
- **é€‚ç”¨åœºæ™¯**ï¼šæŒä¹…åŒ–å®ä¾‹ï¼ˆæ•°æ®åº“ã€é…ç½®ä¸­å¿ƒç­‰ï¼‰
- **å®ç°æ–¹å¼**ï¼šåŸºäº Raft åè®®ï¼ˆé€‰ä¸¾Leaderï¼‰
- **ä¸€è‡´æ€§**ï¼šå¼ºä¸€è‡´æ€§ï¼ˆå†™å…¥æˆåŠŸåæ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸€è‡´ï¼‰
- **æ€§èƒ½**ï¼šå†™æ“ä½œéœ€è¦ç­‰å¾…å¤šæ•°èŠ‚ç‚¹ç¡®è®¤ï¼Œæ€§èƒ½ç¨ä½

**å¯¹æ¯”è¡¨æ ¼ï¼š**
| ç‰¹æ€§ | AP æ¨¡å¼ | CP æ¨¡å¼ |
|-----|--------|--------|
| åè®® | Distro | Raft |
| ä¸€è‡´æ€§ | æœ€ç»ˆä¸€è‡´æ€§ | å¼ºä¸€è‡´æ€§ |
| æ€§èƒ½ | é«˜ | ä¸­ |
| å¯ç”¨æ€§ | é«˜ï¼ˆLeaderæŒ‚äº†ä¸å½±å“ï¼‰ | ä¸­ï¼ˆLeaderæŒ‚äº†éœ€è¦é‡æ–°é€‰ä¸¾ï¼‰ |
| é€‚ç”¨å®ä¾‹ | ä¸´æ—¶å®ä¾‹ | æŒä¹…åŒ–å®ä¾‹ |

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„é€‰æ‹©ï¼š**

æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ **AP æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰**ï¼ŒåŸå› å¦‚ä¸‹ï¼š

1. **ä¸šåŠ¡ç‰¹ç‚¹**ï¼šå®éªŒå®¤ç›‘æµ‹æœåŠ¡éƒ½æ˜¯ä¸´æ—¶å®ä¾‹ï¼ŒæœåŠ¡é‡å¯åé‡æ–°æ³¨å†Œå³å¯
2. **é«˜å¯ç”¨è¦æ±‚**ï¼šå³ä½¿Nacosé›†ç¾¤éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†ï¼ŒæœåŠ¡ä»ç„¶å¯ä»¥æ­£å¸¸æ³¨å†Œå’Œå‘ç°
3. **æ€§èƒ½ä¼˜å…ˆ**ï¼šä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†é¢‘ç¹ï¼Œéœ€è¦å¿«é€Ÿçš„æœåŠ¡æ³¨å†Œå’Œå¿ƒè·³å“åº”
4. **å®¹å¿çŸ­æš‚ä¸ä¸€è‡´**ï¼šå³ä½¿æœåŠ¡åˆ—è¡¨çŸ­æš‚ä¸ä¸€è‡´ï¼ˆ1-2ç§’ï¼‰ï¼Œå¯¹ä¸šåŠ¡å½±å“ä¸å¤§

**é…ç½®æ–¹å¼ï¼š**
```yaml
spring:
  cloud:
    nacos:
      discovery:
        ephemeral: true  # true=APæ¨¡å¼ï¼ˆä¸´æ—¶å®ä¾‹ï¼‰ï¼Œfalse=CPæ¨¡å¼ï¼ˆæŒä¹…åŒ–å®ä¾‹ï¼‰
```

**ä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥ç”¨ CP æ¨¡å¼ï¼Ÿ**
- é…ç½®ä¸­å¿ƒï¼ˆéœ€è¦å¼ºä¸€è‡´æ€§ï¼Œä¸èƒ½è¯»åˆ°æ—§é…ç½®ï¼‰
- æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼ˆä¸èƒ½å› ä¸ºä¸ä¸€è‡´å¯¼è‡´è¿æ¥é”™è¯¯çš„æ•°æ®åº“ï¼‰
- å…³é”®ä¸šåŠ¡é…ç½®ï¼ˆå¦‚æ”¯ä»˜é…ç½®ã€æƒé™é…ç½®ï¼‰

---

### â“ 1.4 å¦‚æœ Nacos Server æŒ‚äº†ï¼Œå·²ç»æ³¨å†Œçš„æœåŠ¡è¿˜èƒ½æ­£å¸¸è°ƒç”¨å—ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**ç­”æ¡ˆæ˜¯ï¼šå¯ä»¥ï¼** Nacoså®¢æˆ·ç«¯æœ‰**æœ¬åœ°ç¼“å­˜æœºåˆ¶**ã€‚

**å®Œæ•´çš„å®¹é”™æœºåˆ¶ï¼š**

1ï¸âƒ£ **æœ¬åœ°ç¼“å­˜**
- å®¢æˆ·ç«¯é¦–æ¬¡ä»Nacos Serveræ‹‰å–æœåŠ¡åˆ—è¡¨åï¼Œä¼š**ç¼“å­˜åˆ°æœ¬åœ°**
- ç¼“å­˜ä½ç½®ï¼š`{user.home}/nacos/naming/{namespace}/`
- ç¼“å­˜æ ¼å¼ï¼šJSONæ–‡ä»¶ï¼ŒåŒ…å«æœåŠ¡åã€å®ä¾‹IPã€ç«¯å£ç­‰ä¿¡æ¯

2ï¸âƒ£ **æœåŠ¡è°ƒç”¨æµç¨‹**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœåŠ¡A è°ƒç”¨    â”‚
â”‚ æœåŠ¡B        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æŸ¥è¯¢æœ¬åœ°ç¼“å­˜              â”‚
â”‚    â”œâ”€ ç¼“å­˜å­˜åœ¨ï¼Ÿ             â”‚
â”‚    â”‚   â””â”€ Yes: ç›´æ¥ä½¿ç”¨      â”‚
â”‚    â””â”€ ç¼“å­˜ä¸å­˜åœ¨ï¼Ÿ           â”‚
â”‚        â””â”€ No: ä»Nacosæ‹‰å–   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è´Ÿè½½å‡è¡¡é€‰æ‹©å®ä¾‹          â”‚
â”‚    â”œâ”€ è½®è¯¢/éšæœº/æƒé‡         â”‚
â”‚    â””â”€ è¿‡æ»¤ä¸å¥åº·å®ä¾‹         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å‘èµ·HTTP/RPCè°ƒç”¨          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

3ï¸âƒ£ **Nacos Server æŒ‚äº†çš„å½±å“**
- âœ… **å·²æ³¨å†Œçš„æœåŠ¡ä»å¯äº’ç›¸è°ƒç”¨**ï¼ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼‰
- âŒ **æ–°æœåŠ¡æ— æ³•æ³¨å†Œ**
- âŒ **æ— æ³•æ„ŸçŸ¥æœåŠ¡å®ä¾‹çš„ä¸Šä¸‹çº¿**ï¼ˆä½†æœ¬åœ°ç¼“å­˜çš„å®ä¾‹ä»å¯ç”¨ï¼‰
- âŒ **æ— æ³•è·å–æœ€æ–°çš„æœåŠ¡åˆ—è¡¨**

4ï¸âƒ£ **Nacos Server æ¢å¤å**
- å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨é‡è¿Nacos Server
- é‡æ–°å‘é€å¿ƒè·³ï¼Œæ›´æ–°å®ä¾‹çŠ¶æ€
- æ‹‰å–æœ€æ–°çš„æœåŠ¡åˆ—è¡¨ï¼Œæ›´æ–°æœ¬åœ°ç¼“å­˜

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„å®è·µï¼š**

ä¸ºäº†æé«˜é«˜å¯ç”¨æ€§ï¼Œæˆ‘ä»¬åšäº†ä»¥ä¸‹æªæ–½ï¼š

```yaml
# application.yml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: nacos1:8848,nacos2:8848,nacos3:8848  # é›†ç¾¤éƒ¨ç½²
        cache-dir: ./nacos/cache  # ç¼“å­˜ç›®å½•
        naming-load-cache-at-start: true  # å¯åŠ¨æ—¶åŠ è½½ç¼“å­˜
```

**é›†ç¾¤éƒ¨ç½²çš„å¥½å¤„ï¼š**
- å•ä¸ªNacosèŠ‚ç‚¹æŒ‚äº†ï¼Œå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–èŠ‚ç‚¹
- 3ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå³ä½¿æŒ‚2ä¸ªï¼Œä»ç„¶å¯ç”¨ï¼ˆAPæ¨¡å¼ï¼‰

**çœŸå®æ¡ˆä¾‹ï¼š**
> æœ‰ä¸€æ¬¡æˆ‘ä»¬æµ‹è¯•ç¯å¢ƒçš„Nacos Serveré‡å¯äº†10åˆ†é’Ÿï¼Œä½†æœåŠ¡ä¹‹é—´çš„è°ƒç”¨å®Œå…¨æ­£å¸¸ï¼Œå› ä¸ºéƒ½åœ¨ä½¿ç”¨æœ¬åœ°ç¼“å­˜ã€‚åªæ˜¯æ–°éƒ¨ç½²çš„æœåŠ¡æ— æ³•æ³¨å†Œï¼Œç­‰Nacosæ¢å¤åç«‹å³è‡ªåŠ¨æ³¨å†ŒæˆåŠŸäº†ã€‚

---

### â“ 1.5 Nacos å’Œ Eureka çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé€‰æ‹© Nacosï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

**æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”ï¼š**

| å¯¹æ¯”é¡¹ | Nacos | Eureka |
|-------|-------|--------|
| **æœåŠ¡å¥åº·æ£€æŸ¥** | æ”¯æŒTCP/HTTP/MySQLï¼ˆCPæ¨¡å¼ï¼‰<br>å®¢æˆ·ç«¯å¿ƒè·³ï¼ˆAPæ¨¡å¼ï¼‰ | åªæ”¯æŒå®¢æˆ·ç«¯å¿ƒè·³ |
| **è´Ÿè½½å‡è¡¡** | æ”¯æŒæƒé‡é…ç½® | ä¸æ”¯æŒæƒé‡ |
| **æœåŠ¡å‰”é™¤æ—¶é—´** | 30ç§’ï¼ˆå¯é…ç½®ï¼‰ | 90ç§’ï¼ˆè¾ƒæ…¢ï¼‰ |
| **é…ç½®ä¸­å¿ƒ** | âœ… å†…ç½®é…ç½®ä¸­å¿ƒ | âŒ éœ€è¦é¢å¤–å¼•å…¥Spring Cloud Config |
| **æ§åˆ¶å°** | âœ… åŠŸèƒ½å¼ºå¤§çš„å¯è§†åŒ–æ§åˆ¶å° | âœ… ç®€å•çš„æ§åˆ¶å° |
| **AP/CPæ¨¡å¼** | âœ… æ”¯æŒåˆ‡æ¢ | âŒ åªæ”¯æŒAP |
| **ç¤¾åŒºæ´»è·ƒåº¦** | âœ… é˜¿é‡Œç»´æŠ¤ï¼Œæ´»è·ƒ | âŒ Netflixå·²åœæ­¢ç»´æŠ¤ |
| **å­¦ä¹ æˆæœ¬** | ä¸­æ–‡æ–‡æ¡£é½å…¨ | è‹±æ–‡æ–‡æ¡£ |

**è¯¦ç»†åˆ†æï¼š**

1ï¸âƒ£ **å¥åº·æ£€æŸ¥æœºåˆ¶**
```
Nacosï¼ˆçµæ´»ï¼‰:
- ä¸´æ—¶å®ä¾‹ï¼šå®¢æˆ·ç«¯å¿ƒè·³ï¼ˆ5ç§’ï¼‰
- æŒä¹…åŒ–å®ä¾‹ï¼šæœåŠ¡ç«¯æ¢æµ‹ï¼ˆæ”¯æŒTCP/HTTP/MySQLï¼‰
- å¿«é€Ÿå‰”é™¤ï¼š30ç§’æœªå¿ƒè·³å³å‰”é™¤

Eurekaï¼ˆå•ä¸€ï¼‰:
- åªæ”¯æŒå®¢æˆ·ç«¯å¿ƒè·³ï¼ˆ30ç§’ï¼‰
- æ…¢é€Ÿå‰”é™¤ï¼š90ç§’æœªå¿ƒè·³æ‰å‰”é™¤
- è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼šç½‘ç»œåˆ†åŒºæ—¶å¯èƒ½ä¿ç•™å¤§é‡å·²æŒ‚æ‰çš„å®ä¾‹
```

2ï¸âƒ£ **æƒé‡é…ç½®**
```yaml
# Nacosæ”¯æŒæƒé‡é…ç½®ï¼ˆæˆ‘ä»¬é¡¹ç›®ä¸­ç”¨åˆ°ï¼‰
spring:
  cloud:
    nacos:
      discovery:
        weight: 1.0  # æƒé‡è¶Šé«˜ï¼Œæµé‡è¶Šå¤§
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ–°ç‰ˆæœ¬ç°åº¦å‘å¸ƒï¼šæ–°ç‰ˆæœ¬æƒé‡0.1ï¼Œè€ç‰ˆæœ¬æƒé‡0.9
- æœºå™¨æ€§èƒ½å·®å¼‚ï¼šé«˜é…æœºå™¨æƒé‡é«˜ï¼Œä½é…æœºå™¨æƒé‡ä½

3ï¸âƒ£ **é…ç½®ä¸­å¿ƒ**

Nacosè‡ªå¸¦é…ç½®ä¸­å¿ƒï¼Œæ— éœ€é¢å¤–éƒ¨ç½²ï¼š
```yaml
# bootstrap.yml
spring:
  cloud:
    nacos:
      config:
        server-addr: localhost:8848
        file-extension: yaml
        namespace: public
```

**ä¼˜åŠ¿**ï¼š
- åŠ¨æ€åˆ·æ–°é…ç½®ï¼ˆæ— éœ€é‡å¯æœåŠ¡ï¼‰
- é…ç½®ç‰ˆæœ¬ç®¡ç†å’Œå›æ»š
- ç°åº¦å‘å¸ƒé…ç½®

Eurekaéœ€è¦é¢å¤–å¼•å…¥Spring Cloud Config Serverï¼Œå¢åŠ äº†æ¶æ„å¤æ‚åº¦ã€‚

**ä¸ºä»€ä¹ˆæˆ‘ä»¬é¡¹ç›®é€‰æ‹© Nacosï¼Ÿ**

1. **ç»Ÿä¸€ç®¡ç†**ï¼šæ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒï¼Œå‡å°‘ç»„ä»¶æ•°é‡
2. **å¿«é€Ÿå“åº”**ï¼š30ç§’å‰”é™¤æ•…éšœå®ä¾‹ vs Eurekaçš„90ç§’
3. **ä¸­æ–‡å‹å¥½**ï¼šå›¢é˜Ÿå­¦ä¹ æˆæœ¬ä½ï¼Œæ–‡æ¡£ä¸°å¯Œ
4. **æƒé‡æ”¯æŒ**ï¼šæ–¹ä¾¿åšç°åº¦å‘å¸ƒå’Œæµé‡æ§åˆ¶
5. **ç¤¾åŒºæ´»è·ƒ**ï¼šé˜¿é‡Œç»´æŠ¤ï¼ŒSpring Cloud Alibabaç”Ÿæ€å®Œå–„

**çœŸå®æ”¶ç›Šï¼š**
> ä½¿ç”¨Nacosåï¼Œæˆ‘ä»¬çš„æœåŠ¡æ•…éšœå‘ç°æ—¶é—´ä»90ç§’é™ä½åˆ°30ç§’ï¼Œå‡å°‘äº†60ç§’çš„æ— æ•ˆè¯·æ±‚æ—¶é—´ã€‚åŒæ—¶é€šè¿‡é…ç½®ä¸­å¿ƒï¼Œå®ç°äº†å‘Šè­¦é˜ˆå€¼çš„åŠ¨æ€è°ƒæ•´ï¼Œæ— éœ€é‡å¯æœåŠ¡ã€‚

---

## äºŒã€Gateway ç½‘å…³ç›¸å…³é—®é¢˜

### â“ 2.1 Spring Cloud Gateway çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿè¯·æ±‚æ˜¯å¦‚ä½•è¢«è·¯ç”±çš„ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

GatewayåŸºäº**Reactoræ¨¡å‹**ï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰ï¼Œæ ¸å¿ƒæ˜¯**ä¸‰å¤§ç»„ä»¶**ï¼šRouteï¼ˆè·¯ç”±ï¼‰ã€Predicateï¼ˆæ–­è¨€ï¼‰ã€Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ã€‚

**å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹ï¼š**

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Gateway Handler Mapping              â”‚
â”‚    - æ ¹æ®æ–­è¨€åŒ¹é…è·¯ç”±è§„åˆ™                â”‚
â”‚    - æ‰¾åˆ°ç›®æ ‡å¾®æœåŠ¡                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Gateway Web Handler                  â”‚
â”‚    - æ„å»ºè¿‡æ»¤å™¨é“¾                        â”‚
â”‚    - Pre Filter æ‰§è¡Œ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Proxy Filter                         â”‚
â”‚    - é€šè¿‡Nettyå‘é€è¯·æ±‚åˆ°ç›®æ ‡æœåŠ¡         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç›®æ ‡å¾®æœåŠ¡å¤„ç†è¯·æ±‚                    â”‚
â”‚    (auth-service/monitor-serviceç­‰)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Gateway Web Handler                  â”‚
â”‚    - Post Filter æ‰§è¡Œ                   â”‚
â”‚    - å¤„ç†å“åº”                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
è¿”å›ç»™å®¢æˆ·ç«¯
```

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„é…ç½®ï¼š**

```yaml
# gateway-service/application.yml
spring:
  cloud:
    gateway:
      routes:
        # è®¤è¯æœåŠ¡è·¯ç”±
        - id: auth-service
          uri: lb://auth-service  # lb = LoadBalancedï¼Œä»Nacosæ‹‰å–å®ä¾‹
          predicates:
            - Path=/api/auth/**  # æ–­è¨€ï¼šè·¯å¾„åŒ¹é…
          filters:
            - StripPrefix=1  # è¿‡æ»¤å™¨ï¼šå»æ‰/apiå‰ç¼€

        # ç›‘æ§æœåŠ¡è·¯ç”±
        - id: monitor-service
          uri: lb://monitor-service
          predicates:
            - Path=/api/monitor/**
          filters:
            - StripPrefix=1
            - name: AuthFilter  # è‡ªå®šä¹‰è®¤è¯è¿‡æ»¤å™¨
```

**ä¸‰å¤§ç»„ä»¶è¯¦è§£ï¼š**

1ï¸âƒ£ **Routeï¼ˆè·¯ç”±ï¼‰**
- è·¯ç”±çš„å”¯ä¸€æ ‡è¯†ID
- ç›®æ ‡URIï¼ˆlb://æœåŠ¡å æˆ– http://å…·ä½“åœ°å€ï¼‰
- æ–­è¨€é›†åˆï¼ˆæ»¡è¶³æ‰€æœ‰æ–­è¨€æ‰åŒ¹é…ï¼‰
- è¿‡æ»¤å™¨é›†åˆ

2ï¸âƒ£ **Predicateï¼ˆæ–­è¨€ï¼‰**

å¸¸ç”¨æ–­è¨€ï¼š
```yaml
predicates:
  - Path=/api/monitor/**        # è·¯å¾„åŒ¹é…
  - Method=GET,POST             # æ–¹æ³•åŒ¹é…
  - Header=Authorization,.*     # è¯·æ±‚å¤´åŒ¹é…
  - Query=token                 # å‚æ•°åŒ¹é…
  - Before=2025-12-31T23:59:59  # æ—¶é—´åŒ¹é…ï¼ˆç°åº¦å‘å¸ƒï¼‰
```

3ï¸âƒ£ **Filterï¼ˆè¿‡æ»¤å™¨ï¼‰**

åˆ†ä¸ºä¸¤ç±»ï¼š
- **Gateway Filter**ï¼šå•ä¸ªè·¯ç”±çš„è¿‡æ»¤å™¨
- **Global Filter**ï¼šæ‰€æœ‰è·¯ç”±çš„å…¨å±€è¿‡æ»¤å™¨

```java
// AuthFilter.java - æˆ‘ä»¬é¡¹ç›®ä¸­çš„è‡ªå®šä¹‰è¿‡æ»¤å™¨
@Component
public class AuthFilter implements GlobalFilter, Ordered {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // Pre Filteré€»è¾‘
        String token = exchange.getRequest().getHeaders().getFirst("Authorization");

        // éªŒè¯Token
        if (!validateToken(token)) {
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }

        // æ”¾è¡Œ
        return chain.filter(exchange).then(Mono.fromRunnable(() -> {
            // Post Filteré€»è¾‘ï¼ˆåœ¨è¿™é‡Œå¤„ç†å“åº”ï¼‰
            log.info("Request processed");
        }));
    }
}
```

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```
åŸå§‹è¯·æ±‚: http://gateway:8080/api/monitor/data/latest/1

Gatewayå¤„ç†:
1. åŒ¹é…åˆ° monitor-service è·¯ç”±ï¼ˆPath=/api/monitor/**ï¼‰
2. æ‰§è¡Œ StripPrefix=1ï¼Œå»æ‰ /api
3. ä»Nacosè·å– monitor-service å®ä¾‹åˆ—è¡¨: [192.168.1.101:8083, 192.168.1.102:8083]
4. è´Ÿè½½å‡è¡¡é€‰æ‹©ä¸€ä¸ªå®ä¾‹: 192.168.1.101:8083
5. è½¬å‘è¯·æ±‚: http://192.168.1.101:8083/monitor/data/latest/1
6. è¿”å›å“åº”ç»™å®¢æˆ·ç«¯
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ Gateway è€Œä¸æ˜¯ Zuulï¼Ÿ**
- GatewayåŸºäº**Nettyå¼‚æ­¥éé˜»å¡**ï¼Œæ€§èƒ½æ›´é«˜
- ZuulåŸºäº**ServletåŒæ­¥é˜»å¡**ï¼Œéœ€è¦ä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é…çº¿ç¨‹
- Gatewayæ˜¯Springå®˜æ–¹æ¨èï¼Œä¸Spring Cloudç”Ÿæ€é›†æˆæ›´å¥½

---

### â“ 2.2 Gateway çš„å…¨å±€è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºæ˜¯æ€æ ·çš„ï¼Ÿå¦‚ä½•æ§åˆ¶é¡ºåºï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºç”± **Order å€¼**å†³å®šï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼ˆè¶Šæ—©æ‰§è¡Œï¼‰ã€‚

**è¿‡æ»¤å™¨åˆ†ç±»å’Œæ‰§è¡Œé¡ºåºï¼š**

```
è¯·æ±‚è¿›æ¥ â†’

Pre Filteré˜¶æ®µï¼ˆæŒ‰Orderä»å°åˆ°å¤§æ‰§è¡Œï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order=-1000: NettyWriteResponseFilter    â”‚ å†…ç½®è¿‡æ»¤å™¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Order=-100:  è‡ªå®šä¹‰LogFilter             â”‚ æ—¥å¿—è®°å½•
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Order=0:     è‡ªå®šä¹‰AuthFilter            â”‚ è®¤è¯é‰´æƒ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Order=100:   è‡ªå®šä¹‰RateLimitFilter       â”‚ é™æµ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    è½¬å‘åˆ°ç›®æ ‡æœåŠ¡
         â†“
Post Filteré˜¶æ®µï¼ˆæŒ‰Orderä»å¤§åˆ°å°æ‰§è¡Œï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order=100:   è‡ªå®šä¹‰RateLimitFilter       â”‚ å“åº”å¤„ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Order=0:     è‡ªå®šä¹‰AuthFilter            â”‚ æ¸…ç†ä¸Šä¸‹æ–‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Order=-100:  è‡ªå®šä¹‰LogFilter             â”‚ è®°å½•å“åº”æ—¶é—´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Order=-1000: NettyWriteResponseFilter    â”‚ å†™å›å“åº”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
      è¿”å›ç»™å®¢æˆ·ç«¯
```

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„å®ç°ï¼š**

```java
// 1. æ—¥å¿—è¿‡æ»¤å™¨ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰
@Component
@Order(-100)
public class LogFilter implements GlobalFilter, Ordered {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        long startTime = System.currentTimeMillis();
        String path = exchange.getRequest().getPath().value();

        log.info("ğŸ”µ è¯·æ±‚å¼€å§‹ - Path: {}", path);

        return chain.filter(exchange).then(Mono.fromRunnable(() -> {
            long duration = System.currentTimeMillis() - startTime;
            log.info("ğŸŸ¢ è¯·æ±‚å®Œæˆ - Path: {}, è€—æ—¶: {}ms", path, duration);
        }));
    }

    @Override
    public int getOrder() {
        return -100;
    }
}

// 2. è®¤è¯è¿‡æ»¤å™¨ï¼ˆå…¶æ¬¡æ‰§è¡Œï¼‰
@Component
@Order(0)
public class AuthFilter implements GlobalFilter, Ordered {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String path = exchange.getRequest().getPath().value();

        // ç™½åå•æ”¾è¡Œ
        if (isWhitelist(path)) {
            return chain.filter(exchange);
        }

        // éªŒè¯JWT Token
        String token = exchange.getRequest().getHeaders().getFirst("Authorization");
        if (!JwtUtil.validateToken(token)) {
            return unauthorized(exchange);
        }

        // è§£æç”¨æˆ·ä¿¡æ¯å¹¶æ·»åŠ åˆ°è¯·æ±‚å¤´ï¼ˆä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡ï¼‰
        Long userId = JwtUtil.getUserId(token);
        ServerHttpRequest modifiedRequest = exchange.getRequest().mutate()
            .header("X-User-Id", userId.toString())
            .build();

        return chain.filter(exchange.mutate().request(modifiedRequest).build());
    }

    @Override
    public int getOrder() {
        return 0;
    }
}

// 3. é™æµè¿‡æ»¤å™¨ï¼ˆæœ€åæ‰§è¡Œï¼‰
@Component
@Order(100)
public class RateLimitFilter implements GlobalFilter, Ordered {
    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String clientIp = getClientIp(exchange);
        String key = "rate_limit:" + clientIp;

        // Redisè®¡æ•°å™¨é™æµï¼ˆä»¤ç‰Œæ¡¶ç®—æ³•ï¼‰
        Long count = redisTemplate.opsForValue().increment(key);
        if (count == 1) {
            redisTemplate.expire(key, 1, TimeUnit.SECONDS);
        }

        if (count > 100) {  // æ¯ç§’100æ¬¡
            return tooManyRequests(exchange);
        }

        return chain.filter(exchange);
    }

    @Override
    public int getOrder() {
        return 100;
    }
}
```

**æ‰§è¡Œé¡ºåºç¤ºä¾‹ï¼š**

```
å®¢æˆ·ç«¯è¯·æ±‚: GET /api/monitor/data/latest/1

1. LogFilter (Order=-100)
   â””â”€ è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´

2. AuthFilter (Order=0)
   â”œâ”€ æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨ç™½åå•
   â”œâ”€ éªŒè¯JWT Token
   â””â”€ è§£æuserIdå¹¶æ·»åŠ åˆ°è¯·æ±‚å¤´: X-User-Id: 123

3. RateLimitFilter (Order=100)
   â”œâ”€ æ£€æŸ¥IPé™æµ
   â””â”€ æ”¾è¡Œ

4. è½¬å‘åˆ° monitor-service

5. monitor-service è¿”å›å“åº”

6. RateLimitFilter (Order=100)
   â””â”€ å“åº”åå¤„ç†ï¼ˆå¦‚æœæœ‰ï¼‰

7. AuthFilter (Order=0)
   â””â”€ æ¸…ç†ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœæœ‰ï¼‰

8. LogFilter (Order=-100)
   â””â”€ è®°å½•è¯·æ±‚è€—æ—¶: 150ms

9. è¿”å›ç»™å®¢æˆ·ç«¯
```

**å¸¸è§Orderå€¼è§„èŒƒï¼š**
```
-1000 ~ -500:  å†…ç½®æ ¸å¿ƒè¿‡æ»¤å™¨ï¼ˆå¦‚NettyWriteResponseFilterï¼‰
-500 ~ -100:   æ—¥å¿—ã€ç›‘æ§ç±»è¿‡æ»¤å™¨
-100 ~ 0:      è®¤è¯ã€é‰´æƒç±»è¿‡æ»¤å™¨
0 ~ 100:       é™æµã€ç†”æ–­ç±»è¿‡æ»¤å™¨
100 ~ 500:     ä¸šåŠ¡é€»è¾‘è¿‡æ»¤å™¨
500+:          å“åº”å¤„ç†è¿‡æ»¤å™¨
```

**å¦‚ä½•æ§åˆ¶é¡ºåºï¼Ÿ**

æ–¹æ³•1: å®ç° `Ordered` æ¥å£
```java
@Override
public int getOrder() {
    return 0;
}
```

æ–¹æ³•2: ä½¿ç”¨ `@Order` æ³¨è§£
```java
@Component
@Order(0)
public class AuthFilter implements GlobalFilter {
    // ...
}
```

**æ³¨æ„äº‹é¡¹ï¼š**
- Orderå€¼ç›¸åŒæ—¶ï¼Œæ‰§è¡Œé¡ºåºä¸ç¡®å®š
- Pre FilteræŒ‰Orderä»å°åˆ°å¤§ï¼ŒPost FilteræŒ‰Orderä»å¤§åˆ°å°
- ä¸è¦æ»¥ç”¨å…¨å±€è¿‡æ»¤å™¨ï¼Œå½±å“æ‰€æœ‰è¯·æ±‚çš„æ€§èƒ½

---

### â“ 2.3 å¦‚ä½•åœ¨ Gateway ä¸­ä¼ é€’ç”¨æˆ·ä¿¡æ¯ç»™ä¸‹æ¸¸å¾®æœåŠ¡ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

æˆ‘ä»¬é‡‡ç”¨ **JWT + è¯·æ±‚å¤´ä¼ é€’** çš„æ–¹å¼ï¼Œåœ¨Gatewayè§£æJWTåï¼Œå°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚å¤´ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡ã€‚

**å®Œæ•´æµç¨‹ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯  â”‚ â”€â”€â”€1â”€â”€â”€â–º â”‚ Gateway â”‚ â”€â”€â”€2â”€â”€â”€â–º â”‚ ä¸‹æ¸¸å¾®æœåŠ¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”œâ”€ 1. æ¥æ”¶è¯·æ±‚
                         â”‚   Header: Authorization: Bearer eyJhbGc...
                         â”‚
                         â”œâ”€ 2. AuthFilter éªŒè¯JWT
                         â”‚   â””â”€ JwtUtil.validateToken(token)
                         â”‚
                         â”œâ”€ 3. è§£æç”¨æˆ·ä¿¡æ¯
                         â”‚   â”œâ”€ userId: 123
                         â”‚   â”œâ”€ username: "admin"
                         â”‚   â””â”€ roles: ["ADMIN"]
                         â”‚
                         â”œâ”€ 4. æ·»åŠ åˆ°è¯·æ±‚å¤´
                         â”‚   â”œâ”€ X-User-Id: 123
                         â”‚   â”œâ”€ X-Username: admin
                         â”‚   â””â”€ X-User-Roles: ADMIN
                         â”‚
                         â””â”€ 5. è½¬å‘è¯·æ±‚
                             Header: Authorization: Bearer eyJhbGc...
                             Header: X-User-Id: 123
                             Header: X-Username: admin
                             Header: X-User-Roles: ADMIN
```

**Gateway ç«¯å®ç°ï¼ˆAuthFilterï¼‰ï¼š**

```java
// gateway-service/src/main/java/com/sewage/gateway/filter/AuthFilter.java
@Component
@Slf4j
public class AuthFilter implements GlobalFilter, Ordered {

    @Autowired
    private JwtUtil jwtUtil;

    // ç™½åå•è·¯å¾„ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰
    private static final List<String> WHITELIST = Arrays.asList(
        "/api/auth/login",
        "/api/auth/register",
        "/ws/realtime"  // WebSocketè¿æ¥
    );

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String path = exchange.getRequest().getPath().value();

        // 1. ç™½åå•æ”¾è¡Œ
        if (isWhitelist(path)) {
            return chain.filter(exchange);
        }

        // 2. è·å–Token
        String token = exchange.getRequest().getHeaders().getFirst("Authorization");
        if (token == null || !token.startsWith("Bearer ")) {
            return unauthorized(exchange, "Missing token");
        }

        // 3. éªŒè¯Token
        token = token.substring(7);  // å»æ‰ "Bearer "
        try {
            if (!jwtUtil.validateToken(token)) {
                return unauthorized(exchange, "Invalid token");
            }
        } catch (Exception e) {
            return unauthorized(exchange, "Token validation failed");
        }

        // 4. è§£æç”¨æˆ·ä¿¡æ¯
        Long userId = jwtUtil.getUserId(token);
        String username = jwtUtil.getUsername(token);
        String roles = jwtUtil.getRoles(token);

        log.info("ğŸ”‘ è®¤è¯æˆåŠŸ - UserId: {}, Username: {}", userId, username);

        // 5. æ·»åŠ åˆ°è¯·æ±‚å¤´ï¼ˆä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡ï¼‰
        ServerHttpRequest modifiedRequest = exchange.getRequest().mutate()
            .header("X-User-Id", userId.toString())
            .header("X-Username", username)
            .header("X-User-Roles", roles)
            .build();

        // 6. ç»§ç»­è¿‡æ»¤å™¨é“¾
        return chain.filter(exchange.mutate().request(modifiedRequest).build());
    }

    private boolean isWhitelist(String path) {
        return WHITELIST.stream().anyMatch(path::startsWith);
    }

    private Mono<Void> unauthorized(ServerWebExchange exchange, String message) {
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        exchange.getResponse().getHeaders().setContentType(MediaType.APPLICATION_JSON);

        String body = "{\"code\":401,\"message\":\"" + message + "\"}";
        DataBuffer buffer = exchange.getResponse().bufferFactory().wrap(body.getBytes());
        return exchange.getResponse().writeWith(Mono.just(buffer));
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
```

**ä¸‹æ¸¸æœåŠ¡ç«¯æ¥æ”¶ï¼ˆUserInterceptorï¼‰ï¼š**

```java
// monitor-service/src/main/java/com/sewage/monitor/interceptor/UserInterceptor.java
@Component
@Slf4j
public class UserInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 1. ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯
        String userIdHeader = request.getHeader("X-User-Id");
        String username = request.getHeader("X-Username");
        String roles = request.getHeader("X-User-Roles");

        // 2. å­˜å‚¨åˆ°ThreadLocalï¼ˆæ–¹ä¾¿Controllerä½¿ç”¨ï¼‰
        if (userIdHeader != null) {
            Long userId = Long.parseLong(userIdHeader);
            UserContext.setUserId(userId);
            UserContext.setUsername(username);
            UserContext.setRoles(roles);

            log.debug("ğŸ‘¤ ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®æˆåŠŸ - UserId: {}, Username: {}", userId, username);
        }

        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response,
                                 Object handler, Exception ex) {
        // 3. è¯·æ±‚ç»“æŸåæ¸…ç†ThreadLocalï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
        UserContext.clear();
    }
}

// é…ç½®æ‹¦æˆªå™¨
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Autowired
    private UserInterceptor userInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(userInterceptor)
            .addPathPatterns("/**")
            .excludePathPatterns("/error", "/ws/**");
    }
}
```

**Controller ä¸­ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯ï¼š**

```java
// monitor-service/src/main/java/com/sewage/monitor/controller/MonitorController.java
@RestController
@RequestMapping("/monitor")
public class MonitorController {

    @GetMapping("/data/latest/{labId}")
    public Result<LabEnvironmentData> getLatestData(@PathVariable Long labId) {
        // ä»ThreadLocalè·å–å½“å‰ç”¨æˆ·ID
        Long userId = UserContext.getUserId();
        String username = UserContext.getUsername();

        log.info("ç”¨æˆ·{}({}) æŸ¥è¯¢å®éªŒå®¤{}çš„æœ€æ–°æ•°æ®", username, userId, labId);

        // ä¸šåŠ¡é€»è¾‘...
        return Result.success(data);
    }
}
```

**UserContext å·¥å…·ç±»ï¼š**

```java
// common/src/main/java/com/sewage/common/context/UserContext.java
public class UserContext {
    private static final ThreadLocal<Long> USER_ID = new ThreadLocal<>();
    private static final ThreadLocal<String> USERNAME = new ThreadLocal<>();
    private static final ThreadLocal<String> ROLES = new ThreadLocal<>();

    public static void setUserId(Long userId) {
        USER_ID.set(userId);
    }

    public static Long getUserId() {
        return USER_ID.get();
    }

    public static void setUsername(String username) {
        USERNAME.set(username);
    }

    public static String getUsername() {
        return USERNAME.get();
    }

    public static void setRoles(String roles) {
        ROLES.set(roles);
    }

    public static String getRoles() {
        return ROLES.get();
    }

    public static void clear() {
        USER_ID.remove();
        USERNAME.remove();
        ROLES.remove();
    }
}
```

**ä¸ºä»€ä¹ˆä¸ç›´æ¥ä¼ é€’JWT Tokenï¼Ÿ**

æ–¹æ¡ˆå¯¹æ¯”ï¼š

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|-----|------|------|
| **ä¼ é€’JWT** | ç®€å•ï¼Œä¸‹æ¸¸æœåŠ¡å¯ä»¥è‡ªå·±éªŒè¯ | æ¯ä¸ªæœåŠ¡éƒ½è¦éªŒè¯JWTï¼Œé‡å¤è§£æï¼Œæ€§èƒ½å·® |
| **ä¼ é€’è¯·æ±‚å¤´** | Gatewayç»Ÿä¸€éªŒè¯ï¼Œä¸‹æ¸¸æœåŠ¡ç›´æ¥ä½¿ç”¨ | ä¾èµ–Gatewayï¼ŒæœåŠ¡é—´è°ƒç”¨éœ€è¦æ‰‹åŠ¨ä¼ é€’ |

æˆ‘ä»¬é€‰æ‹©**ä¼ é€’è¯·æ±‚å¤´**çš„åŸå› ï¼š
1. **æ€§èƒ½ä¼˜åŒ–**ï¼šJWTéªŒè¯åªåœ¨Gatewayåšä¸€æ¬¡ï¼Œé¿å…é‡å¤è§£æ
2. **ç»Ÿä¸€è®¤è¯**ï¼šè®¤è¯é€»è¾‘é›†ä¸­åœ¨Gatewayï¼Œä¸‹æ¸¸æœåŠ¡æ— éœ€å…³å¿ƒJWT
3. **ç®€åŒ–å¼€å‘**ï¼šä¸‹æ¸¸æœåŠ¡ç›´æ¥ä»ThreadLocalè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä»£ç ç®€æ´

**å®‰å…¨æ€§è€ƒè™‘ï¼š**
- è¯·æ±‚å¤´ä¿¡æ¯åªåœ¨å†…ç½‘ä¼ é€’ï¼Œå¤–éƒ¨æ— æ³•ä¼ªé€ 
- å¦‚æœéœ€è¦æ›´é«˜å®‰å…¨æ€§ï¼Œå¯ä»¥å¯¹è¯·æ±‚å¤´è¿›è¡Œç­¾åéªŒè¯

---

### â“ 2.4 Gateway å¦‚ä½•å®ç°é™æµï¼Ÿå¸¸è§çš„é™æµç®—æ³•æœ‰å“ªäº›ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

Gatewayæä¾›äº†å†…ç½®çš„é™æµè¿‡æ»¤å™¨ï¼ŒåŸºäº**Redis + Luaè„šæœ¬**å®ç°ï¼Œæˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨äº†**ä»¤ç‰Œæ¡¶ç®—æ³•**ã€‚

**å¸¸è§é™æµç®—æ³•å¯¹æ¯”ï¼š**

| ç®—æ³• | åŸç† | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|------|---------|
| **å›ºå®šçª—å£** | å›ºå®šæ—¶é—´æ®µå†…è®¡æ•° | å®ç°ç®€å• | è¾¹ç•Œçªåˆºé—®é¢˜ | ç²—ç²’åº¦é™æµ |
| **æ»‘åŠ¨çª—å£** | æ—¶é—´çª—å£æ»‘åŠ¨è®¡æ•° | å¹³æ»‘é™æµ | å†…å­˜å ç”¨é«˜ | ç²¾ç¡®é™æµ |
| **æ¼æ¡¶** | å›ºå®šé€Ÿç‡æµå‡º | æµé‡å¹³æ»‘ | æ— æ³•åº”å¯¹çªå‘ | æ¶ˆæ¯é˜Ÿåˆ— |
| **ä»¤ç‰Œæ¡¶** | å›ºå®šé€Ÿç‡ç”Ÿæˆä»¤ç‰Œ | å…è®¸çªå‘æµé‡ | å®ç°å¤æ‚ | APIç½‘å…³ï¼ˆæ¨èï¼‰ |

**ä»¤ç‰Œæ¡¶ç®—æ³•åŸç†ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä»¤ç‰Œæ¡¶ (Capacity=100)        â”‚
â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”     â”‚
â”‚  â”‚ T â”‚ T â”‚ T â”‚ T â”‚ T â”‚ T â”‚ T â”‚...  â”‚  T = Token
â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜     â”‚
â”‚                                     â”‚
â”‚  â†‘ æ¯ç§’æ”¾å…¥10ä¸ªä»¤ç‰Œ                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ è¯·æ±‚åˆ°è¾¾
         â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ è·å–ä»¤ç‰Œ  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€ æœ‰ä»¤ç‰Œï¼Ÿ â†’ æ”¾è¡Œè¯·æ±‚
        â”‚
        â””â”€ æ— ä»¤ç‰Œï¼Ÿ â†’ æ‹’ç»è¯·æ±‚ï¼ˆ429 Too Many Requestsï¼‰
```

**ç‰¹ç‚¹ï¼š**
- **å®¹é‡ï¼ˆCapacityï¼‰**ï¼šæ¡¶èƒ½è£…å¤šå°‘ä»¤ç‰Œï¼ˆå…è®¸çªå‘æµé‡ï¼‰
- **é€Ÿç‡ï¼ˆRateï¼‰**ï¼šæ¯ç§’æ”¾å…¥å¤šå°‘ä»¤ç‰Œï¼ˆå¹³å‡é™æµï¼‰
- **å…è®¸çªå‘**ï¼šå¦‚æœæ¡¶é‡Œæœ‰100ä¸ªä»¤ç‰Œï¼Œå¯ä»¥ç¬é—´å¤„ç†100ä¸ªè¯·æ±‚

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„å®ç°ï¼š**

**æ–¹å¼1: ä½¿ç”¨ Gateway å†…ç½®é™æµï¼ˆåŸºäºRedisï¼‰**

```yaml
# gateway-service/application.yml
spring:
  cloud:
    gateway:
      routes:
        - id: monitor-service
          uri: lb://monitor-service
          predicates:
            - Path=/api/monitor/**
          filters:
            - name: RequestRateLimiter
              args:
                # ä½¿ç”¨Rediså®ç°çš„ä»¤ç‰Œæ¡¶ç®—æ³•
                redis-rate-limiter.replenishRate: 10  # æ¯ç§’æ”¾å…¥10ä¸ªä»¤ç‰Œ
                redis-rate-limiter.burstCapacity: 20  # æ¡¶å®¹é‡20ï¼ˆå…è®¸çªå‘ï¼‰
                redis-rate-limiter.requestedTokens: 1  # æ¯æ¬¡è¯·æ±‚æ¶ˆè€—1ä¸ªä»¤ç‰Œ
                key-resolver: "#{@ipKeyResolver}"  # æŒ‰IPé™æµ
```

**è‡ªå®šä¹‰KeyResolverï¼ˆé™æµç»´åº¦ï¼‰ï¼š**

```java
// gateway-service/src/main/java/com/sewage/gateway/config/RateLimitConfig.java
@Configuration
public class RateLimitConfig {

    // æŒ‰IPé™æµ
    @Bean
    public KeyResolver ipKeyResolver() {
        return exchange -> {
            String ip = getClientIp(exchange);
            return Mono.just(ip);
        };
    }

    // æŒ‰ç”¨æˆ·é™æµ
    @Bean
    public KeyResolver userKeyResolver() {
        return exchange -> {
            String userId = exchange.getRequest().getHeaders().getFirst("X-User-Id");
            return Mono.just(userId != null ? userId : "anonymous");
        };
    }

    // æŒ‰æ¥å£é™æµ
    @Bean
    public KeyResolver apiKeyResolver() {
        return exchange -> {
            String path = exchange.getRequest().getPath().value();
            return Mono.just(path);
        };
    }

    private String getClientIp(ServerWebExchange exchange) {
        String ip = exchange.getRequest().getHeaders().getFirst("X-Forwarded-For");
        if (ip == null) {
            ip = exchange.getRequest().getRemoteAddress().getAddress().getHostAddress();
        }
        return ip;
    }
}
```

**æ–¹å¼2: è‡ªå®šä¹‰é™æµè¿‡æ»¤å™¨ï¼ˆæ›´çµæ´»ï¼‰**

```java
// gateway-service/src/main/java/com/sewage/gateway/filter/CustomRateLimitFilter.java
@Component
@Slf4j
public class CustomRateLimitFilter implements GlobalFilter, Ordered {

    @Autowired
    private StringRedisTemplate redisTemplate;

    // Luaè„šæœ¬å®ç°ä»¤ç‰Œæ¡¶ï¼ˆåŸå­æ€§æ“ä½œï¼‰
    private static final String LUA_SCRIPT =
        "local key = KEYS[1] " +
        "local capacity = tonumber(ARGV[1]) " +  // æ¡¶å®¹é‡
        "local rate = tonumber(ARGV[2]) " +      // ä»¤ç‰Œç”Ÿæˆé€Ÿç‡
        "local requested = tonumber(ARGV[3]) " + // è¯·æ±‚ä»¤ç‰Œæ•°
        "local now = tonumber(ARGV[4]) " +       // å½“å‰æ—¶é—´æˆ³

        "local bucket = redis.call('HMGET', key, 'tokens', 'last_time') " +
        "local tokens = tonumber(bucket[1]) or capacity " +
        "local last_time = tonumber(bucket[2]) or now " +

        "local delta = math.max(0, now - last_time) " +
        "local new_tokens = math.min(capacity, tokens + delta * rate) " +

        "if new_tokens >= requested then " +
        "  redis.call('HMSET', key, 'tokens', new_tokens - requested, 'last_time', now) " +
        "  redis.call('EXPIRE', key, 60) " +
        "  return 1 " +  // æˆåŠŸè·å–ä»¤ç‰Œ
        "else " +
        "  redis.call('HMSET', key, 'tokens', new_tokens, 'last_time', now) " +
        "  redis.call('EXPIRE', key, 60) " +
        "  return 0 " +  // ä»¤ç‰Œä¸è¶³
        "end";

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String path = exchange.getRequest().getPath().value();

        // åªå¯¹ç‰¹å®šæ¥å£é™æµ
        if (!path.startsWith("/api/monitor/data")) {
            return chain.filter(exchange);
        }

        // è·å–é™æµKeyï¼ˆæŒ‰IPï¼‰
        String ip = getClientIp(exchange);
        String key = "rate_limit:monitor:" + ip;

        // æ‰§è¡ŒLuaè„šæœ¬
        DefaultRedisScript<Long> script = new DefaultRedisScript<>(LUA_SCRIPT, Long.class);
        Long result = redisTemplate.execute(
            script,
            Collections.singletonList(key),
            "20",  // capacity: æ¡¶å®¹é‡20
            "10",  // rate: æ¯ç§’ç”Ÿæˆ10ä¸ªä»¤ç‰Œ
            "1",   // requested: è¯·æ±‚1ä¸ªä»¤ç‰Œ
            String.valueOf(System.currentTimeMillis() / 1000)  // å½“å‰æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
        );

        if (result == 1) {
            // è·å–ä»¤ç‰ŒæˆåŠŸï¼Œæ”¾è¡Œ
            return chain.filter(exchange);
        } else {
            // ä»¤ç‰Œä¸è¶³ï¼Œé™æµ
            log.warn("ğŸš« é™æµè§¦å‘ - IP: {}, Path: {}", ip, path);
            return tooManyRequests(exchange);
        }
    }

    private Mono<Void> tooManyRequests(ServerWebExchange exchange) {
        exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);
        exchange.getResponse().getHeaders().setContentType(MediaType.APPLICATION_JSON);

        String body = "{\"code\":429,\"message\":\"Too many requests, please try again later\"}";
        DataBuffer buffer = exchange.getResponse().bufferFactory().wrap(body.getBytes());
        return exchange.getResponse().writeWith(Mono.just(buffer));
    }

    private String getClientIp(ServerWebExchange exchange) {
        String ip = exchange.getRequest().getHeaders().getFirst("X-Forwarded-For");
        if (ip == null) {
            ip = exchange.getRequest().getRemoteAddress().getAddress().getHostAddress();
        }
        return ip;
    }

    @Override
    public int getOrder() {
        return 100;
    }
}
```

**é™æµæ•ˆæœæµ‹è¯•ï¼š**

```bash
# æ¨¡æ‹Ÿé«˜å¹¶å‘è¯·æ±‚
for i in {1..100}; do
  curl -w " - çŠ¶æ€ç : %{http_code}\n" http://localhost:8080/api/monitor/data/latest/1
done

# ç»“æœï¼š
# å‰20ä¸ªè¯·æ±‚: 200 OK (æ¡¶å®¹é‡20)
# ä¹‹åæ¯ç§’é€šè¿‡10ä¸ªè¯·æ±‚: 200 OK (ä»¤ç‰Œç”Ÿæˆé€Ÿç‡10/s)
# è¶…å‡ºé™æµçš„è¯·æ±‚: 429 Too Many Requests
```

**é™æµç»´åº¦é€‰æ‹©ï¼š**

```java
// 1. æŒ‰IPé™æµï¼ˆé˜²åˆ·æ¥å£ï¼‰
String key = "rate_limit:ip:" + ip;

// 2. æŒ‰ç”¨æˆ·é™æµï¼ˆé˜²æ­¢å•ä¸ªç”¨æˆ·å ç”¨èµ„æºï¼‰
String key = "rate_limit:user:" + userId;

// 3. æŒ‰æ¥å£é™æµï¼ˆä¿æŠ¤æ ¸å¿ƒæ¥å£ï¼‰
String key = "rate_limit:api:" + path;

// 4. ç»„åˆé™æµï¼ˆIP + æ¥å£ï¼‰
String key = "rate_limit:ip:" + ip + ":api:" + path;
```

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„åº”ç”¨åœºæ™¯ï¼š**

1. **æ•°æ®ä¸ŠæŠ¥æ¥å£**ï¼šä¼ æ„Ÿå™¨æ¯ç§’ä¸ŠæŠ¥æ•°æ®ï¼Œé™åˆ¶æ¯ä¸ªå®éªŒå®¤æ¯ç§’100æ¬¡
2. **ç»Ÿè®¡æŸ¥è¯¢æ¥å£**ï¼šå¤æ‚ç»Ÿè®¡æŸ¥è¯¢ï¼Œé™åˆ¶æ¯ä¸ªç”¨æˆ·æ¯ç§’10æ¬¡
3. **æŠ¥è¡¨ç”Ÿæˆæ¥å£**ï¼šè€—èµ„æºæ“ä½œï¼Œé™åˆ¶æ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿ1æ¬¡

**é™æµ vs ç†”æ–­ï¼š**
- **é™æµ**ï¼šä¸»åŠ¨ä¿æŠ¤ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½
- **ç†”æ–­**ï¼šè¢«åŠ¨ä¿æŠ¤ï¼Œå‘ç°æ•…éšœåå¿«é€Ÿå¤±è´¥

ä¸¤è€…ç»“åˆä½¿ç”¨ï¼Œæ•ˆæœæ›´å¥½ã€‚

---

## ä¸‰ã€è®¤è¯é‰´æƒç›¸å…³é—®é¢˜

### â“ 3.1 ä½ ä»¬é¡¹ç›®çš„è®¤è¯æµç¨‹æ˜¯æ€æ ·çš„ï¼ŸJWT æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

æˆ‘ä»¬é‡‡ç”¨ **JWTï¼ˆJSON Web Tokenï¼‰+ Gatewayç»Ÿä¸€è®¤è¯** çš„æ–¹å¼ï¼Œå®ç°äº†æ— çŠ¶æ€çš„è®¤è¯æœºåˆ¶ã€‚

**å®Œæ•´çš„è®¤è¯æµç¨‹ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚                â”‚ Gateway  â”‚                â”‚ auth-service â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                           â”‚                             â”‚
     â”‚ 1. ç™»å½•è¯·æ±‚                â”‚                             â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
     â”‚ POST /api/auth/login       â”‚                             â”‚
     â”‚ {username, password}       â”‚                             â”‚
     â”‚                           â”‚ 2. è½¬å‘ç™»å½•è¯·æ±‚              â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                           â”‚                             â”‚
     â”‚                           â”‚                             â”‚ 3. éªŒè¯å¯†ç 
     â”‚                           â”‚                             â”‚   (BCrypt)
     â”‚                           â”‚                             â”‚
     â”‚                           â”‚ 4. è¿”å›JWT Token            â”‚
     â”‚                           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ 5. è¿”å›Token               â”‚ {token: "eyJhbGc..."}       â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
     â”‚ {                         â”‚                             â”‚
     â”‚   code: 200,              â”‚                             â”‚
     â”‚   data: {                 â”‚                             â”‚
     â”‚     token: "eyJhbGc...",  â”‚                             â”‚
     â”‚     userId: 123,          â”‚                             â”‚
     â”‚     username: "admin"     â”‚                             â”‚
     â”‚   }                       â”‚                             â”‚
     â”‚ }                         â”‚                             â”‚
     â”‚                           â”‚                             â”‚
     â”‚ 6. æºå¸¦Tokenè®¿é—®API        â”‚                             â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
     â”‚ Header: Authorization:    â”‚                             â”‚
     â”‚   Bearer eyJhbGc...       â”‚                             â”‚
     â”‚                           â”‚                             â”‚
     â”‚                           â”‚ 7. AuthFilteréªŒè¯Token      â”‚
     â”‚                           â”‚   â”œâ”€ è§£æJWT                â”‚
     â”‚                           â”‚   â”œâ”€ éªŒè¯ç­¾å                â”‚
     â”‚                           â”‚   â”œâ”€ æ£€æŸ¥è¿‡æœŸ                â”‚
     â”‚                           â”‚   â””â”€ æå–ç”¨æˆ·ä¿¡æ¯            â”‚
     â”‚                           â”‚                             â”‚
     â”‚                           â”‚ 8. æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´      â”‚
     â”‚                           â”‚   X-User-Id: 123            â”‚
     â”‚                           â”‚   X-Username: admin         â”‚
     â”‚                           â”‚                             â”‚
     â”‚                           â”‚ 9. è½¬å‘åˆ°ä¸šåŠ¡æœåŠ¡            â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º monitor-service
     â”‚                           â”‚
     â”‚ 10. è¿”å›ä¸šåŠ¡æ•°æ®           â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚
```

**JWT Token ç»“æ„ï¼š**

JWTç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œç”¨ `.` åˆ†éš”ï¼š

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEyMywidXNlcm5hbWUiOiJhZG1pbiIsImV4cCI6MTcwMDAwMDAwMH0.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
â”‚                                     â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Headerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Payloadâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€Signatureâ”€â”€â”€â”€â”€â”€â”€â”€â”€
```

**1. Headerï¼ˆå¤´éƒ¨ï¼‰**
```json
{
  "alg": "HS256",  // ç­¾åç®—æ³•
  "typ": "JWT"     // ä»¤ç‰Œç±»å‹
}
```

**2. Payloadï¼ˆè´Ÿè½½ï¼‰** - å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
```json
{
  "userId": 123,
  "username": "admin",
  "roles": "ADMIN,USER",
  "iat": 1700000000,  // ç­¾å‘æ—¶é—´
  "exp": 1700086400   // è¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶åï¼‰
}
```

**3. Signatureï¼ˆç­¾åï¼‰** - é˜²æ­¢ç¯¡æ”¹
```
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret  // å¯†é’¥ï¼ˆåªæœ‰æœåŠ¡ç«¯çŸ¥é“ï¼‰
)
```

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„å®ç°ï¼š**

**1. JWTå·¥å…·ç±»ï¼ˆcommonæ¨¡å—ï¼‰ï¼š**

```java
// common/src/main/java/com/sewage/common/util/JwtUtil.java
@Component
public class JwtUtil {

    // å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒåº”è¯¥ä»é…ç½®ä¸­å¿ƒè¯»å–ï¼‰
    private static final String SECRET = "lab-platform-secret-key-2024";

    // Tokenæœ‰æ•ˆæœŸï¼š24å°æ—¶
    private static final long EXPIRATION = 24 * 60 * 60 * 1000;

    /**
     * ç”ŸæˆToken
     */
    public String generateToken(Long userId, String username, String roles) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + EXPIRATION);

        return Jwts.builder()
            .setSubject(userId.toString())  // ä¸»é¢˜ï¼ˆç”¨æˆ·IDï¼‰
            .claim("username", username)    // è‡ªå®šä¹‰å£°æ˜
            .claim("roles", roles)
            .setIssuedAt(now)               // ç­¾å‘æ—¶é—´
            .setExpiration(expiryDate)      // è¿‡æœŸæ—¶é—´
            .signWith(SignatureAlgorithm.HS256, SECRET)  // ç­¾å
            .compact();
    }

    /**
     * éªŒè¯Token
     */
    public boolean validateToken(String token) {
        try {
            Jwts.parser()
                .setSigningKey(SECRET)
                .parseClaimsJws(token);
            return true;
        } catch (SignatureException e) {
            log.error("Invalid JWT signature: {}", e.getMessage());
        } catch (MalformedJwtException e) {
            log.error("Invalid JWT token: {}", e.getMessage());
        } catch (ExpiredJwtException e) {
            log.error("JWT token is expired: {}", e.getMessage());
        } catch (UnsupportedJwtException e) {
            log.error("JWT token is unsupported: {}", e.getMessage());
        } catch (IllegalArgumentException e) {
            log.error("JWT claims string is empty: {}", e.getMessage());
        }
        return false;
    }

    /**
     * ä»Tokenä¸­è·å–ç”¨æˆ·ID
     */
    public Long getUserId(String token) {
        Claims claims = Jwts.parser()
            .setSigningKey(SECRET)
            .parseClaimsJws(token)
            .getBody();
        return Long.parseLong(claims.getSubject());
    }

    /**
     * ä»Tokenä¸­è·å–ç”¨æˆ·å
     */
    public String getUsername(String token) {
        Claims claims = Jwts.parser()
            .setSigningKey(SECRET)
            .parseClaimsJws(token)
            .getBody();
        return claims.get("username", String.class);
    }

    /**
     * ä»Tokenä¸­è·å–è§’è‰²
     */
    public String getRoles(String token) {
        Claims claims = Jwts.parser()
            .setSigningKey(SECRET)
            .parseClaimsJws(token)
            .getBody();
        return claims.get("roles", String.class);
    }

    /**
     * è·å–Tokenè¿‡æœŸæ—¶é—´
     */
    public Date getExpirationDate(String token) {
        Claims claims = Jwts.parser()
            .setSigningKey(SECRET)
            .parseClaimsJws(token)
            .getBody();
        return claims.getExpiration();
    }
}
```

**2. ç™»å½•æ¥å£ï¼ˆauth-serviceï¼‰ï¼š**

```java
// auth-service/src/main/java/com/sewage/auth/controller/AuthController.java
@RestController
@RequestMapping("/auth")
@RequiredArgsConstructor
public class AuthController {

    private final UserMapper userMapper;
    private final JwtUtil jwtUtil;
    private final PasswordEncoder passwordEncoder;

    /**
     * ç”¨æˆ·ç™»å½•
     */
    @PostMapping("/login")
    public Result<LoginResponse> login(@RequestBody LoginRequest request) {
        // 1. æŸ¥è¯¢ç”¨æˆ·
        User user = userMapper.selectOne(
            new LambdaQueryWrapper<User>()
                .eq(User::getUsername, request.getUsername())
        );

        if (user == null) {
            return Result.failure("ç”¨æˆ·ä¸å­˜åœ¨");
        }

        // 2. éªŒè¯å¯†ç ï¼ˆä½¿ç”¨BCryptï¼‰
        if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
            return Result.failure("å¯†ç é”™è¯¯");
        }

        // 3. ç”ŸæˆJWT Token
        String token = jwtUtil.generateToken(
            user.getId(),
            user.getUsername(),
            user.getRoles()
        );

        // 4. æ„å»ºå“åº”
        LoginResponse response = LoginResponse.builder()
            .token(token)
            .userId(user.getId())
            .username(user.getUsername())
            .roles(user.getRoles())
            .build();

        log.info("âœ… ç”¨æˆ·ç™»å½•æˆåŠŸ - UserId: {}, Username: {}", user.getId(), user.getUsername());

        return Result.success(response);
    }

    /**
     * ç”¨æˆ·æ³¨å†Œ
     */
    @PostMapping("/register")
    public Result<Void> register(@RequestBody RegisterRequest request) {
        // 1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
        Long count = userMapper.selectCount(
            new LambdaQueryWrapper<User>()
                .eq(User::getUsername, request.getUsername())
        );

        if (count > 0) {
            return Result.failure("ç”¨æˆ·åå·²å­˜åœ¨");
        }

        // 2. å¯†ç åŠ å¯†ï¼ˆBCryptï¼‰
        String encodedPassword = passwordEncoder.encode(request.getPassword());

        // 3. ä¿å­˜ç”¨æˆ·
        User user = User.builder()
            .username(request.getUsername())
            .password(encodedPassword)
            .roles("USER")  // é»˜è®¤è§’è‰²
            .createdTime(LocalDateTime.now())
            .build();

        userMapper.insert(user);

        log.info("âœ… ç”¨æˆ·æ³¨å†ŒæˆåŠŸ - Username: {}", request.getUsername());

        return Result.success();
    }
}
```

**3. Gatewayè®¤è¯è¿‡æ»¤å™¨ï¼ˆå·²åœ¨2.3ä¸­è¯¦ç»†è¯´æ˜ï¼‰ï¼š**

```java
// gateway-service/src/main/java/com/sewage/gateway/filter/AuthFilter.java
// è§ 2.3 é—®é¢˜çš„è¯¦ç»†ä»£ç 
```

**JWT vs Session å¯¹æ¯”ï¼š**

| ç‰¹æ€§ | JWT | Session |
|-----|-----|---------|
| **å­˜å‚¨ä½ç½®** | å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ | æœåŠ¡ç«¯ï¼ˆå†…å­˜/Redisï¼‰ |
| **çŠ¶æ€** | æ— çŠ¶æ€ï¼ˆstatelessï¼‰ | æœ‰çŠ¶æ€ï¼ˆstatefulï¼‰ |
| **æ‰©å±•æ€§** | å¥½ï¼ˆå¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼ï¼‰ | å·®ï¼ˆéœ€è¦Sessionå…±äº«ï¼‰ |
| **å®‰å…¨æ€§** | ä¿¡æ¯å¯è¢«è§£ç ï¼ˆéœ€åŠ å¯†æ•æ„Ÿä¿¡æ¯ï¼‰ | ä¿¡æ¯å­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼ˆæ›´å®‰å…¨ï¼‰ |
| **æ€§èƒ½** | æ— éœ€æŸ¥è¯¢å­˜å‚¨ | éœ€è¦æŸ¥è¯¢Redis/æ•°æ®åº“ |
| **ç»­æœŸ** | éœ€è¦åˆ·æ–°Tokenæœºåˆ¶ | è‡ªåŠ¨ç»­æœŸï¼ˆè®¿é—®å³ç»­æœŸï¼‰ |

**ä¸ºä»€ä¹ˆé€‰æ‹©JWTï¼Ÿ**

1. **å¾®æœåŠ¡æ¶æ„**ï¼šæœåŠ¡æ— çŠ¶æ€ï¼Œæ˜“äºæ°´å¹³æ‰©å±•
2. **è·¨åŸŸæ”¯æŒ**ï¼šå‰åç«¯åˆ†ç¦»ï¼Œæ”¯æŒCORS
3. **ç§»åŠ¨ç«¯å‹å¥½**ï¼šTokenå¯ä»¥å­˜å‚¨åœ¨ç§»åŠ¨ç«¯ï¼Œæ— éœ€Cookie
4. **å‡å°‘æœåŠ¡å™¨å‹åŠ›**ï¼šä¸éœ€è¦æŸ¥è¯¢Sessionå­˜å‚¨

**JWTçš„å®‰å…¨æ€§è€ƒè™‘ï¼š**

1. **HTTPSä¼ è¾“**ï¼šé˜²æ­¢Tokenè¢«çªƒå–
2. **çŸ­è¿‡æœŸæ—¶é—´**ï¼š24å°æ—¶è¿‡æœŸï¼Œå‡å°‘è¢«ç›—ç”¨é£é™©
3. **åˆ·æ–°Tokenæœºåˆ¶**ï¼šå³å°†è¿‡æœŸæ—¶å¯ä»¥åˆ·æ–°
4. **æ•æ„Ÿä¿¡æ¯åŠ å¯†**ï¼šPayloadä¸å­˜å‚¨å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
5. **ç­¾åéªŒè¯**ï¼šé˜²æ­¢Tokenè¢«ç¯¡æ”¹

---

### â“ 3.2 å¦‚ä½•é˜²æ­¢ JWT Token è¢«ç›—ç”¨ï¼ŸToken åˆ·æ–°æœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

JWT Tokenä¸€æ—¦è¢«ç›—ç”¨ï¼Œæ”»å‡»è€…å¯ä»¥ä¼ªè£…æˆç”¨æˆ·è®¿é—®ç³»ç»Ÿã€‚æˆ‘ä»¬é‡‡ç”¨äº†**å¤šå±‚é˜²æŠ¤ + Tokenåˆ·æ–°æœºåˆ¶**æ¥é™ä½é£é™©ã€‚

**é˜²æŠ¤æªæ–½ï¼š**

**1. HTTPS ä¼ è¾“ï¼ˆä¼ è¾“å±‚å®‰å…¨ï¼‰**
```
âœ… æ­£ç¡®ï¼šhttps://api.example.com/api/monitor/data
   Tokenåœ¨åŠ å¯†é€šé“ä¸­ä¼ è¾“ï¼Œæ— æ³•è¢«ä¸­é—´äººçªƒå–

âŒ é”™è¯¯ï¼šhttp://api.example.com/api/monitor/data
   Tokenæ˜æ–‡ä¼ è¾“ï¼Œå®¹æ˜“è¢«æŠ“åŒ…çªƒå–
```

**2. HttpOnly Cookieï¼ˆå­˜å‚¨å®‰å…¨ï¼‰**

è™½ç„¶æˆ‘ä»¬é¡¹ç›®ç”¨çš„æ˜¯Headerä¼ é€’Tokenï¼Œä½†å¦‚æœç”¨Cookieå­˜å‚¨ï¼Œåº”è¯¥è®¾ç½®HttpOnlyï¼š

```javascript
// é”™è¯¯ï¼šå­˜å‚¨åœ¨LocalStorageï¼ˆå®¹æ˜“è¢«XSSæ”»å‡»çªƒå–ï¼‰
localStorage.setItem('token', token);

// æ­£ç¡®ï¼šå­˜å‚¨åœ¨HttpOnly Cookieï¼ˆJavaScriptæ— æ³•è®¿é—®ï¼‰
document.cookie = `token=${token}; HttpOnly; Secure; SameSite=Strict`;
```

**3. çŸ­è¿‡æœŸæ—¶é—´ï¼ˆæ—¶é—´çª—å£é™åˆ¶ï¼‰**

```java
// JwtUtil.java
private static final long ACCESS_TOKEN_EXPIRATION = 2 * 60 * 60 * 1000;  // 2å°æ—¶
private static final long REFRESH_TOKEN_EXPIRATION = 7 * 24 * 60 * 60 * 1000;  // 7å¤©
```

**4. IPç»‘å®šï¼ˆå¯é€‰ï¼‰**

Tokenä¸­åŒ…å«ç­¾å‘æ—¶çš„IPï¼ŒéªŒè¯æ—¶æ£€æŸ¥IPæ˜¯å¦ä¸€è‡´ï¼š

```java
// ç”ŸæˆTokenæ—¶è®°å½•IP
public String generateToken(Long userId, String username, String ip) {
    return Jwts.builder()
        .setSubject(userId.toString())
        .claim("username", username)
        .claim("ip", ip)  // è®°å½•IP
        .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION))
        .signWith(SignatureAlgorithm.HS256, SECRET)
        .compact();
}

// éªŒè¯Tokenæ—¶æ£€æŸ¥IP
public boolean validateToken(String token, String currentIp) {
    try {
        Claims claims = Jwts.parser()
            .setSigningKey(SECRET)
            .parseClaimsJws(token)
            .getBody();

        String tokenIp = claims.get("ip", String.class);
        if (!tokenIp.equals(currentIp)) {
            log.warn("âš ï¸ Token IPä¸åŒ¹é… - Token IP: {}, å½“å‰IP: {}", tokenIp, currentIp);
            return false;
        }

        return true;
    } catch (Exception e) {
        return false;
    }
}
```

**5. Tokené»‘åå•ï¼ˆRedisï¼‰**

å½“ç”¨æˆ·ä¸»åŠ¨ç™»å‡ºæ—¶ï¼Œå°†TokenåŠ å…¥é»‘åå•ï¼š

```java
// AuthController.java
@PostMapping("/logout")
public Result<Void> logout(@RequestHeader("Authorization") String authHeader) {
    String token = authHeader.substring(7);  // å»æ‰ "Bearer "

    // è·å–Tokenè¿‡æœŸæ—¶é—´
    Date expiration = jwtUtil.getExpirationDate(token);
    long ttl = expiration.getTime() - System.currentTimeMillis();

    // åŠ å…¥é»‘åå•ï¼ˆè¿‡æœŸåè‡ªåŠ¨åˆ é™¤ï¼‰
    redisTemplate.opsForValue().set(
        "token:blacklist:" + token,
        "1",
        ttl,
        TimeUnit.MILLISECONDS
    );

    log.info("âœ… ç”¨æˆ·ç™»å‡ºï¼ŒTokenå·²åŠ å…¥é»‘åå•");
    return Result.success();
}

// AuthFilter.java - éªŒè¯æ—¶æ£€æŸ¥é»‘åå•
public boolean validateToken(String token) {
    // 1. æ£€æŸ¥é»‘åå•
    Boolean isBlacklisted = redisTemplate.hasKey("token:blacklist:" + token);
    if (Boolean.TRUE.equals(isBlacklisted)) {
        log.warn("âš ï¸ Tokenå·²å¤±æ•ˆï¼ˆé»‘åå•ï¼‰");
        return false;
    }

    // 2. éªŒè¯ç­¾åå’Œè¿‡æœŸæ—¶é—´
    return jwtUtil.validateToken(token);
}
```

**Token åˆ·æ–°æœºåˆ¶ï¼ˆåŒTokenæ–¹æ¡ˆï¼‰ï¼š**

**æ ¸å¿ƒæ€æƒ³ï¼š**
- **Access Token**ï¼šçŸ­æœŸæœ‰æ•ˆï¼ˆ2å°æ—¶ï¼‰ï¼Œç”¨äºè®¿é—®API
- **Refresh Token**ï¼šé•¿æœŸæœ‰æ•ˆï¼ˆ7å¤©ï¼‰ï¼Œç”¨äºåˆ·æ–°Access Token

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚                                    â”‚ auth-service â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                 â”‚
     â”‚ 1. ç™»å½•æˆåŠŸ                                     â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ {                                               â”‚
     â”‚   accessToken: "eyJhbGc..." (2å°æ—¶),            â”‚
     â”‚   refreshToken: "eyJzdWI..." (7å¤©)             â”‚
     â”‚ }                                               â”‚
     â”‚                                                 â”‚
     â”‚ 2. ä½¿ç”¨ accessToken è®¿é—®API                     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚ Header: Authorization: Bearer eyJhbGc...        â”‚
     â”‚                                                 â”‚
     â”‚ 3. 2å°æ—¶åï¼ŒaccessToken è¿‡æœŸ                     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚ Header: Authorization: Bearer eyJhbGc...        â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ { code: 401, message: "Token expired" }         â”‚
     â”‚                                                 â”‚
     â”‚ 4. ä½¿ç”¨ refreshToken åˆ·æ–°                       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚ POST /auth/refresh                              â”‚
     â”‚ { refreshToken: "eyJzdWI..." }                  â”‚
     â”‚                                                 â”‚
     â”‚ 5. è¿”å›æ–°çš„ accessToken                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ {                                               â”‚
     â”‚   accessToken: "eyJuZXc..." (æ–°çš„2å°æ—¶),        â”‚
     â”‚   refreshToken: "eyJzdWI..." (å¯é€‰ï¼šåˆ·æ–°)       â”‚
     â”‚ }                                               â”‚
     â”‚                                                 â”‚
     â”‚ 6. ä½¿ç”¨æ–°çš„ accessToken ç»§ç»­è®¿é—®                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                 â”‚
```

**å®ç°ä»£ç ï¼š**

```java
// JwtUtil.java - å¢åŠ Refresh Tokenç”Ÿæˆæ–¹æ³•
public String generateRefreshToken(Long userId) {
    Date now = new Date();
    Date expiryDate = new Date(now.getTime() + REFRESH_TOKEN_EXPIRATION);

    return Jwts.builder()
        .setSubject(userId.toString())
        .claim("type", "refresh")  // æ ‡è®°ä¸ºRefresh Token
        .setIssuedAt(now)
        .setExpiration(expiryDate)
        .signWith(SignatureAlgorithm.HS256, SECRET)
        .compact();
}

// éªŒè¯æ˜¯å¦ä¸ºRefresh Token
public boolean isRefreshToken(String token) {
    Claims claims = Jwts.parser()
        .setSigningKey(SECRET)
        .parseClaimsJws(token)
        .getBody();
    return "refresh".equals(claims.get("type", String.class));
}
```

```java
// AuthController.java - ç™»å½•æ—¶è¿”å›åŒToken
@PostMapping("/login")
public Result<LoginResponse> login(@RequestBody LoginRequest request) {
    // ... éªŒè¯ç”¨æˆ·å¯†ç  ...

    // ç”Ÿæˆ Access Tokenï¼ˆ2å°æ—¶ï¼‰
    String accessToken = jwtUtil.generateToken(user.getId(), user.getUsername(), user.getRoles());

    // ç”Ÿæˆ Refresh Tokenï¼ˆ7å¤©ï¼‰
    String refreshToken = jwtUtil.generateRefreshToken(user.getId());

    // å°† Refresh Token å­˜å‚¨åˆ° Redisï¼ˆç”¨äºæ ¡éªŒå’Œæ’¤é”€ï¼‰
    redisTemplate.opsForValue().set(
        "refresh_token:" + user.getId(),
        refreshToken,
        7,
        TimeUnit.DAYS
    );

    LoginResponse response = LoginResponse.builder()
        .accessToken(accessToken)
        .refreshToken(refreshToken)
        .userId(user.getId())
        .username(user.getUsername())
        .build();

    return Result.success(response);
}

// Tokenåˆ·æ–°æ¥å£
@PostMapping("/refresh")
public Result<RefreshResponse> refresh(@RequestBody RefreshRequest request) {
    String refreshToken = request.getRefreshToken();

    // 1. éªŒè¯ Refresh Token
    if (!jwtUtil.validateToken(refreshToken) || !jwtUtil.isRefreshToken(refreshToken)) {
        return Result.failure("Invalid refresh token");
    }

    // 2. è·å–ç”¨æˆ·ID
    Long userId = jwtUtil.getUserId(refreshToken);

    // 3. æ£€æŸ¥ Redis ä¸­çš„ Refresh Token æ˜¯å¦åŒ¹é…ï¼ˆé˜²æ­¢è¢«ç›—ç”¨ï¼‰
    String storedRefreshToken = redisTemplate.opsForValue().get("refresh_token:" + userId);
    if (!refreshToken.equals(storedRefreshToken)) {
        log.warn("âš ï¸ Refresh Token ä¸åŒ¹é…ï¼Œå¯èƒ½è¢«ç›—ç”¨ - UserId: {}", userId);
        // æ’¤é”€æ‰€æœ‰Token
        redisTemplate.delete("refresh_token:" + userId);
        return Result.failure("Token mismatch, please login again");
    }

    // 4. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    User user = userMapper.selectById(userId);
    if (user == null) {
        return Result.failure("User not found");
    }

    // 5. ç”Ÿæˆæ–°çš„ Access Token
    String newAccessToken = jwtUtil.generateToken(user.getId(), user.getUsername(), user.getRoles());

    // 6. ï¼ˆå¯é€‰ï¼‰åˆ·æ–° Refresh Tokenï¼ˆæ»šåŠ¨åˆ·æ–°ï¼‰
    String newRefreshToken = jwtUtil.generateRefreshToken(user.getId());
    redisTemplate.opsForValue().set(
        "refresh_token:" + user.getId(),
        newRefreshToken,
        7,
        TimeUnit.DAYS
    );

    RefreshResponse response = RefreshResponse.builder()
        .accessToken(newAccessToken)
        .refreshToken(newRefreshToken)
        .build();

    log.info("âœ… Tokenåˆ·æ–°æˆåŠŸ - UserId: {}", userId);

    return Result.success(response);
}
```

**å‰ç«¯å¤„ç†ï¼ˆAxiosæ‹¦æˆªå™¨ï¼‰ï¼š**

```javascript
// å“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(
  response => response,
  async error => {
    const originalRequest = error.config;

    // å¦‚æœè¿”å›401ä¸”æœªé‡è¯•è¿‡
    if (error.response.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;

      try {
        // ä½¿ç”¨ Refresh Token åˆ·æ–°
        const refreshToken = localStorage.getItem('refreshToken');
        const response = await axios.post('/api/auth/refresh', { refreshToken });

        // æ›´æ–° Token
        const { accessToken, refreshToken: newRefreshToken } = response.data.data;
        localStorage.setItem('accessToken', accessToken);
        localStorage.setItem('refreshToken', newRefreshToken);

        // é‡è¯•åŸè¯·æ±‚
        originalRequest.headers['Authorization'] = 'Bearer ' + accessToken;
        return axios(originalRequest);
      } catch (refreshError) {
        // Refresh Token ä¹Ÿè¿‡æœŸäº†ï¼Œè·³è½¬ç™»å½•é¡µ
        localStorage.clear();
        window.location.href = '/login';
        return Promise.reject(refreshError);
      }
    }

    return Promise.reject(error);
  }
);
```

**ä¼˜åŠ¿ï¼š**
1. **ç”¨æˆ·ä½“éªŒå¥½**ï¼š2å°æ—¶å†…æ— éœ€é‡æ–°ç™»å½•ï¼Œ7å¤©å†…æ— æ„Ÿåˆ·æ–°
2. **å®‰å…¨æ€§é«˜**ï¼šAccess TokençŸ­æœŸæœ‰æ•ˆï¼Œè¢«ç›—ç”¨å½±å“å°
3. **å¯æ’¤é”€**ï¼šRefresh Tokenå­˜å‚¨åœ¨Redisï¼Œå¯ä»¥å¼ºåˆ¶æ’¤é”€

**æœ€ä½³å®è·µï¼š**
- Access Tokenï¼š2å°æ—¶ï¼ˆçŸ­æœŸï¼‰
- Refresh Tokenï¼š7å¤©ï¼ˆé•¿æœŸï¼‰
- Refresh Tokenå­˜å‚¨åœ¨Redisï¼Œæ”¯æŒæ’¤é”€
- Refresh Tokenåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼ˆç”¨åå³æ¢ï¼‰

---

### â“ 3.3 æ‹¦æˆªå™¨ã€è¿‡æ»¤å™¨ã€AOP æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä½ ä»¬é¡¹ç›®ç”¨çš„æ˜¯å“ªä¸ªï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

è¿™ä¸‰è€…éƒ½å¯ä»¥å®ç°è¯·æ±‚æ‹¦æˆªï¼Œä½†**æ‰§è¡Œæ—¶æœºã€é€‚ç”¨åœºæ™¯ã€åŠŸèƒ½èŒƒå›´**ä¸åŒã€‚æˆ‘ä»¬é¡¹ç›®ä¸­**ä¸‰è€…éƒ½æœ‰ä½¿ç”¨**ï¼Œå„å¸å…¶èŒã€‚

**å¯¹æ¯”è¡¨æ ¼ï¼š**

| ç‰¹æ€§ | Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ | Interceptorï¼ˆæ‹¦æˆªå™¨ï¼‰ | AOPï¼ˆåˆ‡é¢ï¼‰ |
|-----|-----------------|---------------------|-----------|
| **è§„èŒƒ** | Servletè§„èŒƒ | Springè§„èŒƒ | Springè§„èŒƒ |
| **æ‰§è¡Œæ—¶æœº** | è¯·æ±‚è¿›å…¥Servletå‰ | è¯·æ±‚è¿›å…¥Controllerå‰ | æ–¹æ³•æ‰§è¡Œå‰å |
| **ä½œç”¨èŒƒå›´** | æ‰€æœ‰è¯·æ±‚ï¼ˆåŒ…æ‹¬é™æ€èµ„æºï¼‰ | SpringMVCå¤„ç†çš„è¯·æ±‚ | Beanæ–¹æ³• |
| **ä¾èµ–å®¹å™¨** | Servletå®¹å™¨ | Springå®¹å™¨ | Springå®¹å™¨ |
| **è·å–Spring Bean** | âŒ ä¸æ–¹ä¾¿ï¼ˆéœ€è¦æ‰‹åŠ¨è·å–ï¼‰ | âœ… å¯ä»¥è‡ªåŠ¨æ³¨å…¥ | âœ… å¯ä»¥è‡ªåŠ¨æ³¨å…¥ |
| **æ‰§è¡Œé¡ºåº** | æœ€æ—© | å…¶æ¬¡ | æœ€æ™š |
| **å…¸å‹åº”ç”¨** | ç¼–ç ã€è·¨åŸŸã€è®¤è¯ | æ—¥å¿—ã€é‰´æƒã€å‚æ•°æ ¡éªŒ | äº‹åŠ¡ã€æ—¥å¿—ã€ç¼“å­˜ |

**æ‰§è¡Œé¡ºåºï¼š**

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Filterï¼ˆè¿‡æ»¤å™¨ï¼‰                 â”‚
â”‚    - CharacterEncodingFilter       â”‚  Servletè§„èŒƒ
â”‚    - CorsFilter                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. DispatcherServlet               â”‚  Spring MVCæ ¸å¿ƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Interceptorï¼ˆæ‹¦æˆªå™¨ï¼‰            â”‚
â”‚    - preHandle()                   â”‚  Springè§„èŒƒ
â”‚    - UserInterceptor               â”‚
â”‚    - LogInterceptor                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. AOPï¼ˆåˆ‡é¢ï¼‰                      â”‚
â”‚    - @Before                       â”‚  Spring AOP
â”‚    - æ—¥å¿—åˆ‡é¢ã€äº‹åŠ¡åˆ‡é¢             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Controller æ–¹æ³•æ‰§è¡Œ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. AOPï¼ˆåˆ‡é¢ï¼‰                      â”‚
â”‚    - @After                        â”‚
â”‚    - @AfterReturning               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Interceptorï¼ˆæ‹¦æˆªå™¨ï¼‰            â”‚
â”‚    - postHandle()                  â”‚
â”‚    - afterCompletion()             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Filterï¼ˆè¿‡æ»¤å™¨ï¼‰                 â”‚
â”‚    - å“åº”å¤„ç†                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
è¿”å›ç»™å®¢æˆ·ç«¯
```

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„åº”ç”¨ï¼š**

**1. Gateway ä½¿ç”¨ Filterï¼ˆç½‘å…³å±‚ï¼‰**

```java
// gateway-service/src/main/java/com/sewage/gateway/filter/AuthFilter.java
@Component
public class AuthFilter implements GlobalFilter, Ordered {
    // Gatewayçš„Filterï¼Œç”¨äºç»Ÿä¸€è®¤è¯
    // åœ¨è¯·æ±‚è¿›å…¥å¾®æœåŠ¡ä¹‹å‰éªŒè¯JWT Token
}
```

**åº”ç”¨åœºæ™¯ï¼š**
- âœ… JWT TokenéªŒè¯
- âœ… è¯·æ±‚æ—¥å¿—è®°å½•
- âœ… é™æµ
- âœ… è·¨åŸŸå¤„ç†

**ä¼˜åŠ¿ï¼š**
- ç»Ÿä¸€å¤„ç†æ‰€æœ‰å¾®æœåŠ¡çš„è®¤è¯
- ä¸‹æ¸¸æœåŠ¡æ— éœ€å…³å¿ƒè®¤è¯é€»è¾‘

---

**2. ä¸šåŠ¡æœåŠ¡ä½¿ç”¨ Interceptorï¼ˆæ‹¦æˆªå™¨å±‚ï¼‰**

```java
// monitor-service/src/main/java/com/sewage/monitor/interceptor/UserInterceptor.java
@Component
@Slf4j
public class UserInterceptor implements HandlerInterceptor {

    /**
     * Controlleræ‰§è¡Œå‰
     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 1. ä»Gatewayä¼ é€’çš„è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯
        String userIdHeader = request.getHeader("X-User-Id");
        String username = request.getHeader("X-Username");
        String roles = request.getHeader("X-User-Roles");

        // 2. å­˜å‚¨åˆ°ThreadLocal
        if (userIdHeader != null) {
            Long userId = Long.parseLong(userIdHeader);
            UserContext.setUserId(userId);
            UserContext.setUsername(username);
            UserContext.setRoles(roles);

            log.debug("ğŸ‘¤ ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½® - UserId: {}, Username: {}", userId, username);
        }

        // 3. è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´ï¼ˆç”¨äºè®¡ç®—æ¥å£è€—æ—¶ï¼‰
        request.setAttribute("startTime", System.currentTimeMillis());

        return true;  // è¿”å›trueç»§ç»­æ‰§è¡Œï¼Œfalseä¸­æ–­è¯·æ±‚
    }

    /**
     * Controlleræ‰§è¡Œåï¼Œè§†å›¾æ¸²æŸ“å‰
     */
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response,
                          Object handler, ModelAndView modelAndView) {
        // å¯ä»¥ä¿®æ”¹ModelAndViewï¼ˆæˆ‘ä»¬é¡¹ç›®æ˜¯å‰åç«¯åˆ†ç¦»ï¼Œä¸éœ€è¦ï¼‰
    }

    /**
     * è¯·æ±‚å®Œæˆåï¼ˆè§†å›¾æ¸²æŸ“åï¼‰
     */
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response,
                                Object handler, Exception ex) {
        // 1. è®¡ç®—æ¥å£è€—æ—¶
        Long startTime = (Long) request.getAttribute("startTime");
        if (startTime != null) {
            long duration = System.currentTimeMillis() - startTime;
            if (duration > 1000) {  // è¶…è¿‡1ç§’è®°å½•è­¦å‘Š
                log.warn("âš ï¸ æ¥å£æ‰§è¡Œç¼“æ…¢ - URI: {}, è€—æ—¶: {}ms", request.getRequestURI(), duration);
            } else {
                log.debug("âœ… æ¥å£æ‰§è¡Œå®Œæˆ - URI: {}, è€—æ—¶: {}ms", request.getRequestURI(), duration);
            }
        }

        // 2. æ¸…ç†ThreadLocalï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
        UserContext.clear();
    }
}

// é…ç½®æ‹¦æˆªå™¨
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Autowired
    private UserInterceptor userInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(userInterceptor)
            .addPathPatterns("/**")  // æ‹¦æˆªæ‰€æœ‰è¯·æ±‚
            .excludePathPatterns(    // æ’é™¤è·¯å¾„
                "/error",
                "/ws/**",  // WebSocket
                "/actuator/**"  // ç›‘æ§ç«¯ç‚¹
            );
    }
}
```

**åº”ç”¨åœºæ™¯ï¼š**
- âœ… ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®ï¼ˆUserContextï¼‰
- âœ… æ¥å£è€—æ—¶ç»Ÿè®¡
- âœ… è¯·æ±‚æ—¥å¿—è®°å½•
- âœ… æƒé™æ ¡éªŒï¼ˆæ£€æŸ¥ç”¨æˆ·è§’è‰²ï¼‰

**ä¼˜åŠ¿ï¼š**
- å¯ä»¥è®¿é—®Spring Bean
- å¯ä»¥è·å–Controlleræ–¹æ³•ä¿¡æ¯ï¼ˆHandlerMethodï¼‰
- å¯ä»¥ä¸­æ–­è¯·æ±‚ï¼ˆè¿”å›falseï¼‰

---

**3. AOP åˆ‡é¢ï¼ˆæ–¹æ³•å±‚ï¼‰**

```java
// monitor-service/src/main/java/com/sewage/monitor/aspect/LogAspect.java
@Aspect
@Component
@Slf4j
public class LogAspect {

    /**
     * å®šä¹‰åˆ‡ç‚¹ï¼šæ‰€æœ‰Controlleræ–¹æ³•
     */
    @Pointcut("execution(* com.sewage.monitor.controller..*.*(..))")
    public void controllerPointcut() {}

    /**
     * ç¯ç»•é€šçŸ¥ï¼šè®°å½•æ–¹æ³•æ‰§è¡Œæ—¥å¿—
     */
    @Around("controllerPointcut()")
    public Object logAround(ProceedingJoinPoint joinPoint) throws Throwable {
        // 1. è·å–æ–¹æ³•ä¿¡æ¯
        String className = joinPoint.getTarget().getClass().getSimpleName();
        String methodName = joinPoint.getSignature().getName();
        Object[] args = joinPoint.getArgs();

        // 2. è®°å½•è¯·æ±‚å‚æ•°
        log.info("ğŸ”µ [{}#{}] å¼€å§‹æ‰§è¡Œ - å‚æ•°: {}", className, methodName, Arrays.toString(args));

        long startTime = System.currentTimeMillis();
        Object result = null;

        try {
            // 3. æ‰§è¡Œç›®æ ‡æ–¹æ³•
            result = joinPoint.proceed();

            // 4. è®°å½•è¿”å›ç»“æœ
            long duration = System.currentTimeMillis() - startTime;
            log.info("ğŸŸ¢ [{}#{}] æ‰§è¡ŒæˆåŠŸ - è€—æ—¶: {}ms, ç»“æœ: {}",
                className, methodName, duration, result);

            return result;

        } catch (Exception e) {
            // 5. è®°å½•å¼‚å¸¸
            long duration = System.currentTimeMillis() - startTime;
            log.error("ğŸ”´ [{}#{}] æ‰§è¡Œå¤±è´¥ - è€—æ—¶: {}ms, å¼‚å¸¸: {}",
                className, methodName, duration, e.getMessage(), e);
            throw e;
        }
    }

    /**
     * è‡ªå®šä¹‰æ³¨è§£åˆ‡ç‚¹ï¼šç¼“å­˜æ–¹æ³•
     */
    @Around("@annotation(cacheable)")
    public Object cacheAround(ProceedingJoinPoint joinPoint, Cacheable cacheable) throws Throwable {
        // è·å–ç¼“å­˜Key
        String cacheKey = generateCacheKey(joinPoint, cacheable);

        // æŸ¥è¯¢ç¼“å­˜
        Object cachedResult = redisTemplate.opsForValue().get(cacheKey);
        if (cachedResult != null) {
            log.info("ğŸ¯ ç¼“å­˜å‘½ä¸­ - Key: {}", cacheKey);
            return cachedResult;
        }

        // æ‰§è¡Œæ–¹æ³•
        Object result = joinPoint.proceed();

        // å†™å…¥ç¼“å­˜
        redisTemplate.opsForValue().set(cacheKey, result, cacheable.ttl(), TimeUnit.SECONDS);
        log.info("ğŸ’¾ ç¼“å­˜å†™å…¥ - Key: {}", cacheKey);

        return result;
    }
}

// è‡ªå®šä¹‰ç¼“å­˜æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Cacheable {
    String prefix();  // ç¼“å­˜Keyå‰ç¼€
    int ttl() default 60;  // è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
}

// ä½¿ç”¨ç¤ºä¾‹
@RestController
public class MonitorController {

    @GetMapping("/data/latest/{labId}")
    @Cacheable(prefix = "lab:latest", ttl = 30)  // ç¼“å­˜30ç§’
    public Result<LabEnvironmentData> getLatestData(@PathVariable Long labId) {
        // æ–¹æ³•æ‰§è¡Œå‰ä¼šå…ˆæŸ¥ç¼“å­˜
        // å¦‚æœç¼“å­˜å­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œæ–¹æ³•
        return Result.success(labEnvironmentDataService.getLatestData(labId));
    }
}
```

**åº”ç”¨åœºæ™¯ï¼š**
- âœ… æ–¹æ³•æ‰§è¡Œæ—¥å¿—
- âœ… è‡ªå®šä¹‰ç¼“å­˜æ³¨è§£
- âœ… äº‹åŠ¡ç®¡ç†ï¼ˆ@Transactionalï¼‰
- âœ… æƒé™æ ¡éªŒï¼ˆ@PreAuthorizeï¼‰
- âœ… æ€§èƒ½ç›‘æ§

**ä¼˜åŠ¿ï¼š**
- ä¸ä¾µå…¥ä¸šåŠ¡ä»£ç ï¼ˆè§£è€¦ï¼‰
- å¯ä»¥ç²¾ç¡®åŒ¹é…æ–¹æ³•ï¼ˆè¡¨è¾¾å¼ï¼‰
- å¯ä»¥è·å–æ–¹æ³•å‚æ•°ã€è¿”å›å€¼ã€å¼‚å¸¸

---

**å¦‚ä½•é€‰æ‹©ï¼Ÿ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éœ€æ±‚                                  æ¨èæ–¹æ¡ˆ        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç»Ÿä¸€è®¤è¯ï¼ˆæ‰€æœ‰æœåŠ¡ï¼‰                  Gateway Filter  â”‚
â”‚ ç¼–ç ã€è·¨åŸŸã€å…¨å±€å¼‚å¸¸                  Servlet Filter  â”‚
â”‚ ç”¨æˆ·ä¸Šä¸‹æ–‡ã€æ—¥å¿—ã€æƒé™æ ¡éªŒ             Interceptor     â”‚
â”‚ æ–¹æ³•çº§æ—¥å¿—ã€ç¼“å­˜ã€äº‹åŠ¡ã€æ€§èƒ½ç›‘æ§        AOP            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æˆ‘ä»¬é¡¹ç›®çš„å®Œæ•´æ‹¦æˆªé“¾ï¼š**

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
Gateway Filter (AuthFilter)
    â”œâ”€ JWTéªŒè¯
    â””â”€ æ·»åŠ X-User-Idåˆ°è¯·æ±‚å¤´
    â†“
Monitor Service
    â†“
Servlet Filter (CharacterEncodingFilter)
    â””â”€ è®¾ç½®UTF-8ç¼–ç 
    â†“
Interceptor (UserInterceptor)
    â”œâ”€ ä»è¯·æ±‚å¤´æå–ç”¨æˆ·ä¿¡æ¯
    â”œâ”€ å­˜å‚¨åˆ°ThreadLocal
    â””â”€ è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
    â†“
AOP (LogAspect)
    â”œâ”€ è®°å½•æ–¹æ³•å‚æ•°
    â”œâ”€ æ£€æŸ¥ç¼“å­˜ï¼ˆå¦‚æœæœ‰@Cacheableï¼‰
    â””â”€ æ‰§è¡Œæ–¹æ³•
    â†“
Controller æ–¹æ³•
    â†“
AOP (LogAspect)
    â””â”€ è®°å½•è¿”å›ç»“æœ
    â†“
Interceptor (UserInterceptor)
    â”œâ”€ è®°å½•æ¥å£è€—æ—¶
    â””â”€ æ¸…ç†ThreadLocal
    â†“
è¿”å›ç»™å®¢æˆ·ç«¯
```

---

### â“ 3.4 ThreadLocal æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿä½¿ç”¨æ—¶è¦æ³¨æ„ä»€ä¹ˆé—®é¢˜ï¼Ÿ

**ğŸ¯ å›ç­”æ¨¡æ¿ï¼š**

ThreadLocalæ˜¯Javaæä¾›çš„**çº¿ç¨‹æœ¬åœ°å˜é‡**ï¼Œå¯ä»¥è®©æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œäº’ä¸å¹²æ‰°ã€‚æˆ‘ä»¬é¡¹ç›®ä¸­ç”¨å®ƒå­˜å‚¨**ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯**ã€‚

**ThreadLocal åŸç†ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Threadï¼ˆçº¿ç¨‹ï¼‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        ThreadLocalMapï¼ˆçº¿ç¨‹å†…éƒ¨çš„Mapï¼‰         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚ Key: ThreadLocal â”‚ Value: ç”¨æˆ·ä¿¡æ¯     â”‚     â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚  â”‚
â”‚  â”‚  â”‚ userIdThreadLocalâ”‚ 123               â”‚     â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚  â”‚
â”‚  â”‚  â”‚ usernameThreadLocalâ”‚ "admin"        â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ThreadLocalMapï¼Œå­˜å‚¨è‡ªå·±çš„å˜é‡å‰¯æœ¬
```

**åº•å±‚å®ç°ï¼š**

```java
// Threadç±»ä¸­æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡
class Thread {
    ThreadLocal.ThreadLocalMap threadLocals;  // æ¯ä¸ªçº¿ç¨‹è‡ªå·±çš„Map
}

// ThreadLocalçš„get()æ–¹æ³•
public T get() {
    Thread t = Thread.currentThread();  // 1. è·å–å½“å‰çº¿ç¨‹
    ThreadLocalMap map = t.threadLocals;  // 2. è·å–çº¿ç¨‹çš„Map
    if (map != null) {
        ThreadLocalMap.Entry e = map.getEntry(this);  // 3. ç”¨thisï¼ˆThreadLocalå¯¹è±¡ï¼‰ä½œä¸ºKey
        if (e != null) {
            return (T) e.value;  // 4. è¿”å›Value
        }
    }
    return setInitialValue();  // 5. æ²¡æœ‰å€¼åˆ™åˆå§‹åŒ–
}

// ThreadLocalçš„set()æ–¹æ³•
public void set(T value) {
    Thread t = Thread.currentThread();
    ThreadLocalMap map = t.threadLocals;
    if (map != null) {
        map.set(this, value);  // ç”¨thisä½œä¸ºKeyï¼Œvalueä½œä¸ºValue
    } else {
        createMap(t, value);  // åˆ›å»ºMap
    }
}
```

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„åº”ç”¨ï¼š**

```java
// common/src/main/java/com/sewage/common/context/UserContext.java
public class UserContext {

    // æ¯ä¸ªThreadLocalå¯¹è±¡å¯¹åº”ä¸€ä¸ªå˜é‡
    private static final ThreadLocal<Long> USER_ID = new ThreadLocal<>();
    private static final ThreadLocal<String> USERNAME = new ThreadLocal<>();
    private static final ThreadLocal<String> ROLES = new ThreadLocal<>();

    /**
     * è®¾ç½®ç”¨æˆ·ID
     */
    public static void setUserId(Long userId) {
        USER_ID.set(userId);
    }

    /**
     * è·å–ç”¨æˆ·ID
     */
    public static Long getUserId() {
        return USER_ID.get();
    }

    /**
     * è®¾ç½®ç”¨æˆ·å
     */
    public static void setUsername(String username) {
        USERNAME.set(username);
    }

    /**
     * è·å–ç”¨æˆ·å
     */
    public static String getUsername() {
        return USERNAME.get();
    }

    /**
     * è®¾ç½®è§’è‰²
     */
    public static void setRoles(String roles) {
        ROLES.set(roles);
    }

    /**
     * è·å–è§’è‰²
     */
    public static String getRoles() {
        return ROLES.get();
    }

    /**
     * æ¸…ç†ThreadLocalï¼ˆéå¸¸é‡è¦ï¼ï¼‰
     */
    public static void clear() {
        USER_ID.remove();
        USERNAME.remove();
        ROLES.remove();
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```java
// 1. æ‹¦æˆªå™¨ä¸­è®¾ç½®ç”¨æˆ·ä¿¡æ¯
@Component
public class UserInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        String userIdHeader = request.getHeader("X-User-Id");
        if (userIdHeader != null) {
            UserContext.setUserId(Long.parseLong(userIdHeader));
            UserContext.setUsername(request.getHeader("X-Username"));
            UserContext.setRoles(request.getHeader("X-User-Roles"));
        }
        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response,
                                Object handler, Exception ex) {
        // è¯·æ±‚ç»“æŸåæ¸…ç†ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
        UserContext.clear();
    }
}

// 2. Controllerä¸­ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯
@RestController
public class MonitorController {
    @GetMapping("/data/latest/{labId}")
    public Result<LabEnvironmentData> getLatestData(@PathVariable Long labId) {
        // ä»ThreadLocalè·å–å½“å‰ç”¨æˆ·IDï¼ˆä¸éœ€è¦é€šè¿‡å‚æ•°ä¼ é€’ï¼‰
        Long userId = UserContext.getUserId();
        String username = UserContext.getUsername();

        log.info("ç”¨æˆ·{}({}) æŸ¥è¯¢å®éªŒå®¤{}çš„æ•°æ®", username, userId, labId);

        // ä¸šåŠ¡é€»è¾‘...
        return Result.success(data);
    }
}

// 3. Serviceå±‚ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨
@Service
public class MonitorService {
    public void saveData(LabEnvironmentData data) {
        // è‡ªåŠ¨è®°å½•æ“ä½œäºº
        Long userId = UserContext.getUserId();
        data.setCreatedBy(userId);

        // ä¿å­˜...
    }
}
```

**ThreadLocal ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š**

**1. å¿…é¡»æ¸…ç†ï¼ˆæœ€é‡è¦ï¼ï¼‰**

**é—®é¢˜ï¼š**
```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ¸…ç†ThreadLocal
@Override
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
    UserContext.setUserId(123L);
    return true;
}
// è¯·æ±‚ç»“æŸåï¼Œçº¿ç¨‹å›åˆ°çº¿ç¨‹æ± ï¼ŒThreadLocalçš„å€¼è¿˜åœ¨ï¼
// ä¸‹ä¸€ä¸ªè¯·æ±‚å¤ç”¨è¿™ä¸ªçº¿ç¨‹æ—¶ï¼Œä¼šè¯»åˆ°ä¸Šä¸€ä¸ªè¯·æ±‚çš„ç”¨æˆ·ä¿¡æ¯ï¼
```

**æ­£ç¡®åšæ³•ï¼š**
```java
// âœ… æ­£ç¡®ï¼šåœ¨afterCompletionä¸­æ¸…ç†
@Override
public void afterCompletion(HttpServletRequest request, HttpServletResponse response,
                            Object handler, Exception ex) {
    UserContext.clear();  // å¿…é¡»æ¸…ç†ï¼
}
```

**ä¸ºä»€ä¹ˆå¿…é¡»æ¸…ç†ï¼Ÿ**
- Tomcatä½¿ç”¨**çº¿ç¨‹æ± **å¤„ç†è¯·æ±‚
- è¯·æ±‚ç»“æŸåï¼Œçº¿ç¨‹ä¸ä¼šé”€æ¯ï¼Œè€Œæ˜¯å›åˆ°çº¿ç¨‹æ± 
- å¦‚æœä¸æ¸…ç†ThreadLocalï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚å¤ç”¨è¿™ä¸ªçº¿ç¨‹æ—¶ï¼Œä¼šè¯»åˆ°ä¸Šä¸€ä¸ªè¯·æ±‚çš„æ•°æ®

**çœŸå®æ¡ˆä¾‹ï¼š**
> æˆ‘ä»¬é¡¹ç›®æ—©æœŸæ²¡æœ‰æ¸…ç†ThreadLocalï¼Œå¯¼è‡´ç”¨æˆ·AæŸ¥è¯¢æ•°æ®æ—¶ï¼Œå¶å°”ä¼šå‡ºç°ç”¨æˆ·Bçš„æƒé™ã€‚æ’æŸ¥å‘ç°æ˜¯çº¿ç¨‹å¤ç”¨å¯¼è‡´çš„ThreadLocalæ•°æ®æ±¡æŸ“ã€‚

---

**2. å†…å­˜æ³„æ¼é£é™©**

**åŸç†ï¼š**
```
Threadï¼ˆé•¿æœŸå­˜æ´»ï¼‰
    â†“
ThreadLocalMapï¼ˆå¼ºå¼•ç”¨ï¼‰
    â†“
Entryï¼ˆå¼±å¼•ç”¨ Keyï¼‰
    â”œâ”€ Key: ThreadLocalï¼ˆå¼±å¼•ç”¨ï¼‰â†’ å¯èƒ½è¢«GCå›æ”¶
    â””â”€ Value: ç”¨æˆ·ä¿¡æ¯ï¼ˆå¼ºå¼•ç”¨ï¼‰â†’ ä¸ä¼šè¢«GCå›æ”¶

å¦‚æœThreadLocalè¢«GCå›æ”¶ï¼Œä½†Valueæ²¡æœ‰è¢«æ¸…ç†ï¼Œå°±ä¼šå†…å­˜æ³„æ¼ï¼
```

**å¼±å¼•ç”¨çš„é—®é¢˜ï¼š**
- ThreadLocalMapçš„Entryçš„Keyæ˜¯**å¼±å¼•ç”¨**ï¼ˆWeakReferenceï¼‰
- å½“ThreadLocalæ²¡æœ‰å¼ºå¼•ç”¨æ—¶ï¼ŒGCä¼šå›æ”¶å®ƒ
- ä½†Entryçš„Valueæ˜¯**å¼ºå¼•ç”¨**ï¼Œä¸ä¼šè¢«GCå›æ”¶
- å¯¼è‡´ThreadLocalMapä¸­å‡ºç°Key=nullï¼ŒValue!=nullçš„Entry
- è¿™äº›Entryå ç”¨å†…å­˜ï¼Œä½†æ— æ³•è®¿é—®ï¼ˆå†…å­˜æ³„æ¼ï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**
```java
// 1. åŠæ—¶è°ƒç”¨remove()
UserContext.clear();  // å†…éƒ¨è°ƒç”¨ThreadLocal.remove()

// 2. ä½¿ç”¨finallyç¡®ä¿æ¸…ç†
try {
    UserContext.setUserId(userId);
    // ä¸šåŠ¡é€»è¾‘
} finally {
    UserContext.clear();
}
```

---

**3. çˆ¶å­çº¿ç¨‹ä¼ é€’é—®é¢˜**

**é—®é¢˜ï¼š**
```java
// ä¸»çº¿ç¨‹è®¾ç½®ç”¨æˆ·ä¿¡æ¯
UserContext.setUserId(123L);

// åˆ›å»ºå­çº¿ç¨‹
new Thread(() -> {
    Long userId = UserContext.getUserId();  // è¿”å›nullï¼
    // å­çº¿ç¨‹æ— æ³•è·å–çˆ¶çº¿ç¨‹çš„ThreadLocalå€¼
}).start();
```

**è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ InheritableThreadLocal**
```java
// æ”¹ä¸º InheritableThreadLocal
private static final InheritableThreadLocal<Long> USER_ID = new InheritableThreadLocal<>();

// ç°åœ¨å­çº¿ç¨‹å¯ä»¥ç»§æ‰¿çˆ¶çº¿ç¨‹çš„å€¼
UserContext.setUserId(123L);
new Thread(() -> {
    Long userId = UserContext.getUserId();  // è¿”å›123
}).start();
```

**æ³¨æ„ï¼š**
- InheritableThreadLocalåœ¨**çº¿ç¨‹åˆ›å»ºæ—¶**å¤åˆ¶çˆ¶çº¿ç¨‹çš„å€¼
- å¦‚æœä½¿ç”¨**çº¿ç¨‹æ± **ï¼Œå­çº¿ç¨‹åˆ›å»ºæ—¶æœºæ—©äºä»»åŠ¡æäº¤ï¼Œæ— æ³•ç»§æ‰¿å€¼
- æ¨èä½¿ç”¨é˜¿é‡Œçš„**TransmittableThreadLocal**ï¼ˆTTLï¼‰è§£å†³çº¿ç¨‹æ± åœºæ™¯

---

**4. æ€§èƒ½é—®é¢˜ï¼ˆå¤§å¯¹è±¡ï¼‰**

**é—®é¢˜ï¼š**
```java
// âŒ ä¸æ¨èï¼šå­˜å‚¨å¤§å¯¹è±¡
private static final ThreadLocal<List<LabEnvironmentData>> LARGE_DATA = new ThreadLocal<>();

public void process() {
    List<LabEnvironmentData> data = new ArrayList<>(10000);  // å¤§å¯¹è±¡
    LARGE_DATA.set(data);
    // ...
}
// å¦‚æœå¿˜è®°æ¸…ç†ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæŒæœ‰10000æ¡æ•°æ®çš„å¼•ç”¨ï¼
```

**å»ºè®®ï¼š**
- ThreadLocalåªå­˜å‚¨**ç®€å•å¯¹è±¡**ï¼ˆLongã€Stringç­‰ï¼‰
- é¿å…å­˜å‚¨**é›†åˆã€å¤§å¯¹è±¡**
- åŠæ—¶æ¸…ç†

---

**ThreadLocal vs å‚æ•°ä¼ é€’ å¯¹æ¯”ï¼š**

**æ–¹æ¡ˆ1: å‚æ•°ä¼ é€’**
```java
public void methodA(Long userId) {
    methodB(userId);
}

public void methodB(Long userId) {
    methodC(userId);
}

public void methodC(Long userId) {
    // ä½¿ç”¨userId
}
```

**ç¼ºç‚¹ï¼š**
- æ¯ä¸ªæ–¹æ³•éƒ½éœ€è¦ä¼ é€’userIdå‚æ•°
- æ–¹æ³•ç­¾åè‡ƒè‚¿
- ä¿®æ”¹å›°éš¾ï¼ˆæ–°å¢å‚æ•°éœ€è¦æ”¹æ‰€æœ‰æ–¹æ³•ï¼‰

**æ–¹æ¡ˆ2: ThreadLocal**
```java
// åœ¨æ‹¦æˆªå™¨ä¸­è®¾ç½®
UserContext.setUserId(userId);

public void methodA() {
    methodB();
}

public void methodB() {
    methodC();
}

public void methodC() {
    Long userId = UserContext.getUserId();  // ç›´æ¥è·å–
}
```

**ä¼˜ç‚¹ï¼š**
- æ–¹æ³•ç­¾åç®€æ´
- æ— éœ€å±‚å±‚ä¼ é€’
- æ˜“äºç»´æŠ¤

**ç»“è®ºï¼š**
- å¯¹äº**æ¨ªåˆ‡å…³æ³¨ç‚¹**ï¼ˆç”¨æˆ·ä¿¡æ¯ã€è¯·æ±‚IDã€äº‹åŠ¡ä¸Šä¸‹æ–‡ç­‰ï¼‰ï¼Œä½¿ç”¨ThreadLocalæ›´ä¼˜é›…
- å¯¹äº**ä¸šåŠ¡å‚æ•°**ï¼Œä½¿ç”¨å‚æ•°ä¼ é€’æ›´æ¸…æ™°

---

**é¢è¯•åŠ åˆ†é¡¹ï¼š**

**ThreadLocalçš„å…¸å‹åº”ç”¨åœºæ™¯ï¼š**
1. **ç”¨æˆ·ä¸Šä¸‹æ–‡**ï¼šå­˜å‚¨å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆæˆ‘ä»¬é¡¹ç›®ï¼‰
2. **æ•°æ®åº“è¿æ¥**ï¼šSpringçš„äº‹åŠ¡ç®¡ç†ï¼ˆæ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼‰
3. **æ—¥æœŸæ ¼å¼åŒ–**ï¼šSimpleDateFormatçº¿ç¨‹ä¸å®‰å…¨ï¼Œç”¨ThreadLocalåŒ…è£…
4. **è¯·æ±‚è¿½è¸ª**ï¼šå­˜å‚¨traceIdï¼Œç”¨äºæ—¥å¿—è¿½è¸ª

**Springä¸­çš„ThreadLocalï¼š**
- `RequestContextHolder`ï¼šå­˜å‚¨å½“å‰è¯·æ±‚çš„ServletRequest
- `TransactionSynchronizationManager`ï¼šå­˜å‚¨å½“å‰äº‹åŠ¡çš„æ•°æ®åº“è¿æ¥
- `LocaleContextHolder`ï¼šå­˜å‚¨å½“å‰è¯·æ±‚çš„Locale

---

## ğŸ¯ æ€»ç»“

**ç¬¬ä¸€éƒ¨åˆ†æ ¸å¿ƒè¦ç‚¹ï¼š**

1. **Nacoså¿ƒè·³æœºåˆ¶**ï¼š5ç§’å¿ƒè·³ï¼Œ15ç§’ä¸å¥åº·ï¼Œ30ç§’å‰”é™¤
2. **Gatewayå·¥ä½œåŸç†**ï¼šRoute + Predicate + Filter
3. **JWTè®¤è¯æµç¨‹**ï¼šç™»å½•ç”ŸæˆToken â†’ GatewayéªŒè¯ â†’ ä¼ é€’ç”¨æˆ·ä¿¡æ¯
4. **ThreadLocalä½¿ç”¨**ï¼šå­˜å‚¨ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œå¿…é¡»åŠæ—¶æ¸…ç†

**é¢è¯•å›ç­”æŠ€å·§ï¼š**
- å…ˆè¯´åŸç†ï¼Œå†è¯´å®è·µ
- ç»“åˆé¡¹ç›®å…·ä½“åœºæ™¯
- å¯¹æ¯”å…¶ä»–æ–¹æ¡ˆä¼˜åŠ£
- è¯´æ˜é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

---

**ğŸ“Œ ä¸‹ä¸€éƒ¨åˆ†é¢„å‘Šï¼š**

**ç¬¬äºŒéƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–ä¸WebSocketå®æ—¶é€šä¿¡**
- æ€§èƒ½ä¼˜åŒ–åœºæ™¯é¢˜ï¼ˆä½ é‡åˆ°çš„é—®é¢˜ï¼‰
- WebSocketå®ç°åŸç†ï¼ˆä½ é‡åˆ°çš„é—®é¢˜ï¼‰
- Redisç¼“å­˜ç­–ç•¥

è¯·å‘Šè¯‰æˆ‘å‡†å¤‡å¥½æŸ¥çœ‹ç¬¬äºŒéƒ¨åˆ†äº†å—ï¼Ÿæˆ‘ä¼šç»§ç»­ä¸ºä½ å‡†å¤‡è¯¦ç»†çš„é—®ç­”ã€‚
